<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartKago - スマート家計管理アプリ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Google Maps API は使用しない -->
    <script>
        // Tailwindの警告を抑制
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            theme: {
                extend: {}
            }
        };
        
        // Google Maps APIは使用しない
    </script>メニュー一覧
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors duration-200; }
        .card { @apply bg-white rounded-xl shadow-sm border border-gray-200 p-6; }
        .input-field { @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200; }
        .bottom-nav { 
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* 深いダークブルーのグラデーション */
            border-top: 1px solid #334155;
            box-shadow: 0 -4px 12px -2px rgba(0, 0, 0, 0.4), 0 -2px 4px -1px rgba(0, 0, 0, 0.2);
            z-index: 9999 !important;
            width: 100% !important;
        }
        
        /* ダークモード用スタイル */
        .dark body { @apply bg-gray-900 text-gray-100; }
        .dark .card { @apply bg-gray-800 border-gray-700; }
        .dark .input-field { @apply bg-gray-700 border-gray-600 text-gray-100; }
        .dark .bottom-nav { 
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* 深いダークブルーのグラデーション（ダークモードでも同じ） */
            border-top: 1px solid #334155;
            box-shadow: 0 -4px 12px -2px rgba(0, 0, 0, 0.4), 0 -2px 4px -1px rgba(0, 0, 0, 0.2);
            z-index: 9999 !important;
            width: 100% !important;
        }
        .dark h1, .dark h2, .dark h3, .dark h4, .dark h5, .dark h6 { @apply text-gray-100; }
        .dark .text-gray-900 { @apply text-gray-100; }
        .dark .text-gray-700 { @apply text-gray-300; }
        .dark .text-gray-600 { @apply text-gray-400; }
        .dark .bg-gray-50 { @apply bg-gray-700; }
        .dark .bg-gray-100 { @apply bg-gray-600; }
        .dark .border-gray-200 { @apply border-gray-700; }
        .dark .border-gray-300 { @apply border-gray-600; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        // コンソールの警告を抑制
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0] && typeof args[0] === 'string') {
                if (args[0].includes('cdn.tailwindcss.com should not be used in production') ||
                    args[0].includes('You are using the in-browser Babel transformer') ||
                    args[0].includes('ReactDOM.render is no longer supported')) {
                    return; // これらの警告を抑制
                }
            }
            originalWarn.apply(console, args);
        };
        
        // Babelの警告を抑制
        window.Babel = window.Babel || {};
        window.Babel.transform = window.Babel.transform || function(code, options) {
            return { code: code };
        };
        
        // エラーハンドリング
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            const errorMessage = e.error && e.error.message ? e.error.message : '不明なエラーが発生しました';
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; text-align: center; color: red;">
                    <h2>エラーが発生しました</h2>
                    <p>${errorMessage}</p>
                    <p>ページを再読み込みしてください。</p>
                </div>
            `;
        });

        // Reactの読み込み確認
        if (typeof React === 'undefined') {
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; text-align: center; color: red;">
                    <h2>Reactが読み込まれていません</h2>
                    <p>インターネット接続を確認してください。</p>
                </div>
            `;
        }

        const { useState, useEffect, useCallback, useRef } = React;
        const { createElement: h } = React;
        const { createRoot } = ReactDOM;

        // アイコンコンポーネント
        const Menu = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 6h16M4 12h16M4 18h16' }));
        const Bell = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 17h5l-5 5v-5zM4.828 7l2.586 2.586a2 2 0 002.828 0L12.828 7H4.828z' }));
        const Home = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' }));
        const Receipt = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' }));
        const Calculator = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z' }));
        const ChefHat = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z' }));
        const Settings = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' }), 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' }));
        const Plus = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' }));
        const Camera = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z' }), 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 13a3 3 0 11-6 0 3 3 0 016 0z' }));
        
        const Store = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' }));
        
        const History = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' }));
        
        const Compare = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z' }));
        
        const Globe = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9' }));
        const TrendingUp = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' }));
        const LogOut = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1' }));
        const ChevronLeft = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 19l-7-7 7-7' }));
        const ChevronRight = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 5l7 7-7 7' }));
        const MapPin = (props) => h('svg', { ...props, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor' }, 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z' }), 
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 11a3 3 0 11-6 0 3 3 0 016 0z' }));

        // ヘッダーコンポーネント
        const Header = ({ onMenuClick, user, onLogout }) => {
            return h('header', { className: 'fixed top-0 left-0 right-0 bg-white shadow-sm border-b border-gray-200 z-50' },
                h('div', { className: 'flex items-center justify-between px-4 py-3' },
                    h('button', { onClick: onMenuClick, className: 'p-2 rounded-lg hover:bg-gray-100 transition-colors' },
                        h(Menu, { className: 'w-6 h-6 text-gray-700' })
                    ),
                    h('div', { className: 'flex-1 text-center' },
                        h('h1', { className: 'text-lg font-semibold text-gray-900' }, 'SmartKago'),
                        user && h('p', { className: 'text-xs text-gray-600' }, 
                            `${user.username}${user.isGuest ? ' (ゲスト)' : ''}`
                        )
                    ),
                    h('div', { className: 'flex items-center space-x-2' },
                        user && h('button', {
                            onClick: onLogout,
                            className: 'p-2 rounded-lg hover:bg-gray-100 transition-colors text-gray-600'
                        }, h(LogOut, { className: 'w-5 h-5' }))
                    )
                )
            );
        };

        // ボトムナビゲーションコンポーネント
        const BottomNavigation = ({ currentPage, onPageChange, highlightElement, onReceiptScan }) => {
            // デバッグ用ログ
            if (highlightElement) {
                console.log('BottomNavigation highlightElement:', highlightElement);
            }
            const navItems = [
                { icon: Home, label: 'ホーム', page: 'home' },
                { icon: Receipt, label: 'レシート', page: 'receipt', action: onReceiptScan },
                { icon: Calculator, label: '家計簿', page: 'accounting' },
                { icon: ChefHat, label: 'メニュー', page: 'menu' },
                { icon: Settings, label: '設定', page: 'settings' },
            ];

            return h('nav', { className: 'bottom-nav' },
                h('div', { className: 'flex items-center justify-around py-2' },
                    ...navItems.map(({ icon: Icon, label, page, action }) => {
                        const isHighlighted = highlightElement && highlightElement === page;
                        return h('div', { 
                            key: page,
                            className: `relative ${isHighlighted ? 'z-30' : ''}`
                        },
                            // ハイライト効果
                            isHighlighted && h('div', {
                                className: 'absolute -top-2 -left-2 -right-2 -bottom-2 bg-yellow-400 rounded-lg animate-pulse',
                                style: { zIndex: 1 }
                            }),
                            
                            // 指し示し矢印
                            isHighlighted && h('div', {
                                className: 'absolute -top-8 left-1/2 transform -translate-x-1/2 z-20',
                                style: { zIndex: 2 }
                            },
                                h('div', { className: 'bg-yellow-400 text-black px-3 py-1 rounded-full text-sm font-bold' }, 'ここをタップ！'),
                                h('div', { 
                                    className: 'w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-yellow-400 mx-auto mt-1'
                                })
                            ),
                            
                            h('button', {
                            onClick: () => {
                                if (page === 'receipt' && action) {
                                    action(); // レシートスキャンを直接実行
                                } else {
                                    onPageChange(page);
                                }
                            },
                                className: `relative flex flex-col items-center py-2 px-3 rounded-lg hover:bg-slate-700/50 transition-all duration-200 ${currentPage === page ? 'text-amber-300' : 'text-slate-200'} ${isHighlighted ? 'z-10' : ''}`,
                                style: { zIndex: 3 }
                        },
                            h(Icon, { className: 'w-5 h-5' }),
                            h('span', { className: 'text-xs mt-1' }, label)
                        )
                        );
                    })
                )
            );
        };

        // ホームページコンポーネント
        const HomePage = ({ onPageChange, user, location }) => {
            // 家計簿データを取得
            const [records, setRecords] = useState(() => {
                const saved = localStorage.getItem('accounting-records');
                return saved ? JSON.parse(saved) : [];
            });
            
            // 予算データを取得
            const [monthlyBudget, setMonthlyBudget] = useState(() => {
                const saved = localStorage.getItem('monthlyBudget');
                return saved ? JSON.parse(saved) : null;
            });
            
            const quickActions = [
                { icon: Camera, label: 'レシート撮影', page: 'receipt', color: 'bg-blue-500' },
                { icon: Calculator, label: '家計簿入力', page: 'accounting', color: 'bg-green-500' },
                { icon: ChefHat, label: 'メニュー作成', page: 'menu', color: 'bg-orange-500' },
            ];

            // データの更新を監視
            useEffect(() => {
                const handleStorageChange = () => {
                    const savedRecords = localStorage.getItem('accounting-records');
                    if (savedRecords) {
                        setRecords(JSON.parse(savedRecords));
                    }
                    
                    const savedBudget = localStorage.getItem('monthlyBudget');
                    if (savedBudget) {
                        setMonthlyBudget(JSON.parse(savedBudget));
                    }
                };
                
                // ストレージ変更を監視
                window.addEventListener('storage', handleStorageChange);
                
                // 定期的にデータをチェック（他のタブでの変更を検知）
                const interval = setInterval(handleStorageChange, 1000);
                
                return () => {
                    window.removeEventListener('storage', handleStorageChange);
                    clearInterval(interval);
                };
            }, []);

            // 現在の月のデータを計算
            const currentDate = new Date();
            const currentMonthRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === currentDate.getFullYear() && 
                       recordDate.getMonth() === currentDate.getMonth();
            });
            
            const totalExpense = currentMonthRecords.filter(record => record.type === 'expense').reduce((sum, record) => sum + record.amount, 0);
            const foodExpenses = currentMonthRecords.filter(record => record.type === 'expense' && record.category === '食費').reduce((sum, record) => sum + record.amount, 0);
            
            // レシートデータを取得
            const receipts = JSON.parse(localStorage.getItem('receipts') || '[]');
            const currentMonthReceipts = receipts.filter(receipt => {
                const receiptDate = new Date(receipt.date);
                return receiptDate.getFullYear() === currentDate.getFullYear() && 
                       receiptDate.getMonth() === currentDate.getMonth();
            });
            
            // 今日の節約額計算
            const calculateTodaySavings = () => {
                if (!monthlyBudget) return null; // 予算未設定の場合はnullを返す
                
                // 月の日数を取得
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                // 1日の予算額を計算
                const dailyBudget = monthlyBudget.amount / daysInMonth;
                
                // 今日の食費支出を計算
                const today = currentDate.toISOString().split('T')[0];
                const todayFoodExpenses = currentMonthRecords
                    .filter(record => record.type === 'expense' && record.category === '食費' && record.date === today)
                    .reduce((sum, record) => sum + record.amount, 0);
                
                // 今日の節約額 = 1日の予算 - 今日の食費支出
                return dailyBudget - todayFoodExpenses;
            };
            
            const todaySavings = calculateTodaySavings();
            
            const stats = [
                { label: '今月の支出', value: `¥${totalExpense.toLocaleString()}`, positive: true },
                { 
                    label: '今日の節約額', 
                    value: todaySavings === null ? '予算未設定' : `¥${Math.round(todaySavings).toLocaleString()}`, 
                    positive: todaySavings === null ? true : todaySavings >= 0 
                },
                { label: '登録レシート', value: `${currentMonthReceipts.length}枚`, positive: true },
            ];

            // 日替わりレシピデータベース（30種類）
            const recipeDatabase = [
                {
                    id: 1,
                    name: '親子丼',
                    image: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?w=400&h=300&fit=crop',
                    description: '鶏肉と卵の優しい味わい',
                    difficulty: '簡単',
                    time: '15分',
                    servings: '2人分',
                    ingredients: ['鶏もも肉 200g', '玉ねぎ 1/2個', '卵 3個', 'ご飯 2膳分', 'だし汁 200ml', '醤油 大さじ2', 'みりん 大さじ1', '砂糖 小さじ1'],
                    instructions: [
                        '鶏もも肉を一口大（2cm角）に切る',
                        '玉ねぎを薄切り（3mm幅）にする',
                        '鍋にだし汁、醤油、みりん、砂糖を入れて中火で煮る',
                        '鶏肉を加えて3分間煮る',
                        '玉ねぎを加えて2分間煮る',
                        '卵を溶いて流し入れ、半熟になるまで30秒煮る',
                        'ご飯の上に盛り付けて完成'
                    ],
                    category: '和食'
                },
                {
                    id: 2,
                    name: 'パスタカルボナーラ',
                    image: 'https://images.unsplash.com/photo-1621996346565-e3dbc353d2e5?w=400&h=300&fit=crop',
                    description: 'クリーミーで本格的な味',
                    difficulty: '普通',
                    time: '20分',
                    servings: '2人分',
                    ingredients: ['スパゲッティ 200g', 'ベーコン 100g', '卵 2個', 'パルメザンチーズ 50g', 'にんにく 1片', 'ブラックペッパー 適量', '塩 適量'],
                    instructions: [
                        'スパゲッティを表示時間より1分短く茹でる',
                        'ベーコンを1cm幅に切って中火で炒める',
                        'にんにくをみじん切りにして加え、香りが出るまで炒める',
                        '卵とパルメザンチーズをボウルで混ぜる',
                        '茹でたパスタをベーコンと一緒に炒める',
                        '火を止めて卵とチーズの混合物を加える',
                        '素早く混ぜてクリーミーなソースを作る',
                        'ブラックペッパーを振りかけて完成'
                    ],
                    category: '洋食'
                },
                {
                    id: 3,
                    name: '麻婆豆腐',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'ピリ辛でご飯が進む一品',
                    difficulty: '普通',
                    time: '25分',
                    servings: '2人分',
                    ingredients: ['木綿豆腐 1丁', '豚ひき肉 150g', '長ねぎ 1本', '豆板醤 小さじ1', '甜麺醤 大さじ1', '醤油 大さじ1', '酒 大さじ1', 'にんにく 1片', 'しょうが 1片'],
                    instructions: [
                        '豆腐を2cm角に切って熱湯で2分間茹でる',
                        '長ねぎを小口切り、にんにく・しょうがをみじん切りにする',
                        'フライパンに油を熱し、ひき肉を炒める',
                        '豆板醤、甜麺醤を加えて香りを出す',
                        'にんにく、しょうがを加えて炒める',
                        '酒、醤油で味付けし、水100mlを加える',
                        '豆腐を加えて3分間煮る',
                        '水溶き片栗粉でとろみをつけて完成'
                    ],
                    category: '中華'
                },
                {
                    id: 4,
                    name: 'オムライス',
                    image: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?w=400&h=300&fit=crop',
                    description: 'ふわふわ卵で包んだ人気メニュー',
                    difficulty: '普通',
                    time: '30分',
                    servings: '2人分',
                    ingredients: ['ご飯 2膳分', '卵 4個', '玉ねぎ 1/2個', 'ケチャップ 大さじ3', '鶏もも肉 150g', 'バター 20g', '塩 適量', '胡椒 適量'],
                    instructions: [
                        '玉ねぎをみじん切り、鶏肉を1cm角に切る',
                        'フライパンでバターを熱し、玉ねぎを炒める',
                        '鶏肉を加えて炒め、ケチャップで味付けする',
                        'ご飯を加えて炒め、チキンライスを作る',
                        '別のフライパンで卵を溶き、塩胡椒で味付けする',
                        '弱火で卵を焼き、半熟状態にする',
                        'チキンライスを卵で包む',
                        'ケチャップでデコレーションして完成'
                    ],
                    category: '洋食'
                },
                {
                    id: 5,
                    name: '肉じゃが',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '家庭の味、ほっこり美味しい',
                    difficulty: '簡単',
                    time: '35分',
                    servings: '2人分',
                    ingredients: ['じゃがいも 3個', '玉ねぎ 1個', '牛肉 200g', 'だし汁 200ml', '醤油 大さじ2', 'みりん 大さじ1', '砂糖 大さじ1', 'サラダ油 大さじ1'],
                    instructions: [
                        'じゃがいもを一口大に切り、水にさらす',
                        '玉ねぎをくし形切り、牛肉を一口大に切る',
                        'フライパンに油を熱し、牛肉を炒める',
                        '玉ねぎを加えてしんなりするまで炒める',
                        'じゃがいもを加えて2分間炒める',
                        'だし汁と調味料を加えて煮る',
                        '中火で15分間煮込み、じゃがいもが柔らかくなるまで煮る',
                        '味を調えて完成'
                    ],
                    category: '和食'
                },
                {
                    id: 6,
                    name: 'チキンカレー',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'スパイシーで満足感抜群',
                    difficulty: '簡単',
                    time: '40分',
                    servings: '2人分',
                    ingredients: ['鶏もも肉 300g', '玉ねぎ 1個', 'にんじん 1本', 'カレールー 2個', 'にんにく 1片', 'しょうが 1片', 'サラダ油 大さじ1', '水 400ml'],
                    instructions: [
                        '野菜を一口大に切り、鶏肉も一口大に切る',
                        'にんにく、しょうがをみじん切りにする',
                        'フライパンに油を熱し、にんにく・しょうがを炒める',
                        '鶏肉を加えて表面が白くなるまで炒める',
                        '玉ねぎを加えてしんなりするまで炒める',
                        'にんじんを加えて2分間炒める',
                        '水を加えて沸騰させる',
                        'カレールーを加えて20分間煮込む'
                    ],
                    category: '和食'
                },
                {
                    id: 7,
                    name: 'ハンバーグ',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'ジューシーでボリューム満点',
                    difficulty: '普通',
                    time: '45分',
                    servings: '2人分',
                    ingredients: ['合挽き肉 300g', '玉ねぎ 1/2個', 'パン粉 大さじ2', '卵 1個', '牛乳 大さじ2', '塩 小さじ1', '胡椒 適量', 'ナツメグ 少々'],
                    instructions: [
                        '玉ねぎをみじん切りにして油で炒め、冷ます',
                        'ボウルにひき肉、炒めた玉ねぎ、パン粉、卵を入れる',
                        '牛乳、塩、胡椒、ナツメグを加えて混ぜる',
                        '手でよく練って空気を抜く',
                        '2等分して楕円形に成形する',
                        'フライパンで中火で両面を焼く',
                        '蓋をして弱火で5分間蒸し焼きにする',
                        'ソースをかけて完成'
                    ],
                    category: '洋食'
                },
                {
                    id: 8,
                    name: '餃子',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '手作りで美味しい定番メニュー',
                    difficulty: '普通',
                    time: '50分',
                    servings: '2人分',
                    ingredients: ['豚ひき肉 200g', 'キャベツ 1/4個', 'にら 1束', '餃子の皮 30枚', 'にんにく 1片', 'しょうが 1片', '醤油 大さじ1', 'ごま油 大さじ1'],
                    instructions: [
                        'キャベツをみじん切りにして塩もみし、水気を絞る',
                        'にらを細かく切る',
                        'ボウルにひき肉、キャベツ、にらを入れる',
                        'にんにく、しょうがをすりおろして加える',
                        '醤油、ごま油で味付けして混ぜる',
                        '餃子の皮で包む（縁に水をつけて閉じる）',
                        'フライパンで焼き色をつける',
                        '水を加えて蓋をし、蒸し焼きにする'
                    ],
                    category: '中華'
                },
                {
                    id: 9,
                    name: '唐揚げ',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'サクサクでジューシーな定番料理',
                    difficulty: '簡単',
                    time: '30分',
                    servings: '2人分',
                    ingredients: ['鶏もも肉 400g', 'にんにく 1片', 'しょうが 1片', '醤油 大さじ2', '酒 大さじ1', '片栗粉 適量', 'サラダ油 適量'],
                    instructions: [
                        '鶏肉を一口大（3cm角）に切る',
                        'にんにく、しょうがをすりおろす',
                        '鶏肉に醤油、酒、にんにく、しょうがを加えて下味をつける',
                        '30分間冷蔵庫で寝かせる',
                        '片栗粉をまぶして余分な粉を落とす',
                        '170℃の油で4分間揚げる',
                        '一度取り出して油を切る',
                        '180℃の油で2分間再揚げして完成'
                    ],
                    category: '和食'
                },
                {
                    id: 10,
                    name: 'エビチリ',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '甘辛い味付けでご飯が進む',
                    difficulty: '普通',
                    time: '25分',
                    servings: '2人分',
                    ingredients: ['エビ 200g', '玉ねぎ 1/2個', 'ピーマン 2個', 'にんにく 1片', 'しょうが 1片', 'ケチャップ 大さじ2', '豆板醤 小さじ1', '醤油 大さじ1'],
                    instructions: [
                        'エビの背わたを取り、殻をむく',
                        '野菜を一口大に切る',
                        'エビに塩胡椒を振る',
                        'フライパンに油を熱し、エビを炒める',
                        '野菜を加えて炒める',
                        'ケチャップ、豆板醤、醤油で味付けする',
                        '水溶き片栗粉でとろみをつける',
                        'ご飯と一緒に盛り付けて完成'
                    ],
                    category: '中華'
                },
                {
                    id: 11,
                    name: '生姜焼き',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '生姜の香りが食欲をそそる',
                    difficulty: '簡単',
                    time: '20分',
                    servings: '2人分',
                    ingredients: ['豚ロース肉 300g', '玉ねぎ 1個', 'しょうが 1片', '醤油 大さじ2', 'みりん 大さじ1', '酒 大さじ1', 'サラダ油 大さじ1'],
                    instructions: [
                        '豚肉を薄切り（5mm厚）にする',
                        '玉ねぎを薄切りにする',
                        'しょうがをすりおろす',
                        'フライパンに油を熱し、豚肉を炒める',
                        '玉ねぎを加えて炒める',
                        'しょうが、醤油、みりん、酒で味付けする',
                        '中火で3分間炒める',
                        'ご飯と一緒に盛り付けて完成'
                    ],
                    category: '和食'
                },
                {
                    id: 12,
                    name: 'ロールキャベツ',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'ほっこり温まる家庭料理',
                    difficulty: '普通',
                    time: '60分',
                    servings: '2人分',
                    ingredients: ['キャベツ 1個', '合挽き肉 200g', '玉ねぎ 1/2個', 'パン粉 大さじ2', '卵 1個', 'トマト缶 1缶', 'コンソメ 1個'],
                    instructions: [
                        'キャベツを丸ごと茹でて葉をはがす',
                        '玉ねぎをみじん切りにして炒める',
                        'ひき肉、玉ねぎ、パン粉、卵を混ぜる',
                        'キャベツの葉で具材を包む',
                        '鍋にトマト缶とコンソメを入れる',
                        'ロールキャベツを並べて煮る',
                        '弱火で30分間煮込む',
                        '味を調えて完成'
                    ],
                    category: '洋食'
                },
                {
                    id: 13,
                    name: '酢豚',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '甘酢あんが美味しい中華料理',
                    difficulty: '普通',
                    time: '35分',
                    servings: '2人分',
                    ingredients: ['豚ロース肉 300g', '玉ねぎ 1個', 'ピーマン 2個', 'にんじん 1本', 'パイナップル 1/4個', '醤油 大さじ2', '酢 大さじ2', '砂糖 大さじ2'],
                    instructions: [
                        '肉を一口大に切り、衣をつけて揚げる',
                        '野菜を一口大に切る',
                        'フライパンで野菜を炒める',
                        '揚げた肉を加える',
                        '醤油、酢、砂糖で甘酢あんを作る',
                        '野菜と肉に甘酢あんをかける',
                        'パイナップルを加えて炒める',
                        'ご飯と一緒に盛り付けて完成'
                    ],
                    category: '中華'
                },
                {
                    id: 14,
                    name: '白身魚のムニエル',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '上品で美味しい洋食',
                    difficulty: '普通',
                    time: '25分',
                    servings: '2人分',
                    ingredients: ['白身魚 2切れ', 'バター 30g', 'レモン 1個', 'パセリ 適量', '小麦粉 適量', '塩 適量', '胡椒 適量'],
                    instructions: [
                        '魚に塩胡椒を振る',
                        '小麦粉をまぶして余分な粉を落とす',
                        'フライパンにバターを熱す',
                        '魚を入れて中火で焼く',
                        '片面がきつね色になったら裏返す',
                        '両面をきつね色に焼く',
                        'レモンとパセリを添える',
                        'ソースをかけて完成'
                    ],
                    category: '洋食'
                },
                {
                    id: 15,
                    name: '筑前煮',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '具だくさんで栄養満点',
                    difficulty: '簡単',
                    time: '45分',
                    servings: '2人分',
                    ingredients: ['鶏もも肉 200g', 'にんじん 1本', 'れんこん 1節', 'ごぼう 1本', 'しいたけ 4個', 'だし汁 300ml', '醤油 大さじ3', 'みりん 大さじ2'],
                    instructions: [
                        '材料を一口大に切る',
                        'フライパンに油を熱し、鶏肉を炒める',
                        '野菜を加えて炒める',
                        'だし汁と調味料を加える',
                        '中火で20分間煮込む',
                        '味が染み込むまで煮る',
                        '最後に味を調える',
                        '器に盛り付けて完成'
                    ],
                    category: '和食'
                },
                {
                    id: 16,
                    name: 'グラタン',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'クリーミーでボリューム満点',
                    difficulty: '普通',
                    time: '40分',
                    servings: '2人分',
                    ingredients: ['マカロニ 100g', 'ベーコン 100g', '玉ねぎ 1個', 'ホワイトソース 200ml', 'チーズ 50g', 'パン粉 大さじ2', 'バター 20g'],
                    instructions: [
                        'マカロニを茹でる',
                        'ベーコンと玉ねぎを炒める',
                        'ホワイトソースと混ぜる',
                        '耐熱皿に入れる',
                        'チーズとパン粉をかける',
                        '200℃のオーブンで15分焼く',
                        '表面がきつね色になるまで焼く',
                        '熱々でいただく'
                    ],
                    category: '洋食'
                },
                {
                    id: 17,
                    name: '回鍋肉',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'ピリ辛でご飯が進む中華料理',
                    difficulty: '普通',
                    time: '30分',
                    servings: '2人分',
                    ingredients: ['豚バラ肉 200g', 'キャベツ 1/4個', '長ねぎ 1本', '豆板醤 小さじ1', '甜麺醤 大さじ1', '醤油 大さじ1', '酒 大さじ1'],
                    instructions: [
                        '豚肉を茹でて薄切りにする',
                        'キャベツを一口大に切る',
                        'フライパンで肉を炒める',
                        'キャベツを加える',
                        '豆板醤、甜麺醤を加える',
                        '醤油、酒で味付けする',
                        '強火で炒め上げる',
                        'ご飯と一緒に盛り付けて完成'
                    ],
                    category: '中華'
                },
                {
                    id: 18,
                    name: 'ハヤシライス',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '甘くて美味しい人気メニュー',
                    difficulty: '簡単',
                    time: '25分',
                    servings: '2人分',
                    ingredients: ['牛肉 200g', '玉ねぎ 1個', 'ハヤシルー 1箱', 'ご飯 2膳分', 'バター 20g', 'サラダ油 大さじ1'],
                    instructions: [
                        '玉ねぎを薄切りにする',
                        '肉を一口大に切る',
                        'フライパンで玉ねぎを炒める',
                        '肉を加えて炒める',
                        '水を加えて煮る',
                        'ハヤシルーを加える',
                        'とろみがつくまで煮込む',
                        'ご飯にかけて完成'
                    ],
                    category: '洋食'
                },
                {
                    id: 19,
                    name: 'チキン南蛮',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'タルタルソースが美味しい',
                    difficulty: '普通',
                    time: '35分',
                    servings: '2人分',
                    ingredients: ['鶏もも肉 2枚', '玉ねぎ 1/2個', '卵 2個', 'マヨネーズ 大さじ3', '酢 大さじ1', '小麦粉 適量', 'サラダ油 適量'],
                    instructions: [
                        '鶏肉を一口大に切る',
                        '塩胡椒を振って小麦粉をまぶす',
                        '170℃の油で揚げる',
                        'タルタルソースを作る（玉ねぎ、卵、マヨネーズ、酢を混ぜる）',
                        '揚げた肉にソースをかける',
                        'ご飯と一緒に盛り付ける',
                        'レタスを添える',
                        '完成'
                    ],
                    category: '和食'
                },
                {
                    id: 20,
                    name: '肉団子のスープ',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'ほっこり温まるスープ料理',
                    difficulty: '簡単',
                    time: '30分',
                    servings: '2人分',
                    ingredients: ['合挽き肉 200g', '玉ねぎ 1/2個', 'にんじん 1本', 'キャベツ 1/4個', 'コンソメ 2個', '塩 適量', '胡椒 適量'],
                    instructions: [
                        '肉団子を作る（ひき肉、塩、胡椒を混ぜて丸める）',
                        '野菜を一口大に切る',
                        '鍋に水とコンソメを入れてスープを作る',
                        '肉団子を入れる',
                        '野菜を加える',
                        '中火で15分間煮る',
                        '味を調える',
                        '熱々でいただく'
                    ],
                    category: '和食'
                },
                {
                    id: 21,
                    name: 'ポトフ',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '野菜の甘みが美味しいフランス料理',
                    difficulty: '簡単',
                    time: '50分',
                    servings: '2人分',
                    ingredients: ['ソーセージ 4本', 'じゃがいも 3個', 'にんじん 2本', '玉ねぎ 1個', 'キャベツ 1/4個', 'コンソメ 2個', 'ローリエ 2枚'],
                    instructions: [
                        '野菜を一口大に切る',
                        '鍋に材料を入れる',
                        '水を加えて煮る',
                        'コンソメで味付けする',
                        'ローリエを加える',
                        '弱火で30分間煮込む',
                        '野菜が柔らかくなるまで煮る',
                        '塩胡椒で味を調えて完成'
                    ],
                    category: '洋食'
                },
                {
                    id: 22,
                    name: '麻婆茄子',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '茄子が美味しい麻婆料理',
                    difficulty: '普通',
                    time: '25分',
                    servings: '2人分',
                    ingredients: ['茄子 2本', '豚ひき肉 150g', '長ねぎ 1本', '豆板醤 小さじ1', '甜麺醤 大さじ1', '醤油 大さじ1', 'にんにく 1片'],
                    instructions: [
                        '茄子を一口大に切る',
                        'ひき肉を炒める',
                        '豆板醤、甜麺醤を加える',
                        '茄子を加えて炒める',
                        '調味料で味付けする',
                        '水を加えて煮る',
                        'とろみをつける',
                        'ご飯と一緒に盛り付けて完成'
                    ],
                    category: '中華'
                },
                {
                    id: 23,
                    name: 'オムレツ',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'ふわふわで美味しい卵料理',
                    difficulty: '簡単',
                    time: '15分',
                    servings: '2人分',
                    ingredients: ['卵 4個', '牛乳 大さじ2', 'バター 20g', '塩 適量', '胡椒 適量', 'パセリ 適量'],
                    instructions: [
                        '卵を溶く',
                        '牛乳を加える',
                        '塩胡椒で味付けする',
                        'フライパンにバターを熱す',
                        '卵を流し入れる',
                        '弱火でふわふわに仕上げる',
                        'パセリを散らす',
                        '熱々でいただく'
                    ],
                    category: '洋食'
                },
                {
                    id: 24,
                    name: 'チキンソテー',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'シンプルで美味しい洋食',
                    difficulty: '簡単',
                    time: '20分',
                    servings: '2人分',
                    ingredients: ['鶏もも肉 2枚', 'にんにく 1片', 'ローズマリー 適量', 'オリーブオイル 大さじ2', '塩 適量', '胡椒 適量'],
                    instructions: [
                        '鶏肉に塩胡椒を振る',
                        'にんにくを加える',
                        'オリーブオイルで焼く',
                        'ローズマリーを加える',
                        '両面を焼く',
                        '香りが立つまで焼く',
                        '肉汁が出るまで焼く',
                        '完成'
                    ],
                    category: '洋食'
                },
                {
                    id: 25,
                    name: '野菜炒め',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'シャキシャキで美味しい定番料理',
                    difficulty: '簡単',
                    time: '15分',
                    servings: '2人分',
                    ingredients: ['キャベツ 1/4個', 'にんじん 1本', 'もやし 1袋', '豚バラ肉 100g', '醤油 大さじ2', '酒 大さじ1', 'サラダ油 大さじ1'],
                    instructions: [
                        '野菜を切る',
                        '肉を炒める',
                        '野菜を加える',
                        '強火で炒める',
                        '調味料で味付けする',
                        'シャキシャキに仕上げる',
                        'ご飯と一緒に盛り付ける',
                        '完成'
                    ],
                    category: '和食'
                },
                {
                    id: 26,
                    name: 'カレーライス',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '日本人の国民食',
                    difficulty: '簡単',
                    time: '45分',
                    servings: '2人分',
                    ingredients: ['牛肉 200g', '玉ねぎ 1個', 'にんじん 1本', 'じゃがいも 2個', 'カレールー 2個', 'にんにく 1片', 'しょうが 1片'],
                    instructions: [
                        '野菜を一口大に切る',
                        '肉を炒める',
                        '野菜を加えて炒める',
                        '水を加えて煮る',
                        'ルーを加える',
                        'とろみがつくまで煮込む',
                        'ご飯にかける',
                        '完成'
                    ],
                    category: '和食'
                },
                {
                    id: 27,
                    name: 'ハンバーガー',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '手作りで美味しいハンバーガー',
                    difficulty: '普通',
                    time: '40分',
                    servings: '2人分',
                    ingredients: ['合挽き肉 300g', '玉ねぎ 1/2個', 'パン粉 大さじ2', '卵 1個', 'ハンバーガー用パン 2個', 'レタス 適量', 'トマト 1個'],
                    instructions: [
                        'パテを作る',
                        '玉ねぎを炒める',
                        '材料を混ぜる',
                        '成形して焼く',
                        'パンに挟む',
                        '野菜を加える',
                        'ソースをかける',
                        '完成'
                    ],
                    category: '洋食'
                },
                {
                    id: 28,
                    name: 'ラーメン',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '本格的な手作りラーメン',
                    difficulty: '普通',
                    time: '60分',
                    servings: '2人分',
                    ingredients: ['中華麺 2玉', '豚バラ肉 200g', '長ねぎ 1本', 'もやし 1袋', '醤油 大さじ3', '酒 大さじ2', 'にんにく 1片', 'しょうが 1片'],
                    instructions: [
                        'スープを作る',
                        'チャーシューを作る',
                        '麺を茹でる',
                        '具材を準備する',
                        'スープに麺を入れる',
                        '具材をトッピングする',
                        '熱々でいただく',
                        '完成'
                    ],
                    category: '和食'
                },
                {
                    id: 29,
                    name: '天ぷら',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: 'サクサクで美味しい天ぷら',
                    difficulty: '普通',
                    time: '30分',
                    servings: '2人分',
                    ingredients: ['えび 8尾', 'かぼちゃ 1/4個', 'なす 2本', '天ぷら粉 100g', '冷水 150ml', '天つゆ 適量', 'サラダ油 適量'],
                    instructions: [
                        '材料を切る',
                        '衣を作る',
                        '材料に衣をつける',
                        '高温の油で揚げる',
                        'きつね色になるまで揚げる',
                        '天つゆでいただく',
                        '熱々でいただく',
                        '完成'
                    ],
                    category: '和食'
                },
                {
                    id: 30,
                    name: 'すき焼き',
                    image: 'https://images.unsplash.com/photo-1574484284002-952d92456975?w=400&h=300&fit=crop',
                    description: '甘辛い味付けの定番鍋料理',
                    difficulty: '簡単',
                    time: '30分',
                    servings: '2人分',
                    ingredients: ['牛肉 300g', '玉ねぎ 1個', 'しらたき 1袋', 'しいたけ 4個', 'すき焼きのたれ 200ml', '卵 2個', 'ご飯 2膳分'],
                    instructions: [
                        '野菜を切る',
                        '肉を薄切りにする',
                        'すき焼きのたれを温める',
                        '材料を順番に煮る',
                        '卵を溶いてつけダレにする',
                        'ご飯と一緒にいただく',
                        '熱々でいただく',
                        '完成'
                    ],
                    category: '和食'
                }
            ];

            // 日替わりレシピを取得（日付に基づいてローテーション）
            const getDailyRecipe = () => {
                const today = new Date();
                const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                const recipeIndex = dayOfYear % recipeDatabase.length;
                return recipeDatabase[recipeIndex];
            };

            const dailyRecipe = getDailyRecipe();
            
            // レシピ詳細モーダルの状態
            const [showRecipeDetail, setShowRecipeDetail] = useState(false);
            const [selectedRecipe, setSelectedRecipe] = useState(null);

            // レシピをメニューに追加する関数
            const addRecipeToMenu = (recipe) => {
                try {
                    // 既存のメニューデータを取得
                    const existingMenus = JSON.parse(localStorage.getItem('menus') || '[]');
                    
                    // レシピをメニュー形式に変換
                    const menuItem = {
                        id: `recipe_${recipe.id}_${Date.now()}`,
                        name: recipe.name,
                        description: recipe.description,
                        ingredients: recipe.ingredients,
                        prepTime: parseInt(recipe.time.replace('分', '')) || 30,
                        servings: parseInt(recipe.servings.replace('人分', '')) || 2,
                        difficulty: recipe.difficulty === '簡単' ? 'easy' : recipe.difficulty === '普通' ? 'medium' : 'hard',
                        tags: [recipe.category],
                        instructions: recipe.instructions,
                        image: recipe.image,
                        type: 'recipe' // レシピから追加されたことを示すフラグ
                    };
                    
                    // 重複チェック（同じレシピが既に追加されていないか）
                    const isDuplicate = existingMenus.some(menu => 
                        menu.name === recipe.name && menu.type === 'recipe'
                    );
                    
                    if (!isDuplicate) {
                        // メニューに追加
                        const updatedMenus = [menuItem, ...existingMenus];
                        localStorage.setItem('menus', JSON.stringify(updatedMenus));
                        alert(`${recipe.name}をメニューに追加しました！`);
                    } else {
                        alert(`${recipe.name}は既にメニューに追加されています。`);
                    }
                } catch (error) {
                    console.error('メニュー追加エラー:', error);
                    alert('メニューの追加に失敗しました。');
                }
            };

            return h('div', { className: 'p-4 space-y-6 pb-24' },
                h('div', { className: 'text-center py-6' },
                    h('h1', { className: 'text-2xl font-bold text-gray-900 mb-2' }, 
                        `おかえりなさい、${user?.username || 'ユーザー'}さん！`
                    ),
                    h('p', { className: 'text-gray-600' }, '今日もスマートな買い物をサポートします'),
                ),
                h('div', { className: 'grid grid-cols-1 gap-4' },
                    ...stats.map((stat, index) =>
                        h('div', { key: index, className: 'card' },
                            h('div', { className: 'flex justify-between items-center' },
                                h('div', null,
                                    h('p', { className: 'text-sm text-gray-600' }, stat.label),
                                    h('p', { className: 'text-2xl font-bold text-gray-900' }, stat.value)
                                ),
                                h('div', { className: `text-sm font-medium ${stat.positive ? 'text-green-600' : 'text-red-600'}` },
                                    stat.change
                                )
                            )
                        )
                    )
                ),
                // 日替わりレシピセクション
                h('div', { className: 'space-y-4' },
                    h('h2', { className: 'text-lg font-semibold text-gray-900' }, '🍳 今日のおすすめ献立'),
                    h('div', { className: 'card overflow-hidden' },
                        h('div', { className: 'relative' },
                            h('img', {
                                src: dailyRecipe.image,
                                alt: dailyRecipe.name,
                                className: 'w-full h-48 object-cover',
                                onError: (e) => {
                                    e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOUI5QkEwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiPuaXoOazleWbveW6lzwvdGV4dD4KPC9zdmc+';
                                }
                            }),
                            h('div', { className: 'absolute top-2 right-2' },
                                h('span', { 
                                    className: `px-2 py-1 rounded-full text-xs font-medium ${
                                        dailyRecipe.difficulty === '簡単' ? 'bg-green-100 text-green-800' :
                                        dailyRecipe.difficulty === '普通' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }`
                                }, dailyRecipe.difficulty)
                            )
                        ),
                        h('div', { className: 'p-4' },
                            h('div', { className: 'flex justify-between items-start mb-2' },
                                h('h3', { className: 'text-xl font-bold text-gray-900' }, dailyRecipe.name),
                                h('span', { className: 'text-sm text-gray-500' }, dailyRecipe.category)
                            ),
                            h('p', { className: 'text-gray-600 mb-3' }, dailyRecipe.description),
                            h('div', { className: 'flex items-center space-x-4 mb-3 text-sm text-gray-500' },
                                h('div', { className: 'flex items-center space-x-1' },
                                    h('span', null, '⏱️'),
                                    h('span', null, dailyRecipe.time)
                                ),
                                h('div', { className: 'flex items-center space-x-1' },
                                    h('span', null, '👥'),
                                    h('span', null, dailyRecipe.servings)
                                ),
                            ),
                            h('div', { className: 'space-y-2' },
                                h('h4', { className: 'font-medium text-gray-900' }, '材料'),
                                h('ul', { className: 'text-sm text-gray-600 space-y-1' },
                                    ...dailyRecipe.ingredients.slice(0, 3).map((ingredient, index) =>
                                        h('li', { key: index, className: 'flex items-center space-x-2' },
                                            h('span', { className: 'text-gray-400' }, '•'),
                                            h('span', null, ingredient)
                                        )
                                    ),
                                    dailyRecipe.ingredients.length > 3 && h('li', { className: 'text-gray-400 text-xs' }, 
                                        `他${dailyRecipe.ingredients.length - 3}品...`
                                    )
                                )
                            ),
                            h('div', { className: 'mt-4 flex space-x-2' },
                                h('button', {
                                    onClick: () => {
                                        setSelectedRecipe(dailyRecipe);
                                        setShowRecipeDetail(true);
                                    },
                                    className: 'flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors text-sm font-medium'
                                }, '詳細を見る'),
                                h('button', {
                                    onClick: () => addRecipeToMenu(dailyRecipe),
                                    className: 'flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium'
                                }, 'メニューに追加')
                            )
                        )
                    )
                ),
                h('div', { className: 'space-y-4' },
                    h('h2', { className: 'text-lg font-semibold text-gray-900' }, 'クイックアクション'),
                    h('div', { className: 'grid grid-cols-1 gap-3' },
                        ...quickActions.map((action, index) =>
                            h('button', {
                                key: index,
                                onClick: () => onPageChange(action.page),
                                className: 'w-full card hover:shadow-md transition-shadow'
                            },
                                h('div', { className: 'flex items-center space-x-4' },
                                    h('div', { className: `p-3 rounded-lg ${action.color}` },
                                        h(action.icon, { className: 'w-6 h-6 text-white' })
                                    ),
                                    h('div', null,
                                        h('h3', { className: 'font-medium text-gray-900' }, action.label),
                                        h('p', { className: 'text-sm text-gray-600' }, 'タップして開始')
                                    ),
                                    h(Plus, { className: 'w-5 h-5 text-gray-400 ml-auto' })
                                )
                            )
                        )
                    )
                ),
                // レシピ詳細モーダル
                showRecipeDetail && selectedRecipe && h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50' },
                    h('div', { className: 'bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto' },
                        h('div', { className: 'relative' },
                            h('img', {
                                src: selectedRecipe.image,
                                alt: selectedRecipe.name,
                                className: 'w-full h-64 object-cover rounded-t-2xl',
                                onError: (e) => {
                                    e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOUI5QkEwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiPuaXoOazleWbveW6lzwvdGV4dD4KPC9zdmc+';
                                }
                            }),
                            h('button', {
                                onClick: () => setShowRecipeDetail(false),
                                className: 'absolute top-4 right-4 bg-white bg-opacity-80 hover:bg-opacity-100 rounded-full p-2 transition-all'
                            }, h('span', { className: 'text-gray-600 text-xl' }, '×'))
                        ),
                        h('div', { className: 'p-6' },
                            h('div', { className: 'flex justify-between items-start mb-4' },
                                h('h2', { className: 'text-2xl font-bold text-gray-900' }, selectedRecipe.name),
                                h('span', { 
                                    className: `px-3 py-1 rounded-full text-sm font-medium ${
                                        selectedRecipe.difficulty === '簡単' ? 'bg-green-100 text-green-800' :
                                        selectedRecipe.difficulty === '普通' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }`
                                }, selectedRecipe.difficulty)
                            ),
                            h('p', { className: 'text-gray-600 mb-4' }, selectedRecipe.description),
                            h('div', { className: 'flex items-center space-x-6 mb-6 text-sm text-gray-500' },
                                h('div', { className: 'flex items-center space-x-1' },
                                    h('span', null, '⏱️'),
                                    h('span', null, selectedRecipe.time)
                                ),
                                h('div', { className: 'flex items-center space-x-1' },
                                    h('span', null, '👥'),
                                    h('span', null, selectedRecipe.servings)
                                )
                            ),
                            h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                                h('div', null,
                                    h('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, '材料'),
                                    h('ul', { className: 'space-y-2' },
                                        ...selectedRecipe.ingredients.map((ingredient, index) =>
                                            h('li', { key: index, className: 'flex items-center space-x-2 text-sm text-gray-700' },
                                                h('span', { className: 'text-gray-400' }, '•'),
                                                h('span', null, ingredient)
                                            )
                                        )
                                    )
                                ),
                                h('div', null,
                                    h('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, '作り方'),
                                    h('ol', { className: 'space-y-2' },
                                        ...selectedRecipe.instructions.map((instruction, index) =>
                                            h('li', { key: index, className: 'flex items-start space-x-2 text-sm text-gray-700' },
                                                h('span', { className: 'bg-orange-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-medium mt-0.5 flex-shrink-0' }, index + 1),
                                                h('span', null, instruction)
                                            )
                                        )
                                    )
                                )
                            ),
                            h('div', { className: 'mt-6 flex space-x-3' },
                                h('button', {
                                    onClick: () => {
                                        addRecipeToMenu(selectedRecipe);
                                        setShowRecipeDetail(false);
                                    },
                                    className: 'flex-1 bg-orange-500 text-white py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors font-medium'
                                }, 'メニューに追加'),
                                h('button', {
                                    onClick: () => setShowRecipeDetail(false),
                                    className: 'flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors font-medium'
                                }, '閉じる')
                            )
                        )
                    )
                )
            );
        };

        // レシートページコンポーネント
        // レシートスキャン専用ページコンポーネント
        const ReceiptScanPage = ({ onComplete }) => {
            const [isCameraOpen, setIsCameraOpen] = useState(true); // 直接カメラを開く
            const [cameraStream, setCameraStream] = useState(null);
            const [capturedImage, setCapturedImage] = useState(null);
            const [ocrResult, setOcrResult] = useState(null);
            const [pendingReceipt, setPendingReceipt] = useState(null);

            // カメラを開く
            const openCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    setCameraStream(stream);
                    setIsCameraOpen(true);
                } catch (error) {
                    alert('カメラにアクセスできません。ブラウザの設定を確認してください。');
                    onComplete(); // エラー時はホームに戻る
                }
            };

            // カメラを閉じる
            const closeCamera = () => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    setCameraStream(null);
                }
                setIsCameraOpen(false);
            };

            // OCR処理でレシートを解析
            const processReceiptWithOCR = async (imageData) => {
                try {
                    console.log('OCR処理を開始しています...');
                    
                    // Tesseract.jsでOCR処理
                    const { data: { text } } = await Tesseract.recognize(
                        imageData,
                        'jpn+eng', // 日本語と英語
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    console.log(`OCR進行状況: ${Math.round(m.progress * 100)}%`);
                                }
                            }
                        }
                    );
                    
                    console.log('OCR認識結果:', text);
                    
                    // レシート情報を解析
                    const receiptData = parseReceiptText(text);
                    setOcrResult(receiptData);
                    
                } catch (error) {
                    console.error('OCR処理エラー:', error);
                    // エラー時はエラーメッセージを表示して再撮影を促す
                    showOCRError();
                }
            };

            // レシートテキストを解析して構造化データに変換
            const parseReceiptText = (text) => {
                const lines = text.split('\n').filter(line => line.trim());
                
                // 店舗名を抽出（最初の行または「店」「マート」を含む行）
                let store = '不明な店舗';
                for (const line of lines) {
                    if (line.includes('店') || line.includes('マート') || line.includes('イレブン')) {
                        store = line.trim();
                        break;
                    }
                }
                
                // 商品と価格を抽出
                const items = [];
                let totalAmount = 0;
                
                for (const line of lines) {
                    // 価格パターンを検索（数字+円、または数字のみ）
                    const priceMatch = line.match(/(\d+)\s*円?/);
                    if (priceMatch) {
                        const price = parseInt(priceMatch[1]);
                        
                        // 合計金額の可能性をチェック
                        if (line.includes('合計') || line.includes('計') || line.includes('小計')) {
                            totalAmount = price;
                        } else {
                            // 商品名を抽出（価格の前の部分）
                            const productName = line.replace(priceMatch[0], '').trim();
                            if (productName && productName.length > 0) {
                                items.push({
                                    name: productName,
                                    price: price,
                                    quantity: 1,
                                    category: '食費'
                                });
                            }
                        }
                    }
                }
                
                // 合計金額が抽出できなかった場合、商品の合計を計算
                if (totalAmount === 0 && items.length > 0) {
                    totalAmount = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                }
                
                // 商品が抽出できなかった場合はエラーとして扱う
                if (items.length === 0) {
                    throw new Error('商品情報を抽出できませんでした');
                }
                
                return {
                    store: store,
                    items: items,
                    totalAmount: totalAmount || 1000
                };
            };

            // OCR失敗時のエラー表示
            const showOCRError = () => {
                console.log('OCR処理に失敗');
                alert('レシートの認識に失敗しました。\n\n以下の点を確認して、もう一度撮影してください：\n・レシートがはっきりと見えるか\n・文字が読み取れる状態か\n・光の反射がないか\n・レシート全体が枠内に収まっているか');
                
                // カメラ画面に戻る
                setCapturedImage(null);
                setOcrResult(null);
                openCamera();
            };

            // 写真を撮影
            const capturePhoto = () => {
                const video = document.getElementById('camera-video');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg');
                setCapturedImage(imageData);
                closeCamera();
                
                // 実際のOCR処理を実行
                processReceiptWithOCR(imageData);
            };

            // OCR結果を確認画面に表示
            const showConfirmation = () => {
                if (ocrResult) {
                    const newReceipt = {
                        id: Date.now().toString(),
                        store: ocrResult.store,
                        totalAmount: ocrResult.totalAmount,
                        items: ocrResult.items,
                        date: new Date().toISOString().split('T')[0],
                    };
                    setPendingReceipt(newReceipt);
                    setOcrResult(null);
                }
            };

            // 確認後にレシートを保存
            const confirmReceipt = () => {
                if (pendingReceipt) {
                    // レシートを保存
                    const existingReceipts = JSON.parse(localStorage.getItem('receipts') || '[]');
                    const updatedReceipts = [pendingReceipt, ...existingReceipts];
                    localStorage.setItem('receipts', JSON.stringify(updatedReceipts));
                    
                    // 家計簿に自動で記入
                    const existingRecords = JSON.parse(localStorage.getItem('accounting-records') || '[]');
                    const newRecords = pendingReceipt.items.map(item => ({
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        amount: item.price * item.quantity,
                        category: item.category,
                        description: `${item.category} - ${new Date().toLocaleDateString()}`,
                        type: 'expense',
                        date: pendingReceipt.date,
                        store: pendingReceipt.store,
                        item: item.name
                    }));
                    const updatedRecords = [...newRecords, ...existingRecords];
                    localStorage.setItem('accounting-records', JSON.stringify(updatedRecords));
                    
                    alert(`レシートが保存されました！\n家計簿にも自動で記録されました。\n合計金額: ¥${pendingReceipt.totalAmount.toLocaleString()}`);
                    onComplete();
                }
            };

            // 初期化時にカメラを開く
            useEffect(() => {
                openCamera();
                return () => closeCamera();
            }, []);

            return h('div', { className: 'min-h-screen bg-gray-50' },
                // ヘッダー
                h('div', { className: 'bg-white shadow-sm p-4' },
                    h('div', { className: 'flex items-center justify-between' },
                        h('button', {
                            onClick: () => {
                                closeCamera();
                                onComplete();
                            },
                            className: 'text-gray-600 hover:text-gray-900'
                        }, '← 戻る'),
                        h('h1', { className: 'text-lg font-semibold text-gray-900' }, 'レシートスキャン'),
                        h('div', { className: 'w-8' }) // スペーサー
                    )
                ),

                // カメラ画面
                isCameraOpen && h('div', { className: 'fixed inset-0 bg-black z-50 flex flex-col' },
                    h('div', { className: 'flex-1 relative' },
                        h('video', {
                            id: 'camera-video',
                            autoPlay: true,
                            playsInline: true,
                            ref: (video) => {
                                if (video && cameraStream) {
                                    video.srcObject = cameraStream;
                                }
                            },
                            className: 'w-full h-full object-cover'
                        }),
                        
                        // スキャンエリアのオーバーレイ
                        h('div', { className: 'absolute inset-0 flex items-center justify-center' },
                            h('div', { className: 'relative' },
                                // スキャンエリアの枠
                                h('div', { 
                                    className: 'w-80 h-48 border-4 border-white rounded-lg relative',
                                    style: { 
                                        boxShadow: '0 0 0 9999px rgba(0, 0, 0, 0.5)',
                                        borderRadius: '12px'
                                    }
                                },
                                    // 角のマーカー
                                    h('div', { className: 'absolute -top-2 -left-2 w-6 h-6 border-t-4 border-l-4 border-yellow-400' }),
                                    h('div', { className: 'absolute -top-2 -right-2 w-6 h-6 border-t-4 border-r-4 border-yellow-400' }),
                                    h('div', { className: 'absolute -bottom-2 -left-2 w-6 h-6 border-b-4 border-l-4 border-yellow-400' }),
                                    h('div', { className: 'absolute -bottom-2 -right-2 w-6 h-6 border-b-4 border-r-4 border-yellow-400' }),
                                    
                                    // 中央のテキスト
                                    h('div', { className: 'absolute inset-0 flex items-center justify-center' },
                                        h('div', { className: 'text-center text-white' },
                                            h('p', { className: 'text-lg font-medium mb-2' }, 'レシートを枠内に合わせてください'),
                                            h('p', { className: 'text-sm opacity-80' }, 'レシート全体が枠内に収まるように')
                                        )
                                    )
                                )
                            )
                        ),
                        
                        h('div', { className: 'absolute top-4 right-4' },
                            h('button', {
                                onClick: () => {
                                    closeCamera();
                                    onComplete();
                                },
                                className: 'bg-red-500 text-white p-2 rounded-full'
                            }, '×')
                        )
                    ),
                    h('div', { className: 'bg-black p-4 flex justify-center' },
                        h('button', {
                            onClick: capturePhoto,
                            className: 'bg-white text-black px-6 py-3 rounded-full font-medium'
                        }, 'レシートを撮影')
                    )
                ),

                // OCR結果表示
                capturedImage && !pendingReceipt && h('div', { className: 'p-4' },
                    h('div', { className: 'card mb-4' },
                        h('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, '撮影したレシート'),
                        h('img', {
                            src: capturedImage,
                            alt: 'Captured receipt',
                            className: 'w-full rounded-lg mb-4'
                        }),
                        ocrResult ? h('div', { className: 'space-y-4' },
                            h('div', { className: 'bg-green-50 p-4 rounded-lg' },
                                h('h4', { className: 'font-medium text-green-800 mb-2' }, 'OCR認識結果'),
                                h('p', { className: 'text-green-700' }, `店舗: ${ocrResult.store}`),
                                h('p', { className: 'text-green-700' }, `合計: ¥${ocrResult.totalAmount.toLocaleString()}`)
                            ),
                            h('div', { className: 'flex space-x-2' },
                                h('button', {
                                    onClick: showConfirmation,
                                    className: 'btn-primary flex-1'
                                }, '詳細確認'),
                                h('button', {
                                    onClick: () => {
                                        setCapturedImage(null);
                                        setOcrResult(null);
                                        openCamera();
                                    },
                                    className: 'btn-secondary flex-1'
                                }, '再撮影')
                            )
                        ) : h('div', { className: 'text-center py-4' },
                            h('div', { className: 'animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto' }),
                            h('p', { className: 'text-gray-600 mt-2' }, 'レシートを読み込み中...')
                        )
                    )
                ),

                // 確認画面
                pendingReceipt && h('div', { className: 'p-4' },
                    h('div', { className: 'card bg-blue-50 border-blue-200' },
                        h('div', { className: 'text-center mb-4' },
                            h('h3', { className: 'text-lg font-semibold text-blue-900 mb-2' }, 'レシート情報の確認'),
                            h('p', { className: 'text-blue-700' }, '以下の情報で家計簿に登録しますか？')
                        ),
                        
                        // 店舗情報
                        h('div', { className: 'mb-4' },
                            h('h4', { className: 'font-medium text-gray-900 mb-2' }, '店舗情報'),
                            h('div', { className: 'bg-white p-3 rounded-lg border' },
                                h('p', { className: 'text-gray-700' }, `店舗名: ${pendingReceipt.store}`),
                                h('p', { className: 'text-gray-700' }, `日付: ${pendingReceipt.date}`),
                                h('p', { className: 'text-lg font-bold text-gray-900' }, `合計金額: ¥${pendingReceipt.totalAmount.toLocaleString()}`)
                            )
                        ),
                        
                        // 商品一覧
                        h('div', { className: 'mb-4' },
                            h('h4', { className: 'font-medium text-gray-900 mb-2' }, '商品一覧'),
                            h('div', { className: 'space-y-2' },
                                ...pendingReceipt.items.map((item, index) =>
                                    h('div', { key: index, className: 'bg-white p-3 rounded-lg border flex justify-between items-center' },
                                        h('div', { className: 'flex-1' },
                                            h('p', { className: 'font-medium text-gray-900' }, item.name),
                                            h('p', { className: 'text-sm text-gray-600' }, `${item.category} × ${item.quantity}個`)
                                        ),
                                        h('p', { className: 'font-bold text-gray-900' }, `¥${(item.price * item.quantity).toLocaleString()}`)
                                    )
                                )
                            )
                        ),
                        
                        // ボタン
                        h('div', { className: 'flex space-x-3' },
                            h('button', {
                                onClick: confirmReceipt,
                                className: 'flex-1 btn-primary'
                            }, '家計簿に登録'),
                            h('button', {
                                onClick: () => {
                                    setPendingReceipt(null);
                                    setCapturedImage(null);
                                    openCamera();
                                },
                                className: 'flex-1 btn-secondary'
                            }, '再撮影')
                        )
                    )
                )
            );
        };

        const ReceiptPage = () => {
            const [receipts, setReceipts] = useState(() => {
                const saved = localStorage.getItem('receipts');
                return saved ? JSON.parse(saved) : [];
            });

            const [isAddingItem, setIsAddingItem] = useState(false);
            const [isCameraOpen, setIsCameraOpen] = useState(false);
            const [cameraStream, setCameraStream] = useState(null);
            const [capturedImage, setCapturedImage] = useState(null);
            const [ocrResult, setOcrResult] = useState(null);
            const [isBarcodeMode, setIsBarcodeMode] = useState(false);
            const [scannedBarcode, setScannedBarcode] = useState(null);
            const [pendingReceipt, setPendingReceipt] = useState(null); // 確認待ちのレシート
            const [newItem, setNewItem] = useState({
                name: '',
                price: '',
                quantity: '1',
                category: '',
            });

            // カメラを開く
            const openCamera = async (mode = 'receipt') => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    setCameraStream(stream);
                    setIsCameraOpen(true);
                    setIsBarcodeMode(mode === 'barcode');
                } catch (error) {
                    alert('カメラにアクセスできません。ブラウザの設定を確認してください。');
                }
            };

            // バーコードスキャン
            const scanBarcode = () => {
                setIsBarcodeMode(true);
                openCamera('barcode');
            };

            // カメラを閉じる
            const closeCamera = () => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    setCameraStream(null);
                }
                setIsCameraOpen(false);
                setIsBarcodeMode(false);
                setCapturedImage(null);
                setOcrResult(null);
                setScannedBarcode(null);
            };

            // 写真を撮影
            const capturePhoto = () => {
                const video = document.getElementById('camera-video');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg');
                setCapturedImage(imageData);
                closeCamera();
                
                if (isBarcodeMode) {
                    // バーコードスキャンのシミュレーション
                    setTimeout(() => {
                        const mockBarcode = '4901234567890';
                        setScannedBarcode({
                            code: mockBarcode,
                            product: 'サンプル商品',
                            price: 298
                        });
                    }, 1000);
                } else {
                    // OCR処理をシミュレート（実際のOCR APIに置き換え可能）
                    setTimeout(() => {
                        // ランダムな店舗と商品を生成
                        const stores = ['イオン 新宿店', 'セブンイレブン', 'ファミリーマート', 'ローソン', 'マツキヨ', 'ココカラファイン', 'ドラッグストアモリ', 'スーパーオーケー'];
                        const products = [
                            { name: '牛乳', price: 198, category: '乳製品' },
                            { name: 'パン', price: 298, category: 'パン' },
                            { name: '卵', price: 298, category: '乳製品' },
                            { name: '米', price: 1980, category: '主食' },
                            { name: '野菜セット', price: 398, category: '野菜' },
                            { name: '肉', price: 598, category: '肉類' },
                            { name: '魚', price: 498, category: '魚類' },
                            { name: '調味料', price: 198, category: '調味料' }
                        ];
                        
                        const randomStore = stores[Math.floor(Math.random() * stores.length)];
                        const randomItems = [];
                        const itemCount = Math.floor(Math.random() * 3) + 1; // 1-3個の商品
                        
                        for (let i = 0; i < itemCount; i++) {
                            const product = products[Math.floor(Math.random() * products.length)];
                            randomItems.push({
                                ...product,
                                quantity: Math.floor(Math.random() * 2) + 1 // 1-2個
                            });
                        }
                        
                        const totalAmount = randomItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                        
                        setOcrResult({
                            store: randomStore,
                            items: randomItems,
                            totalAmount: totalAmount
                        });
                    }, 2000);
                }
            };

            // OCR結果を確認画面に表示
            const showOcrResult = () => {
                if (ocrResult) {
                    const newReceipt = {
                        id: Date.now().toString(),
                        store: ocrResult.store,
                        totalAmount: ocrResult.totalAmount,
                        items: ocrResult.items,
                        date: new Date().toISOString().split('T')[0],
                    };
                    setPendingReceipt(newReceipt);
                    setOcrResult(null);
                }
            };

            // 確認後にレシートを保存
            const confirmReceipt = () => {
                if (pendingReceipt) {
                    const updatedReceipts = [pendingReceipt, ...receipts];
                    setReceipts(updatedReceipts);
                    localStorage.setItem('receipts', JSON.stringify(updatedReceipts));
                    
                    // 家計簿に自動で記入
                    addToAccounting(pendingReceipt);
                    
                    setPendingReceipt(null);
                    setCapturedImage(null);
                    alert(`レシートが保存されました！\n家計簿にも自動で記録されました。\n合計金額: ¥${pendingReceipt.totalAmount.toLocaleString()}`);
                }
            };

            // 確認をキャンセル
            const cancelReceipt = () => {
                setPendingReceipt(null);
                setCapturedImage(null);
            };

            // 家計簿に自動で記入
            const addToAccounting = (receipt) => {
                // 既存の家計簿データを取得
                const existingRecords = JSON.parse(localStorage.getItem('accounting-records') || '[]');
                
                // レシートの各商品を家計簿に追加
                const newRecords = receipt.items.map(item => ({
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    amount: item.price * item.quantity,
                    category: item.category || '食費',
                    description: `${receipt.store} - ${item.name}`,
                    date: receipt.date,
                    type: 'expense',
                    receiptId: receipt.id,
                    itemId: item.id
                }));
                
                // 新しいレコードを追加
                const updatedRecords = [...newRecords, ...existingRecords];
                localStorage.setItem('accounting-records', JSON.stringify(updatedRecords));
                
                // 店舗情報を店舗管理に自動追加
                addStoreToManagement(receipt.store);
                
                // 店舗の商品と価格を登録
                addStoreProducts(receipt);
                
                alert(`${receipt.items.length}件の商品を家計簿に追加し、店舗情報と商品価格も保存しました！`);
            };

            // 店舗情報を店舗管理に自動追加
            const addStoreToManagement = (storeName) => {
                try {
                    // 既存の店舗データを取得
                    const existingStores = JSON.parse(localStorage.getItem('stores') || '[]');
                    
                    // 同じ店舗名が既に存在するかチェック
                    const storeExists = existingStores.some(store => store.name === storeName);
                    
                    if (!storeExists) {
                        const newStore = {
                            id: Date.now().toString(),
                            name: storeName,
                            address: '住所未設定',
                            phone: '電話番号未設定',
                            category: 'その他',
                            notes: 'レシートから自動追加',
                            visitCount: 1,
                            lastVisit: new Date().toISOString().split('T')[0]
                        };
                        
                        const updatedStores = [newStore, ...existingStores];
                        localStorage.setItem('stores', JSON.stringify(updatedStores));
                        console.log(`店舗「${storeName}」を店舗管理に追加しました`);
                    } else {
                        // 既存の店舗の訪問回数を更新
                        const updatedStores = existingStores.map(store => 
                            store.name === storeName 
                                ? { 
                                    ...store, 
                                    visitCount: (store.visitCount || 0) + 1,
                                    lastVisit: new Date().toISOString().split('T')[0]
                                  }
                                : store
                        );
                        localStorage.setItem('stores', JSON.stringify(updatedStores));
                        console.log(`店舗「${storeName}」の訪問回数を更新しました`);
                    }
                } catch (error) {
                    console.error('店舗情報の保存エラー:', error);
                }
            };

            // 店舗の商品と価格を登録
            const addStoreProducts = (receipt) => {
                try {
                    // 既存の商品データを取得
                    const existingProducts = JSON.parse(localStorage.getItem('store-products') || '[]');
                    
                    // レシートの各商品を商品データベースに追加
                    const newProducts = receipt.items.map(item => ({
                        id: `product_${receipt.store}_${item.name}_${Date.now()}`,
                        name: item.name,
                        price: item.price,
                        category: item.category || 'その他',
                        store: receipt.store,
                        lastPurchased: receipt.date,
                        purchaseCount: 1,
                        averagePrice: item.price,
                        minPrice: item.price,
                        maxPrice: item.price
                    }));
                    
                    // 既存の商品と統合（同じ商品名の場合は価格情報を更新）
                    const updatedProducts = [...existingProducts];
                    
                    newProducts.forEach(newProduct => {
                        const existingIndex = updatedProducts.findIndex(
                            p => p.name === newProduct.name && p.store === newProduct.store
                        );
                        
                        if (existingIndex >= 0) {
                            // 既存商品の情報を更新
                            const existing = updatedProducts[existingIndex];
                            const newPurchaseCount = existing.purchaseCount + 1;
                            const newAveragePrice = Math.round(
                                (existing.averagePrice * existing.purchaseCount + newProduct.price) / newPurchaseCount
                            );
                            
                            updatedProducts[existingIndex] = {
                                ...existing,
                                lastPurchased: newProduct.lastPurchased,
                                purchaseCount: newPurchaseCount,
                                averagePrice: newAveragePrice,
                                minPrice: Math.min(existing.minPrice, newProduct.price),
                                maxPrice: Math.max(existing.maxPrice, newProduct.price)
                            };
                        } else {
                            // 新規商品を追加
                            updatedProducts.push(newProduct);
                        }
                    });
                    
                    localStorage.setItem('store-products', JSON.stringify(updatedProducts));
                    console.log(`${receipt.items.length}件の商品を商品データベースに登録しました`);
                    
                } catch (error) {
                    console.error('商品登録エラー:', error);
                }
            };

            const handleAddItem = () => {
                if (newItem.name && newItem.price) {
                    const item = {
                        id: Date.now().toString(),
                        name: newItem.name,
                        price: Number(newItem.price),
                        quantity: Number(newItem.quantity),
                        category: newItem.category || 'その他',
                    };
                    
                    const updatedReceipts = receipts.map(receipt => 
                        receipt.id === '1' 
                            ? { ...receipt, items: [...receipt.items, item] }
                            : receipt
                    );
                    
                    setReceipts(updatedReceipts);
                    localStorage.setItem('receipts', JSON.stringify(updatedReceipts));
                    
                    setNewItem({ name: '', price: '', quantity: '1', category: '' });
                    setIsAddingItem(false);
                }
            };

            const handleDeleteItem = (receiptId, itemId) => {
                const updatedReceipts = receipts.map(receipt => 
                    receipt.id === receiptId 
                        ? { ...receipt, items: receipt.items.filter(item => item.id !== itemId) }
                        : receipt
                );
                setReceipts(updatedReceipts);
                localStorage.setItem('receipts', JSON.stringify(updatedReceipts));
            };

            return h('div', { className: 'p-4 space-y-6 pb-24' },
                h('div', { className: 'text-center py-6' },
                    h('h1', { className: 'text-2xl font-bold text-gray-900 mb-2' }, 'レシート管理'),
                    h('p', { className: 'text-gray-600' }, 'レシートを撮影して商品を管理しましょう')
                ),
                
                // カメラ撮影ボタン
                h('div', { className: 'text-center space-y-4' },
                    h('div', { className: 'flex space-x-4 justify-center' },
                        h('button', {
                            onClick: () => openCamera('receipt'),
                            className: 'btn-primary inline-flex items-center space-x-2'
                        },
                            h(Camera, { className: 'w-5 h-5' }),
                            h('span', null, 'レシートを撮影')
                        ),
                        h('button', {
                            onClick: scanBarcode,
                            className: 'btn-secondary inline-flex items-center space-x-2'
                        },
                            h('div', { className: 'w-5 h-5' }, '📊'),
                            h('span', null, 'バーコードスキャン')
                        )
                    )
                ),

                // カメラ画面
                isCameraOpen && h('div', { className: 'fixed inset-0 bg-black z-50 flex flex-col' },
                    h('div', { className: 'flex-1 relative' },
                        h('video', {
                            id: 'camera-video',
                            autoPlay: true,
                            playsInline: true,
                            ref: (video) => {
                                if (video && cameraStream) {
                                    video.srcObject = cameraStream;
                                }
                            },
                            className: 'w-full h-full object-cover'
                        }),
                        h('div', { className: 'absolute top-4 right-4' },
                            h('button', {
                                onClick: closeCamera,
                                className: 'bg-red-500 text-white p-2 rounded-full'
                            }, '×')
                        ),
                        // バーコードスキャン用の長方形ガイド
                        isBarcodeMode && h('div', { className: 'absolute inset-0 flex items-center justify-center' },
                            h('div', { className: 'relative' },
                                h('div', { 
                                    className: 'w-64 h-32 border-2 border-white rounded-lg',
                                    style: { 
                                        boxShadow: '0 0 0 9999px rgba(0, 0, 0, 0.5)',
                                        position: 'relative'
                                    }
                                }),
                                h('div', { className: 'absolute -top-8 left-0 right-0 text-center text-white text-sm' },
                                    'バーコードを枠内に合わせてください'
                                )
                            )
                        )
                    ),
                    h('div', { className: 'bg-black p-4 flex justify-center' },
                        h('button', {
                            onClick: capturePhoto,
                            className: 'bg-white text-black px-6 py-3 rounded-full font-medium'
                        }, '撮影')
                    )
                ),

                // 撮影した画像とOCR結果
                capturedImage && h('div', { className: 'card' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, 
                        isBarcodeMode ? 'バーコードスキャン結果' : '撮影したレシート'
                    ),
                    h('img', {
                        src: capturedImage,
                        alt: isBarcodeMode ? 'Scanned barcode' : 'Captured receipt',
                        className: 'w-full rounded-lg mb-4'
                    }),
                    isBarcodeMode ? (
                        scannedBarcode ? h('div', { className: 'space-y-4' },
                            h('div', { className: 'bg-blue-50 p-4 rounded-lg' },
                                h('h4', { className: 'font-medium text-blue-800 mb-2' }, 'バーコード認識結果'),
                                h('p', { className: 'text-blue-700' }, `商品コード: ${scannedBarcode.code}`),
                                h('p', { className: 'text-blue-700' }, `商品名: ${scannedBarcode.product}`),
                                h('p', { className: 'text-blue-700' }, `価格: ¥${scannedBarcode.price.toLocaleString()}`)
                            ),
                            h('div', { className: 'flex space-x-2' },
                                h('button', {
                                    onClick: () => {
                                        // バーコード結果を商品として追加
                                        const newItem = {
                                            id: Date.now().toString(),
                                            name: scannedBarcode.product,
                                            price: scannedBarcode.price,
                                            quantity: 1,
                                            category: 'その他',
                                            barcode: scannedBarcode.code
                                        };
                                        setReceipts(prev => prev.map(receipt => 
                                            receipt.id === '1' 
                                                ? { ...receipt, items: [...receipt.items, newItem] }
                                                : receipt
                                        ));
                                        setScannedBarcode(null);
                                        setCapturedImage(null);
                                    },
                                    className: 'btn-primary flex-1'
                                }, '商品を追加'),
                                h('button', {
                                    onClick: () => setScannedBarcode(null),
                                    className: 'btn-secondary flex-1'
                                }, 'キャンセル')
                            )
                        ) : h('div', { className: 'text-center py-4' },
                            h('div', { className: 'animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto' }),
                            h('p', { className: 'text-gray-600 mt-2' }, 'バーコードを認識中...')
                        )
                    ) : (
                        ocrResult ? h('div', { className: 'space-y-4' },
                            h('div', { className: 'bg-green-50 p-4 rounded-lg' },
                                h('h4', { className: 'font-medium text-green-800 mb-2' }, 'OCR認識結果'),
                                h('p', { className: 'text-green-700' }, `店舗: ${ocrResult.store}`),
                                h('p', { className: 'text-green-700' }, `合計: ¥${ocrResult.totalAmount.toLocaleString()}`)
                            ),
                            h('div', { className: 'flex space-x-2' },
                                h('button', {
                                    onClick: showOcrResult,
                                    className: 'btn-primary flex-1'
                                }, '詳細確認'),
                                h('button', {
                                    onClick: () => setOcrResult(null),
                                    className: 'btn-secondary flex-1'
                                }, 'キャンセル')
                            )
                        ) : h('div', { className: 'text-center py-4' },
                            h('div', { className: 'animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto' }),
                            h('p', { className: 'text-gray-600 mt-2' }, '文字を認識中...')
                        )
                    )
                ),

                // 確認待ちのレシート
                pendingReceipt && h('div', { className: 'card bg-blue-50 border-blue-200' },
                    h('div', { className: 'text-center mb-4' },
                        h('h3', { className: 'text-lg font-semibold text-blue-900 mb-2' }, 'レシート情報の確認'),
                        h('p', { className: 'text-blue-700' }, '以下の情報で家計簿に登録しますか？')
                    ),
                    
                    // 店舗情報
                    h('div', { className: 'mb-4' },
                        h('h4', { className: 'font-medium text-gray-900 mb-2' }, '店舗情報'),
                        h('div', { className: 'bg-white p-3 rounded-lg border' },
                            h('p', { className: 'text-gray-700' }, `店舗名: ${pendingReceipt.store}`),
                            h('p', { className: 'text-gray-700' }, `日付: ${pendingReceipt.date}`),
                            h('p', { className: 'text-lg font-bold text-gray-900' }, `合計金額: ¥${pendingReceipt.totalAmount.toLocaleString()}`)
                        )
                    ),
                    
                    // 商品一覧
                    h('div', { className: 'mb-4' },
                        h('h4', { className: 'font-medium text-gray-900 mb-2' }, '商品一覧'),
                        h('div', { className: 'space-y-2' },
                            ...pendingReceipt.items.map((item, index) =>
                                h('div', { key: index, className: 'bg-white p-3 rounded-lg border flex justify-between items-center' },
                                    h('div', { className: 'flex-1' },
                                        h('p', { className: 'font-medium text-gray-900' }, item.name),
                                        h('p', { className: 'text-sm text-gray-600' }, `${item.category} × ${item.quantity}個`)
                                    ),
                                    h('p', { className: 'font-bold text-gray-900' }, `¥${(item.price * item.quantity).toLocaleString()}`)
                                )
                            )
                        )
                    ),
                    
                    // ボタン
                    h('div', { className: 'flex space-x-3' },
                        h('button', {
                            onClick: confirmReceipt,
                            className: 'flex-1 btn-primary'
                        }, '家計簿に登録'),
                        h('button', {
                            onClick: cancelReceipt,
                            className: 'flex-1 btn-secondary'
                        }, 'キャンセル')
                    )
                ),

                h('div', { className: 'space-y-4' },
                    ...receipts.map((receipt) =>
                        h('div', { key: receipt.id, className: 'card' },
                            h('div', { className: 'flex justify-between items-start mb-4' },
                                h('div', null,
                                    h('h3', { className: 'font-semibold text-gray-900' }, receipt.store),
                                    h('p', { className: 'text-sm text-gray-600' }, receipt.date)
                                ),
                                h('div', { className: 'text-right' },
                                    h('p', { className: 'text-lg font-bold text-gray-900' }, `¥${receipt.totalAmount.toLocaleString()}`)
                                )
                            ),
                            h('div', { className: 'space-y-2' },
                                ...receipt.items.map((item) =>
                                    h('div', { key: item.id, className: 'flex justify-between items-center py-2 px-3 bg-gray-50 rounded-lg' },
                                        h('div', { className: 'flex-1' },
                                            h('p', { className: 'font-medium text-gray-900' }, item.name),
                                            h('p', { className: 'text-sm text-gray-600' }, `${item.quantity}個 × ¥${item.price} = ¥${(item.price * item.quantity).toLocaleString()}`)
                                        ),
                                        h('div', { className: 'flex items-center space-x-2' },
                                            h('span', { className: 'text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded' }, item.category),
                                            h('button', {
                                                onClick: () => handleDeleteItem(receipt.id, item.id),
                                                className: 'p-1 text-red-600 hover:bg-red-100 rounded'
                                            }, '×')
                                        )
                                    )
                                )
                            ),
                            isAddingItem ? h('div', { className: 'mt-4 p-4 bg-gray-50 rounded-lg space-y-3' },
                                h('div', { className: 'grid grid-cols-2 gap-3' },
                                    h('input', {
                                        type: 'text',
                                        placeholder: '商品名',
                                        value: newItem.name,
                                        onChange: (e) => setNewItem({ ...newItem, name: e.target.value }),
                                        className: 'input-field'
                                    }),
                                    h('input', {
                                        type: 'number',
                                        placeholder: '価格',
                                        value: newItem.price,
                                        onChange: (e) => setNewItem({ ...newItem, price: e.target.value }),
                                        className: 'input-field'
                                    })
                                ),
                                h('div', { className: 'grid grid-cols-2 gap-3' },
                                    h('input', {
                                        type: 'number',
                                        placeholder: '数量',
                                        value: newItem.quantity,
                                        onChange: (e) => setNewItem({ ...newItem, quantity: e.target.value }),
                                        className: 'input-field'
                                    }),
                                    h('input', {
                                        type: 'text',
                                        placeholder: 'カテゴリ',
                                        value: newItem.category,
                                        onChange: (e) => setNewItem({ ...newItem, category: e.target.value }),
                                        className: 'input-field'
                                    })
                                ),
                                h('div', { className: 'flex space-x-2' },
                                    h('button', {
                                        onClick: handleAddItem,
                                        className: 'btn-primary flex-1'
                                    }, '追加'),
                                    h('button', {
                                        onClick: () => setIsAddingItem(false),
                                        className: 'btn-secondary flex-1'
                                    }, 'キャンセル')
                                )
                            ) : h('button', {
                                onClick: () => setIsAddingItem(true),
                                className: 'w-full mt-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-500 hover:text-blue-600 transition-colors inline-flex items-center justify-center space-x-2'
                            },
                                h(Plus, { className: 'w-4 h-4' }),
                                h('span', null, '商品を追加')
                            )
                        )
                    )
                ),
            );
        };

        // 家計簿ページコンポーネント
        const AccountingPage = () => {
            const [records, setRecords] = useState(() => {
                const saved = localStorage.getItem('accounting-records');
                return saved ? JSON.parse(saved) : [];
            });

            const [isAddingRecord, setIsAddingRecord] = useState(false);
            const [showGraph, setShowGraph] = useState(false);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [monthlyBudget, setMonthlyBudget] = useState(() => {
                const saved = localStorage.getItem('monthlyBudget');
                return saved ? JSON.parse(saved) : null;
            });
            const [isSettingBudget, setIsSettingBudget] = useState(false);
            const [budgetInput, setBudgetInput] = useState('');
            const [newRecord, setNewRecord] = useState({
                amount: '',
                category: '',
                description: '',
                type: 'expense',
                date: new Date().toISOString().split('T')[0],
            });

            // カレンダー生成関数
            const generateCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                const calendar = [];
                const current = new Date(startDate);
                
                for (let i = 0; i < 42; i++) {
                    calendar.push(new Date(current));
                    current.setDate(current.getDate() + 1);
                }
                
                return calendar;
            };

            // 指定日の支出データを取得
            const getExpensesForDate = (date) => {
                const dateStr = date.toISOString().split('T')[0];
                return records.filter(record => 
                    record.date === dateStr && record.type === 'expense'
                );
            };

            // 指定日の収入データを取得
            const getIncomeForDate = (date) => {
                const dateStr = date.toISOString().split('T')[0];
                return records.filter(record => 
                    record.date === dateStr && record.type === 'income'
                );
            };

            // 月移動
            const changeMonth = (direction) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + direction);
                setCurrentDate(newDate);
            };

            // 予算設定
            const handleSetBudget = (budget) => {
                const budgetData = {
                    amount: Number(budget),
                    type: 'monthly',
                    setDate: new Date().toISOString()
                };
                setMonthlyBudget(budgetData);
                localStorage.setItem('monthlyBudget', JSON.stringify(budgetData));
                setIsSettingBudget(false);
            };

            // 現在の月のデータを計算
            const currentMonthRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === currentDate.getFullYear() && 
                       recordDate.getMonth() === currentDate.getMonth();
            });
            
            const totalIncome = currentMonthRecords.filter(record => record.type === 'income').reduce((sum, record) => sum + record.amount, 0);
            const totalExpense = currentMonthRecords.filter(record => record.type === 'expense').reduce((sum, record) => sum + record.amount, 0);
            
            // 予算に基づいた残高計算
            const calculateBudgetBalance = () => {
                if (!monthlyBudget) return totalIncome - totalExpense; // 予算未設定の場合は従来通り
                
                // 食費カテゴリの支出のみを計算
                const foodExpenses = currentMonthRecords
                    .filter(record => record.type === 'expense' && record.category === '食費')
                    .reduce((sum, record) => sum + record.amount, 0);
                
                return monthlyBudget.amount - foodExpenses;
            };
            
            const balance = calculateBudgetBalance();

            // 節約額計算
            const calculateSavings = () => {
                if (!monthlyBudget) return null;
                
                const budgetAmount = monthlyBudget.amount;
                const actualExpense = totalExpense;
                const savings = budgetAmount - actualExpense;
                
                return {
                    budget: budgetAmount,
                    actual: actualExpense,
                    savings: savings,
                    percentage: budgetAmount > 0 ? ((actualExpense / budgetAmount) * 100) : 0
                };
            };

            const handleAddRecord = () => {
                if (newRecord.amount && newRecord.category) {
                    const record = {
                        id: Date.now().toString(),
                        amount: Number(newRecord.amount),
                        category: newRecord.category,
                        description: `${newRecord.category} - ${new Date().toLocaleDateString()}`,
                        date: newRecord.date,
                        type: newRecord.type,
                    };
                    
                    const updatedRecords = [record, ...records];
                    setRecords(updatedRecords);
                    localStorage.setItem('accounting-records', JSON.stringify(updatedRecords));
                    
                    // フォームをリセット
                    setNewRecord({ 
                        amount: '', 
                        category: '', 
                        description: '', 
                        type: 'expense', 
                        date: new Date().toISOString().split('T')[0] 
                    });
                    
                    // フォームを閉じる
                    setIsAddingRecord(false);
                    
                    alert('記録が追加されました！');
                } else {
                    alert('金額とカテゴリを入力してください。');
                }
            };

            // カテゴリ別支出データ（現在の月）
            const categoryData = currentMonthRecords
                .filter(record => record.type === 'expense')
                .reduce((acc, record) => {
                    acc[record.category] = (acc[record.category] || 0) + record.amount;
                    return acc;
                }, {});

            const categoryEntries = Object.entries(categoryData).sort((a, b) => b[1] - a[1]);
            const maxAmount = Math.max(...categoryEntries.map(([, amount]) => amount));

            // グラフコンポーネント
            const CategoryGraph = () => {
                if (categoryEntries.length === 0) {
                    return h('div', { className: 'text-center py-8 text-gray-500' }, 'データがありません');
                }

                return h('div', { className: 'space-y-4' },
                    h('h4', { className: 'text-lg font-semibold text-gray-900' }, 'カテゴリ別支出'),
                    h('div', { className: 'space-y-3' },
                        ...categoryEntries.map(([category, amount]) => {
                            const percentage = (amount / maxAmount) * 100;
                            return h('div', { key: category, className: 'space-y-1' },
                                h('div', { className: 'flex justify-between items-center' },
                                    h('span', { className: 'text-sm font-medium text-gray-700' }, category),
                                    h('span', { className: 'text-sm font-bold text-gray-900' }, `¥${amount.toLocaleString()}`)
                                ),
                                h('div', { className: 'w-full bg-gray-200 rounded-full h-2' },
                                    h('div', {
                                        className: 'bg-blue-500 h-2 rounded-full transition-all duration-500',
                                        style: { width: `${percentage}%` }
                                    })
                                )
                            );
                        })
                    )
                );
            };

            const calendar = generateCalendar();
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];

            return h('div', { className: 'p-4 space-y-6 pb-24' },
                h('div', { className: 'text-center py-4' },
                    h('h1', { className: 'text-2xl font-bold text-gray-900 mb-2' }, '家計簿カレンダー'),
                    h('p', { className: 'text-gray-600' }, '日付別の収支を確認できます')
                ),
                
                // 予算設定・節約額表示
                h('div', { className: 'card mb-4' },
                    h('div', { className: 'flex items-center justify-between mb-4' },
                        h('h3', { className: 'text-lg font-semibold text-gray-900' }, '月間予算'),
                        h('button', {
                            onClick: () => {
                                setBudgetInput(monthlyBudget ? monthlyBudget.amount.toString() : '');
                                setIsSettingBudget(true);
                            },
                            className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm'
                        }, monthlyBudget ? '予算を変更' : '予算を設定')
                    ),
                    
                    // 予算・節約額表示
                    monthlyBudget ? (() => {
                        const savings = calculateSavings();
                        return h('div', { className: 'grid grid-cols-3 gap-4' },
                            h('div', { className: 'text-center p-3 bg-blue-50 rounded-lg' },
                                h('div', { className: 'text-sm text-blue-600 font-medium' }, '予算'),
                                h('div', { className: 'text-lg font-bold text-blue-700' }, `¥${savings.budget.toLocaleString()}`)
                            ),
                            h('div', { className: 'text-center p-3 bg-red-50 rounded-lg' },
                                h('div', { className: 'text-sm text-red-600 font-medium' }, '実績'),
                                h('div', { className: 'text-lg font-bold text-red-700' }, `¥${savings.actual.toLocaleString()}`)
                            ),
                            h('div', { className: `text-center p-3 rounded-lg ${savings.savings >= 0 ? 'bg-green-50' : 'bg-orange-50'}` },
                                h('div', { className: `text-sm font-medium ${savings.savings >= 0 ? 'text-green-600' : 'text-orange-600'}` }, 
                                    savings.savings >= 0 ? '節約額' : '超過額'
                                ),
                                h('div', { className: `text-lg font-bold ${savings.savings >= 0 ? 'text-green-700' : 'text-orange-700'}` }, 
                                    `¥${Math.abs(savings.savings).toLocaleString()}`
                                )
                            )
                        );
                    })() : h('div', { className: 'text-center py-4 text-gray-500' }, '予算が設定されていません')
                ),
                
                // カレンダーヘッダー
                h('div', { className: 'card' },
                    h('div', { className: 'flex items-center justify-between mb-4' },
                        h('button', {
                            onClick: () => changeMonth(-1),
                            className: 'p-2 rounded-lg hover:bg-gray-100 transition-colors'
                        }, h(ChevronLeft, { className: 'w-5 h-5' })),
                        h('h2', { className: 'text-xl font-bold text-gray-900' }, 
                            `${currentDate.getFullYear()}年${monthNames[currentDate.getMonth()]}`
                        ),
                        h('button', {
                            onClick: () => changeMonth(1),
                            className: 'p-2 rounded-lg hover:bg-gray-100 transition-colors'
                        }, h(ChevronRight, { className: 'w-5 h-5' }))
                    ),
                    
                    // 曜日ヘッダー
                    h('div', { className: 'grid grid-cols-7 gap-1 mb-2' },
                        ...dayNames.map(day => 
                            h('div', { 
                                key: day, 
                                className: 'text-center text-sm font-medium text-gray-600 py-2' 
                            }, day)
                        )
                    ),
                    
                    // カレンダーグリッド
                    h('div', { className: 'grid grid-cols-7 gap-1' },
                        ...calendar.map((date, index) => {
                            const isCurrentMonth = date.getMonth() === currentDate.getMonth();
                            const isToday = date.toDateString() === new Date().toDateString();
                            const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();
                            
                            const expenses = getExpensesForDate(date);
                            const income = getIncomeForDate(date);
                            const totalExpense = expenses.reduce((sum, record) => sum + record.amount, 0);
                            const dailyIncome = income.reduce((sum, record) => sum + record.amount, 0);
                            
                            return h('div', {
                                key: index,
                                onClick: () => setSelectedDate(date),
                                className: `p-2 min-h-[80px] border rounded-lg cursor-pointer transition-colors ${
                                    isCurrentMonth 
                                        ? isSelected 
                                            ? 'bg-blue-100 border-blue-300' 
                                            : isToday 
                                                ? 'bg-blue-50 border-blue-200' 
                                                : 'bg-white border-gray-200 hover:bg-gray-50'
                                        : 'bg-gray-50 border-gray-100 text-gray-400'
                                }`
                            },
                                h('div', { className: 'text-sm font-medium mb-1' }, date.getDate()),
                                totalExpense > 0 && h('div', { 
                                    className: 'text-xs text-red-600 font-medium' 
                                }, `-¥${totalExpense.toLocaleString()}`),
                                dailyIncome > 0 && h('div', { 
                                    className: 'text-xs text-green-600 font-medium' 
                                }, `+¥${dailyIncome.toLocaleString()}`),
                                expenses.length > 0 && h('div', { 
                                    className: 'text-xs text-gray-500 truncate' 
                                }, expenses[0].description)
                            );
                        })
                    )
                ),
                
                // 選択された日付の詳細
                selectedDate && h('div', { className: 'card' },
                    h('div', { className: 'flex items-center justify-between mb-4' },
                        h('h3', { className: 'text-lg font-semibold text-gray-900' }, 
                            `${selectedDate.getFullYear()}年${selectedDate.getMonth() + 1}月${selectedDate.getDate()}日 (${dayNames[selectedDate.getDay()]})`
                        ),
                        h('button', {
                            onClick: () => setSelectedDate(null),
                            className: 'text-gray-400 hover:text-gray-600'
                        }, '×')
                    ),
                    h('div', { className: 'space-y-4' },
                        // 収支サマリー
                        h('div', { className: 'grid grid-cols-2 gap-4' },
                            h('div', { className: 'text-center p-4 bg-red-50 rounded-lg' },
                                h('div', { className: 'text-sm text-red-600 font-medium' }, '支出'),
                                h('div', { className: 'text-xl font-bold text-red-700' }, 
                                    `¥${getExpensesForDate(selectedDate).reduce((sum, record) => sum + record.amount, 0).toLocaleString()}`
                                )
                            ),
                            h('div', { className: 'text-center p-4 bg-green-50 rounded-lg' },
                                h('div', { className: 'text-sm text-green-600 font-medium' }, '収入'),
                                h('div', { className: 'text-xl font-bold text-green-700' }, 
                                    `¥${getIncomeForDate(selectedDate).reduce((sum, record) => sum + record.amount, 0).toLocaleString()}`
                                )
                            )
                        ),
                        
                        // 支出詳細
                        getExpensesForDate(selectedDate).length > 0 && h('div', null,
                            h('h4', { className: 'text-md font-semibold text-gray-900 mb-3' }, '支出詳細'),
                            h('div', { className: 'space-y-2' },
                                ...getExpensesForDate(selectedDate).map(record => 
                                    h('div', { 
                                        key: record.id, 
                                        className: 'flex items-center justify-between p-3 bg-gray-50 rounded-lg' 
                                    },
                                        h('div', null,
                                            h('div', { className: 'font-medium text-gray-900' }, record.description),
                                            h('div', { className: 'text-sm text-gray-600' }, record.category)
                                        ),
                                        h('div', { className: 'text-right' },
                                            h('div', { className: 'font-bold text-red-600' }, `-¥${record.amount.toLocaleString()}`)
                                        )
                                    )
                                )
                            )
                        ),
                        
                        // 収入詳細
                        getIncomeForDate(selectedDate).length > 0 && h('div', null,
                            h('h4', { className: 'text-md font-semibold text-gray-900 mb-3' }, '収入詳細'),
                            h('div', { className: 'space-y-2' },
                                ...getIncomeForDate(selectedDate).map(record => 
                                    h('div', { 
                                        key: record.id, 
                                        className: 'flex items-center justify-between p-3 bg-gray-50 rounded-lg' 
                                    },
                                        h('div', null,
                                            h('div', { className: 'font-medium text-gray-900' }, record.description),
                                            h('div', { className: 'text-sm text-gray-600' }, record.category)
                                        ),
                                        h('div', { className: 'text-right' },
                                            h('div', { className: 'font-bold text-green-600' }, `+¥${record.amount.toLocaleString()}`)
                                        )
                                    )
                                )
                            )
                        ),
                        
                        // データがない場合
                        getExpensesForDate(selectedDate).length === 0 && getIncomeForDate(selectedDate).length === 0 && 
                        h('div', { className: 'text-center py-8 text-gray-500' }, 'この日のデータはありません')
                    )
                ),
                
                // 月間サマリー
                h('div', { className: 'space-y-4' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900' }, 
                        `${currentDate.getFullYear()}年${monthNames[currentDate.getMonth()]}のサマリー`
                    ),
                    h('div', { className: 'grid grid-cols-3 gap-4' },
                        h('div', { className: 'card text-center' },
                            h('div', { className: 'flex items-center justify-center mb-2' },
                                h(TrendingUp, { className: 'w-5 h-5 text-green-600' })
                            ),
                            h('p', { className: 'text-sm text-gray-600' }, '収入'),
                            h('p', { className: 'text-lg font-bold text-green-600' }, `¥${totalIncome.toLocaleString()}`)
                        ),
                    h('div', { className: 'card text-center' },
                        h('div', { className: 'flex items-center justify-center mb-2' },
                            h(TrendingUp, { className: 'w-5 h-5 text-red-600' })
                        ),
                        h('p', { className: 'text-sm text-gray-600' }, '支出'),
                        h('p', { className: 'text-lg font-bold text-red-600' }, `¥${totalExpense.toLocaleString()}`)
                    ),
                    h('div', { className: 'card text-center' },
                        h('div', { className: 'flex items-center justify-center mb-2' },
                            h(Calculator, { className: 'w-5 h-5 text-blue-600' })
                        ),
                        h('p', { className: 'text-sm text-gray-600' }, monthlyBudget ? '食費予算残高' : '残高'),
                        h('p', { className: `text-lg font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}` }, `¥${balance.toLocaleString()}`)
                        )
                    )
                ),
                
                // 予算設定モーダル
                isSettingBudget && h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50' },
                    h('div', { className: 'bg-white rounded-lg p-6 w-full max-w-md mx-4' },
                        h('div', { className: 'flex items-center justify-between mb-4' },
                            h('h2', { className: 'text-xl font-bold text-gray-900' }, '月間予算設定'),
                            h('button', {
                                onClick: () => setIsSettingBudget(false),
                                className: 'text-gray-400 hover:text-gray-600'
                            }, '×')
                        ),
                        h('div', { className: 'space-y-4' },
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
                                    `${currentDate.getFullYear()}年${monthNames[currentDate.getMonth()]}の予算`
                                ),
                                h('input', {
                                    type: 'number',
                                    placeholder: '例: 100000',
                                    value: budgetInput,
                                    onChange: (e) => setBudgetInput(e.target.value),
                                    className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                })
                            ),
                            h('div', { className: 'text-sm text-gray-600' },
                                h('p', null, '• 月間の生活費予算を設定してください'),
                                h('p', null, '• 実績と比較して節約額を計算します'),
                                h('p', null, '• 予算を超えた場合は超過額として表示されます')
                            ),
                            h('div', { className: 'flex space-x-3 pt-4' },
                                h('button', {
                                    onClick: () => setIsSettingBudget(false),
                                    className: 'btn-secondary flex-1'
                                }, 'キャンセル'),
                                h('button', {
                                    onClick: () => {
                                        if (budgetInput && Number(budgetInput) > 0) {
                                            handleSetBudget(budgetInput);
                                            setBudgetInput('');
                                        } else {
                                            alert('有効な金額を入力してください。');
                                        }
                                    },
                                    className: 'btn-primary flex-1'
                                }, '設定')
                            )
                        )
                    )
                ),
                
                h('div', { className: 'flex space-x-3 justify-center' },
                    h('button', {
                        onClick: () => setIsAddingRecord(!isAddingRecord),
                        className: `inline-flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-colors ${
                            isAddingRecord 
                                ? 'bg-gray-500 text-white hover:bg-gray-600' 
                                : 'bg-blue-600 text-white hover:bg-blue-700'
                        }`
                    },
                        h(Plus, { className: 'w-5 h-5' }),
                        h('span', null, isAddingRecord ? 'フォームを閉じる' : '記録を追加')
                    ),
                    h('button', {
                        onClick: () => setShowGraph(!showGraph),
                        className: `inline-flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-colors ${
                            showGraph 
                                ? 'bg-blue-100 text-blue-800 border border-blue-300' 
                                : 'bg-gray-100 text-gray-700 border border-gray-300 hover:bg-gray-200'
                        }`
                    },
                        h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z' })
                        ),
                        h('span', null, showGraph ? 'グラフを隠す' : 'グラフを表示')
                    )
                ),
                isAddingRecord && h('div', { className: 'card' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, '新しい記録'),
                    h('div', { className: 'space-y-4' },
                        h('div', null,
                            h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '種類'),
                            h('div', { className: 'flex space-x-4' },
                                h('label', { className: 'flex items-center' },
                                    h('input', {
                                        type: 'radio',
                                        name: 'type',
                                        value: 'income',
                                        checked: newRecord.type === 'income',
                                        onChange: (e) => setNewRecord({ ...newRecord, type: e.target.value }),
                                        className: 'mr-2'
                                    }),
                                    h('span', { className: 'text-green-600' }, '収入')
                                ),
                                h('label', { className: 'flex items-center' },
                                    h('input', {
                                        type: 'radio',
                                        name: 'type',
                                        value: 'expense',
                                        checked: newRecord.type === 'expense',
                                        onChange: (e) => setNewRecord({ ...newRecord, type: e.target.value }),
                                        className: 'mr-2'
                                    }),
                                    h('span', { className: 'text-red-600' }, '支出')
                                )
                            )
                        ),
                        h('div', { className: 'grid grid-cols-2 gap-4' },
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '金額'),
                                h('input', {
                                    type: 'number',
                                    value: newRecord.amount,
                                    onChange: (e) => setNewRecord({ ...newRecord, amount: e.target.value }),
                                    className: 'input-field',
                                    placeholder: '金額を入力',
                                    min: '1',
                                    step: '1'
                                })
                            ),
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'カテゴリ'),
                                h('select', {
                                    value: newRecord.category,
                                    onChange: (e) => setNewRecord({ ...newRecord, category: e.target.value }),
                                    className: 'input-field'
                                },
                                    h('option', { value: '' }, 'カテゴリを選択'),
                                    h('option', { value: '食費' }, '食費'),
                                    h('option', { value: '日用品' }, '日用品'),
                                    h('option', { value: '交通費' }, '交通費'),
                                    h('option', { value: '光熱費' }, '光熱費'),
                                    h('option', { value: '通信費' }, '通信費'),
                                    h('option', { value: '医療費' }, '医療費'),
                                    h('option', { value: '教育費' }, '教育費'),
                                    h('option', { value: '娯楽費' }, '娯楽費'),
                                    h('option', { value: '衣類' }, '衣類'),
                                    h('option', { value: '美容・健康' }, '美容・健康'),
                                    h('option', { value: '住居費' }, '住居費'),
                                    h('option', { value: '保険料' }, '保険料'),
                                    h('option', { value: '税金' }, '税金'),
                                    h('option', { value: 'その他' }, 'その他')
                                )
                            )
                        ),
                        h('div', { className: 'flex space-x-2' },
                            h('button', {
                                onClick: handleAddRecord,
                                className: 'btn-primary flex-1'
                            }, '追加'),
                            h('button', {
                                onClick: () => setIsAddingRecord(false),
                                className: 'btn-secondary flex-1'
                            }, 'キャンセル')
                        )
                    )
                ),
                showGraph && h('div', { className: 'card' },
                    h(CategoryGraph)
                ),
                h('div', { className: 'space-y-3' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900' }, '最近の記録'),
                    ...records.map((record) =>
                        h('div', { key: record.id, className: 'card' },
                            h('div', { className: 'flex justify-between items-start' },
                                h('div', { className: 'flex-1' },
                                    h('div', { className: 'flex items-center space-x-2 mb-1' },
                                        h('span', { className: `text-xs px-2 py-1 rounded ${record.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}` }, record.type === 'income' ? '収入' : '支出'),
                                        h('span', { className: 'text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded' }, record.category)
                                    ),
                                    h('p', { className: 'font-medium text-gray-900' }, record.description),
                                    h('p', { className: 'text-sm text-gray-600' }, record.date)
                                ),
                                h('div', { className: 'text-right' },
                                    h('p', { className: `text-lg font-bold ${record.type === 'income' ? 'text-green-600' : 'text-red-600'}` }, `${record.type === 'income' ? '+' : '-'}¥${record.amount.toLocaleString()}`)
                                )
                            )
                        )
                    )
                )
            );
        };

        // メニューページコンポーネント
        const MenuPage = () => {
            const [menus, setMenus] = useState(() => {
                const saved = localStorage.getItem('menus');
                return saved ? JSON.parse(saved) : [];
            });

            const [isAddingMenu, setIsAddingMenu] = useState(false);
            const [newMenu, setNewMenu] = useState({
                name: '',
                description: '',
                ingredients: '',
                prepTime: '',
                servings: '',
                difficulty: 'easy',
                tags: '',
            });

            const handleAddMenu = () => {
                if (newMenu.name && newMenu.description) {
                    // 重複チェック：同じ名前のメニューが既に存在するか確認
                    const isDuplicate = menus.some(menu => 
                        menu.name.toLowerCase().trim() === newMenu.name.toLowerCase().trim()
                    );
                    
                    if (isDuplicate) {
                        alert('同じ名前のメニューが既に登録されています。別の名前を入力してください。');
                        return;
                    }
                    
                    const menu = {
                        id: Date.now().toString(),
                        name: newMenu.name,
                        description: newMenu.description,
                        ingredients: newMenu.ingredients.split(',').map(item => item.trim()).filter(item => item),
                        prepTime: Number(newMenu.prepTime) || 30,
                        servings: Number(newMenu.servings) || 4,
                        difficulty: newMenu.difficulty,
                        tags: newMenu.tags.split(',').map(item => item.trim()).filter(item => item),
                    };
                    
                    const updatedMenus = [menu, ...menus];
                    setMenus(updatedMenus);
                    localStorage.setItem('menus', JSON.stringify(updatedMenus));
                    setNewMenu({
                        name: '',
                        description: '',
                        ingredients: '',
                        prepTime: '',
                        servings: '',
                        difficulty: 'easy',
                        tags: '',
                    });
                    setIsAddingMenu(false);
                }
            };

            const getDifficultyColor = (difficulty) => {
                switch (difficulty) {
                    case 'easy': return 'bg-green-100 text-green-800';
                    case 'medium': return 'bg-yellow-100 text-yellow-800';
                    case 'hard': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            const getDifficultyText = (difficulty) => {
                switch (difficulty) {
                    case 'easy': return '簡単';
                    case 'medium': return '普通';
                    case 'hard': return '難しい';
                    default: return '不明';
                }
            };

            return h('div', { className: 'p-4 space-y-6 pb-24' },
                h('div', { className: 'text-center py-6' },
                    h('h1', { className: 'text-2xl font-bold text-gray-900 mb-2' }, 'メニュー管理'),
                    h('p', { className: 'text-gray-600' }, 'お気に入りのレシピを管理しましょう')
                ),
                h('div', { className: 'text-center' },
                    h('button', {
                        onClick: () => setIsAddingMenu(true),
                        className: 'btn-primary inline-flex items-center space-x-2'
                    },
                        h(Plus, { className: 'w-5 h-5' }),
                        h('span', null, 'メニューを追加')
                    )
                ),
                isAddingMenu && h('div', { className: 'card' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, '新しいメニュー'),
                    h('div', { className: 'space-y-4' },
                        h('div', { className: 'grid grid-cols-2 gap-4' },
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'メニュー名'),
                                h('input', {
                                    type: 'text',
                                    value: newMenu.name,
                                    onChange: (e) => setNewMenu({ ...newMenu, name: e.target.value }),
                                    className: 'input-field',
                                    placeholder: 'カレーライス'
                                })
                            ),
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '難易度'),
                                h('select', {
                                    value: newMenu.difficulty,
                                    onChange: (e) => setNewMenu({ ...newMenu, difficulty: e.target.value }),
                                    className: 'input-field'
                                },
                                    h('option', { value: 'easy' }, '簡単'),
                                    h('option', { value: 'medium' }, '普通'),
                                    h('option', { value: 'hard' }, '難しい')
                                )
                            )
                        ),
                        h('div', null,
                            h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '説明'),
                            h('input', {
                                type: 'text',
                                value: newMenu.description,
                                onChange: (e) => setNewMenu({ ...newMenu, description: e.target.value }),
                                className: 'input-field',
                                placeholder: 'メニューの説明'
                            })
                        ),
                        h('div', { className: 'grid grid-cols-2 gap-4' },
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '調理時間（分）'),
                                h('input', {
                                    type: 'number',
                                    value: newMenu.prepTime,
                                    onChange: (e) => setNewMenu({ ...newMenu, prepTime: e.target.value }),
                                    className: 'input-field',
                                    placeholder: '30'
                                })
                            ),
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '人数'),
                                h('input', {
                                    type: 'number',
                                    value: newMenu.servings,
                                    onChange: (e) => setNewMenu({ ...newMenu, servings: e.target.value }),
                                    className: 'input-field',
                                    placeholder: '4'
                                })
                            )
                        ),
                        h('div', null,
                            h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '材料（カンマ区切り）'),
                            h('input', {
                                type: 'text',
                                value: newMenu.ingredients,
                                onChange: (e) => setNewMenu({ ...newMenu, ingredients: e.target.value }),
                                className: 'input-field',
                                placeholder: '玉ねぎ, にんじん, じゃがいも'
                            })
                        ),
                        h('div', null,
                            h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'タグ（カンマ区切り）'),
                            h('input', {
                                type: 'text',
                                value: newMenu.tags,
                                onChange: (e) => setNewMenu({ ...newMenu, tags: e.target.value }),
                                className: 'input-field',
                                placeholder: '和食, 定番, 簡単'
                            })
                        ),
                        h('div', { className: 'flex space-x-2' },
                            h('button', {
                                onClick: handleAddMenu,
                                className: 'btn-primary flex-1'
                            }, '追加'),
                            h('button', {
                                onClick: () => setIsAddingMenu(false),
                                className: 'btn-secondary flex-1'
                            }, 'キャンセル')
                        )
                    )
                ),
                h('div', { className: 'space-y-4' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900' }, 'メニュー'),
                    ...menus.map((menu) =>
                        h('div', { key: menu.id, className: 'card' },
                            h('div', { className: 'flex justify-between items-start mb-4' },
                                h('div', { className: 'flex-1' },
                                    h('div', { className: 'flex items-start space-x-4' },
                                        // レシピから追加されたメニューの場合は画像を表示
                                        menu.image && h('img', {
                                            src: menu.image,
                                            alt: menu.name,
                                            className: 'w-20 h-20 object-cover rounded-lg flex-shrink-0',
                                            onError: (e) => {
                                                e.target.style.display = 'none';
                                            }
                                        }),
                                        h('div', { className: 'flex-1' },
                                            h('h4', { className: 'text-lg font-semibold text-gray-900 mb-1' }, menu.name),
                                            h('p', { className: 'text-gray-600 mb-2' }, menu.description),
                                            h('div', { className: 'flex items-center space-x-4 text-sm text-gray-600' },
                                                h('span', null, `${menu.prepTime}分`),
                                                h('span', null, `${menu.servings}人分`),
                                                h('span', { className: `px-2 py-1 rounded text-xs ${getDifficultyColor(menu.difficulty)}` }, getDifficultyText(menu.difficulty)),
                                                menu.type === 'recipe' && h('span', { className: 'px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs' }, 'レシピ')
                                            )
                                        )
                                    )
                                )
                            ),
                            h('div', { className: 'mb-4' },
                                h('h5', { className: 'font-medium text-gray-900 mb-2' }, '材料'),
                                h('div', { className: 'flex flex-wrap gap-2' },
                                    ...menu.ingredients.map((ingredient, index) =>
                                        h('span', { key: index, className: 'px-2 py-1 bg-gray-100 text-gray-800 rounded text-sm' }, ingredient)
                                    )
                                )
                            ),
                            h('div', { className: 'flex flex-wrap gap-2' },
                                ...menu.tags.map((tag, index) =>
                                    h('span', { key: index, className: 'px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs' }, `#${tag}`)
                                )
                            )
                        )
                    )
                )
            );
        };

        // 設定ページコンポーネント
        const SettingsPage = ({ onPageChange }) => {
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('app-settings');
                return saved ? JSON.parse(saved) : {
                    darkMode: false,
                    fontSize: 'medium',
                    notifications: true,
                    autoSave: true
                };
            });
            const [showProfileModal, setShowProfileModal] = useState(false);
            const [showDataModal, setShowDataModal] = useState(false);
            const [monthlyBudget, setMonthlyBudget] = useState(() => {
                const saved = localStorage.getItem('monthlyBudget');
                return saved ? JSON.parse(saved) : null;
            });
            const [showBudgetModal, setShowBudgetModal] = useState(false);
            const [budget, setBudget] = useState('');
            const [budgetType, setBudgetType] = useState('monthly');

            const updateSetting = (key, value) => {
                const newSettings = { ...settings, [key]: value };
                setSettings(newSettings);
                localStorage.setItem('app-settings', JSON.stringify(newSettings));
                
                // ダークモードの適用
                if (key === 'darkMode') {
                    if (value) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }
                
                // フォントサイズの適用
                if (key === 'fontSize') {
                    document.body.className = document.body.className.replace(/text-(xs|sm|base|lg|xl|2xl)/g, '');
                    document.body.classList.add(`text-${value}`);
                }
            };

            // 初期設定の適用
            useEffect(() => {
                if (settings.darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                document.body.className = document.body.className.replace(/text-(xs|sm|base|lg|xl|2xl)/g, '');
                document.body.classList.add(`text-${settings.fontSize}`);
            }, []);

            const fontSizeOptions = [
                { value: 'xs', label: 'とても小さい' },
                { value: 'sm', label: '小さい' },
                { value: 'base', label: '標準' },
                { value: 'lg', label: '大きい' },
                { value: 'xl', label: 'とても大きい' },
                { value: '2xl', label: '特大' }
            ];

            // 食費予算の更新
            const updateBudget = (budgetData) => {
                setMonthlyBudget(budgetData);
                localStorage.setItem('monthlyBudget', JSON.stringify(budgetData));
                setShowBudgetModal(false);
                alert('食費予算が更新されました！');
            };

            return h('div', { className: 'p-4 space-y-6 pb-24' },
                h('div', { className: 'text-center py-6' },
                    h('h1', { className: 'text-2xl font-bold text-gray-900 mb-2' }, '設定'),
                    h('p', { className: 'text-gray-600' }, 'アプリの設定をカスタマイズしましょう')
                ),
                
                // 表示設定
                h('div', { className: 'space-y-4' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900' }, '表示設定'),
                    h('div', { className: 'card' },
                        h('div', { className: 'space-y-6' },
                            // ダークモード設定
                            h('div', { className: 'flex items-center justify-between' },
                                h('div', null,
                                    h('h4', { className: 'font-medium text-gray-900' }, 'ダークモード'),
                                    h('p', { className: 'text-sm text-gray-600' }, '暗いテーマに切り替えます')
                                ),
                                h('label', { className: 'relative inline-flex items-center cursor-pointer' },
                                    h('input', {
                                        type: 'checkbox',
                                        checked: settings.darkMode,
                                        onChange: (e) => updateSetting('darkMode', e.target.checked),
                                        className: 'sr-only peer'
                                    }),
                                    h('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600" })
                                )
                            ),
                            
                            // フォントサイズ設定
                            h('div', null,
                                h('h4', { className: 'font-medium text-gray-900 mb-3' }, '文字サイズ'),
                                h('div', { className: 'grid grid-cols-2 gap-2' },
                                    ...fontSizeOptions.map(option =>
                                        h('button', {
                                            key: option.value,
                                            onClick: () => updateSetting('fontSize', option.value),
                                            className: `px-3 py-2 rounded-lg text-sm border transition-colors ${
                                                settings.fontSize === option.value 
                                                    ? 'bg-blue-100 text-blue-800 border-blue-300' 
                                                    : 'bg-gray-50 text-gray-700 border-gray-300 hover:bg-gray-100'
                                            }`
                                        }, option.label)
                                    )
                                )
                            ),
                            
                            // 通知設定
                            h('div', { className: 'flex items-center justify-between' },
                                h('div', null,
                                    h('h4', { className: 'font-medium text-gray-900' }, 'プッシュ通知'),
                                    h('p', { className: 'text-sm text-gray-600' }, '重要な更新をお知らせします')
                                ),
                                h('label', { className: 'relative inline-flex items-center cursor-pointer' },
                                    h('input', {
                                        type: 'checkbox',
                                        checked: settings.notifications,
                                        onChange: (e) => updateSetting('notifications', e.target.checked),
                                        className: 'sr-only peer'
                                    }),
                                    h('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600" })
                                )
                            ),
                            
                            // 自動保存設定
                            h('div', { className: 'flex items-center justify-between' },
                                h('div', null,
                                    h('h4', { className: 'font-medium text-gray-900' }, '自動保存'),
                                    h('p', { className: 'text-sm text-gray-600' }, '入力中に自動でデータを保存します')
                                ),
                                h('label', { className: 'relative inline-flex items-center cursor-pointer' },
                                    h('input', {
                                        type: 'checkbox',
                                        checked: settings.autoSave,
                                        onChange: (e) => updateSetting('autoSave', e.target.checked),
                                        className: 'sr-only peer'
                                    }),
                                    h('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600" })
                                )
                            )
                        )
                    )
                ),

                // 食費予算設定
                h('div', { className: 'space-y-4' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900' }, '食費予算'),
                    h('div', { className: 'card' },
                        h('div', { className: 'space-y-4' },
                            h('div', { className: 'flex items-center space-x-3' },
                                h('div', { className: 'p-2 bg-green-100 rounded-lg' },
                                    h('div', { className: 'w-6 h-6 text-green-600' }, '💰')
                                ),
                                h('div', { className: 'flex-1' },
                                    h('h4', { className: 'font-medium text-gray-900' }, '月間食費予算'),
                                    h('p', { className: 'text-sm text-gray-600' }, 
                                        monthlyBudget 
                                            ? `${monthlyBudget.amount.toLocaleString()}円 (${monthlyBudget.type === 'monthly' ? '月間' : '週間'})`
                                            : '設定されていません'
                                    )
                                )
                            ),
                            h('div', { className: 'pt-2 border-t border-gray-200' },
                                h('button', {
                                    onClick: () => {
                                        if (monthlyBudget) {
                                            setBudget(monthlyBudget.amount.toString());
                                            setBudgetType(monthlyBudget.type);
                                        } else {
                                            setBudget('');
                                            setBudgetType('monthly');
                                        }
                                        setShowBudgetModal(true);
                                    },
                                    className: 'btn-primary w-full text-sm'
                                }, '予算を変更する')
                            )
                        )
                    )
                ),
                
                // 位置情報設定
                h('div', { className: 'space-y-4' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900' }, '位置情報'),
                    h('div', { className: 'card' },
                        h('div', { className: 'space-y-4' },
                            h('div', { className: 'flex items-center space-x-3' },
                                h('div', { className: 'p-2 bg-blue-100 rounded-lg' },
                                    h(MapPin, { className: 'w-5 h-5 text-blue-600' })
                                ),
                                h('div', { className: 'flex-1' },
                                    h('h4', { className: 'font-medium text-gray-900' }, '現在の位置情報'),
                                    h('p', { className: 'text-sm text-gray-600' }, 
                                        JSON.parse(localStorage.getItem('location') || '{}').address || '位置情報が設定されていません'
                                    )
                                )
                            ),
                            h('div', { className: 'pt-2 border-t border-gray-200' },
                                h('button', {
                                    onClick: () => {
                                        if (confirm('位置情報を再設定しますか？現在の位置情報が削除され、位置設定画面に戻ります。')) {
                                            localStorage.removeItem('location');
                                            localStorage.removeItem('locationSetupComplete');
                                            onPageChange('location-setup');
                                        }
                                    },
                                    className: 'btn-secondary w-full text-sm'
                                }, '位置情報を再設定')
                            )
                        )
                    )
                ),
                
                // その他の設定
                h('div', { className: 'space-y-4' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900' }, 'その他'),
                    h('div', { className: 'space-y-3' },
                        h('div', { className: 'card cursor-pointer hover:bg-gray-50 transition-colors', onClick: () => setShowProfileModal(true) },
                            h('div', { className: 'flex items-center space-x-4' },
                                h('div', { className: 'p-3 bg-gray-100 rounded-lg' },
                                    h(Home, { className: 'w-6 h-6 text-gray-600' })
                                ),
                                h('div', { className: 'flex-1' },
                                    h('h3', { className: 'font-medium text-gray-900' }, 'プロフィール'),
                                    h('p', { className: 'text-sm text-gray-600' }, 'アカウント情報を管理')
                                ),
                                h('div', { className: 'text-gray-400' },
                                    h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 5l7 7-7 7' })
                                    )
                                )
                            )
                        ),
                        h('div', { className: 'card cursor-pointer hover:bg-gray-50 transition-colors', onClick: () => setShowDataModal(true) },
                            h('div', { className: 'flex items-center space-x-4' },
                                h('div', { className: 'p-3 bg-gray-100 rounded-lg' },
                                    h(Settings, { className: 'w-6 h-6 text-gray-600' })
                                ),
                                h('div', { className: 'flex-1' },
                                    h('h3', { className: 'font-medium text-gray-900' }, 'データ管理'),
                                    h('p', { className: 'text-sm text-gray-600' }, 'データのエクスポート・インポート')
                                ),
                                h('div', { className: 'text-gray-400' },
                                    h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 5l7 7-7 7' })
                                    )
                                )
                            )
                        ),
                        h('div', { className: 'card cursor-pointer hover:bg-gray-50 transition-colors', onClick: () => {
                            if (confirm('位置情報を再設定しますか？現在の位置情報が削除され、位置設定画面に戻ります。')) {
                                localStorage.removeItem('location');
                                localStorage.removeItem('locationSetupComplete');
                                onPageChange('location-setup');
                            }
                        } },
                            h('div', { className: 'flex items-center space-x-4' },
                                h('div', { className: 'p-3 bg-gray-100 rounded-lg' },
                                    h(MapPin, { className: 'w-6 h-6 text-gray-600' })
                                ),
                                h('div', { className: 'flex-1' },
                                    h('h3', { className: 'font-medium text-gray-900' }, '位置情報の再設定'),
                                    h('p', { className: 'text-sm text-gray-600' }, '現在地や検索範囲を変更')
                                ),
                                h('div', { className: 'text-gray-400' },
                                    h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 5l7 7-7 7' })
                                    )
                                )
                            )
                        )
                    )
                ),

                // 食費予算設定モーダル
                showBudgetModal && h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4' },
                    h('div', { className: 'bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md' },
                        h('div', { className: 'text-center mb-6' },
                            h('h2', { className: 'text-xl font-bold text-gray-900 mb-2' }, '食費予算の設定'),
                            h('p', { className: 'text-gray-600' }, '月間または週間の食費予算を設定してください')
                        ),
                        h('div', { className: 'space-y-4' },
                            // 予算タイプ選択
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '予算の期間'),
                                h('div', { className: 'grid grid-cols-2 gap-2' },
                                    h('button', {
                                        onClick: () => setBudgetType('monthly'),
                                        className: `px-4 py-2 rounded-lg text-sm border transition-colors ${
                                            budgetType === 'monthly' 
                                                ? 'bg-blue-100 text-blue-800 border-blue-300' 
                                                : 'bg-gray-50 text-gray-700 border-gray-300 hover:bg-gray-100'
                                        }`
                                    }, '月間'),
                                    h('button', {
                                        onClick: () => setBudgetType('weekly'),
                                        className: `px-4 py-2 rounded-lg text-sm border transition-colors ${
                                            budgetType === 'weekly' 
                                                ? 'bg-blue-100 text-blue-800 border-blue-300' 
                                                : 'bg-gray-50 text-gray-700 border-gray-300 hover:bg-gray-100'
                                        }`
                                    }, '週間')
                                )
                            ),
                            
                            // 予算金額入力
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '予算金額'),
                                h('div', { className: 'relative' },
                                    h('input', {
                                        type: 'number',
                                        value: budget,
                                        onChange: (e) => setBudget(e.target.value),
                                        placeholder: monthlyBudget ? `前回設定: ${monthlyBudget.amount.toLocaleString()}円` : '未設定 - 金額を入力してください',
                                        className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg',
                                        min: '1',
                                        step: '1'
                                    }),
                                    h('span', { className: 'absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500' }, '円')
                                ),
                                monthlyBudget && h('div', { className: 'mt-2 text-xs text-gray-400' }, 
                                    `前回設定: ${monthlyBudget.amount.toLocaleString()}円 (${monthlyBudget.type === 'monthly' ? '月間' : '週間'})`
                                )
                            ),
                            
                            // ボタン
                            h('div', { className: 'flex space-x-3 pt-4' },
                                h('button', {
                                    onClick: () => setShowBudgetModal(false),
                                    className: 'flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors'
                                }, 'キャンセル'),
                                h('button', {
                                    onClick: () => {
                                        if (budget && parseInt(budget) > 0) {
                                            updateBudget({
                                                amount: parseInt(budget),
                                                type: budgetType,
                                                setDate: new Date().toISOString()
                                            });
                                        } else {
                                            alert('有効な金額を入力してください。');
                                        }
                                    },
                                    className: 'flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors'
                                }, '保存')
                            )
                        )
                    )
                )
            );
        };

        // 店舗管理ページコンポーネント
        const StorePage = () => {
            const [stores, setStores] = useState(() => {
                const saved = localStorage.getItem('stores');
                return saved ? JSON.parse(saved) : [];
            });

            const [isAddingStore, setIsAddingStore] = useState(false);
            const [newStore, setNewStore] = useState({
                name: '',
                address: '',
                category: '',
            });

            const handleAddStore = () => {
                if (newStore.name && newStore.address && newStore.category) {
                    const store = {
                        id: Date.now().toString(),
                        name: newStore.name,
                        address: newStore.address,
                        category: newStore.category,
                        visitCount: 0,
                    };
                    const updatedStores = [store, ...stores];
                    setStores(updatedStores);
                    localStorage.setItem('stores', JSON.stringify(updatedStores));
                    setNewStore({ name: '', address: '', category: '' });
                    setIsAddingStore(false);
                }
            };

            return h('div', { className: 'p-4 space-y-6 pb-24' },
                h('div', { className: 'text-center py-6' },
                    h('h1', { className: 'text-2xl font-bold text-gray-900 mb-2' }, '店舗管理'),
                    h('p', { className: 'text-gray-600' }, 'よく行く店舗を管理しましょう')
                ),
                h('div', { className: 'text-center' },
                    h('button', {
                        onClick: () => setIsAddingStore(true),
                        className: 'btn-primary inline-flex items-center space-x-2'
                    },
                        h(Plus, { className: 'w-5 h-5' }),
                        h('span', null, '店舗を追加')
                    )
                ),
                isAddingStore && h('div', { className: 'card' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, '新しい店舗'),
                    h('div', { className: 'space-y-4' },
                        h('div', null,
                            h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '店舗名'),
                            h('input', {
                                type: 'text',
                                value: newStore.name,
                                onChange: (e) => setNewStore({ ...newStore, name: e.target.value }),
                                className: 'input-field',
                                placeholder: 'イオン 新宿店'
                            })
                        ),
                        h('div', null,
                            h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '住所'),
                            h('input', {
                                type: 'text',
                                value: newStore.address,
                                onChange: (e) => setNewStore({ ...newStore, address: e.target.value }),
                                className: 'input-field',
                                placeholder: '東京都新宿区'
                            })
                        ),
                        h('div', null,
                            h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'カテゴリ'),
                            h('select', {
                                value: newStore.category,
                                onChange: (e) => setNewStore({ ...newStore, category: e.target.value }),
                                className: 'input-field'
                            },
                                h('option', { value: '' }, 'カテゴリを選択'),
                                h('option', { value: 'スーパー' }, 'スーパー'),
                                h('option', { value: 'コンビニ' }, 'コンビニ'),
                                h('option', { value: 'ドラッグストア' }, 'ドラッグストア'),
                                h('option', { value: 'その他' }, 'その他')
                            )
                        ),
                        h('div', { className: 'flex space-x-2' },
                            h('button', {
                                onClick: handleAddStore,
                                className: 'btn-primary flex-1'
                            }, '追加'),
                            h('button', {
                                onClick: () => setIsAddingStore(false),
                                className: 'btn-secondary flex-1'
                            }, 'キャンセル')
                        )
                    )
                ),
                h('div', { className: 'space-y-4' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900' }, '登録店舗'),
                    ...stores.map((store) =>
                        h('div', { key: store.id, className: 'card' },
                            h('div', { className: 'flex justify-between items-start' },
                                h('div', { className: 'flex-1' },
                                    h('h4', { className: 'text-lg font-semibold text-gray-900 mb-1' }, store.name),
                                    h('p', { className: 'text-gray-600 mb-2' }, store.address),
                                    h('div', { className: 'flex items-center space-x-4' },
                                        h('span', { className: 'px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs' }, store.category),
                                        h('span', { className: 'text-sm text-gray-600' }, `訪問回数: ${store.visitCount}回`)
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        // 商品履歴ページコンポーネント
        const HistoryPage = () => {
            const [itemHistory, setItemHistory] = useState([
                { id: '1', name: '牛乳', category: '乳製品', lastPrice: 198, lastStore: 'イオン 新宿店', lastDate: '2024-01-15', purchaseCount: 5 },
                { id: '2', name: 'パン', category: 'パン', lastPrice: 298, lastStore: 'イオン 新宿店', lastDate: '2024-01-15', purchaseCount: 3 },
                { id: '3', name: '卵', category: '卵', lastPrice: 248, lastStore: 'イオン 新宿店', lastDate: '2024-01-15', purchaseCount: 2 },
            ]);

            return h('div', { className: 'p-4 space-y-6 pb-24' },
                h('div', { className: 'text-center py-6' },
                    h('h1', { className: 'text-2xl font-bold text-gray-900 mb-2' }, '商品履歴'),
                    h('p', { className: 'text-gray-600' }, '過去に買った商品の履歴を確認できます')
                ),
                h('div', { className: 'space-y-3' },
                    ...itemHistory.map((item) =>
                        h('div', { key: item.id, className: 'card' },
                            h('div', { className: 'flex justify-between items-start' },
                                h('div', { className: 'flex-1' },
                                    h('h4', { className: 'text-lg font-semibold text-gray-900 mb-1' }, item.name),
                                    h('div', { className: 'flex items-center space-x-4 text-sm text-gray-600 mb-2' },
                                        h('span', { className: 'px-2 py-1 bg-gray-100 text-gray-800 rounded' }, item.category),
                                        h('span', null, `¥${item.lastPrice}`),
                                        h('span', null, item.lastStore)
                                    ),
                                    h('p', { className: 'text-sm text-gray-500' }, `最終購入: ${item.lastDate} (${item.purchaseCount}回購入)`),
                                )
                            )
                        )
                    )
                )
            );
        };

        // 比較ページコンポーネント
        const ComparePage = () => {
            const [monthlyExpenses, setMonthlyExpenses] = useState([]);

            // 最大支出額を計算（グラフの高さを決定するため）
            const maxAmount = monthlyExpenses.length > 0 ? Math.max(...monthlyExpenses.map(item => item.amount)) : 0;

            return h('div', { className: 'p-4 space-y-6 pb-24' },
                h('div', { className: 'text-center py-6' },
                    h('h1', { className: 'text-2xl font-bold text-gray-900 mb-2' }, '比較分析'),
                    h('p', { className: 'text-gray-600' }, '月ごとの支出を棒グラフで表示')
                ),
                h('div', { className: 'card' },
                    h('h3', { className: 'text-lg font-semibold text-gray-900 mb-6' }, '月ごとの支出'),
                    monthlyExpenses.length === 0 ? 
                        h('div', { className: 'text-center py-12' },
                            h('div', { className: 'text-gray-400 mb-4' },
                                h('svg', { className: 'w-16 h-16 mx-auto', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                    h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z' })
                                )
                            ),
                            h('p', { className: 'text-lg text-gray-600 mb-2' }, 'データがありません'),
                            h('p', { className: 'text-sm text-gray-500' }, '家計簿入力で支出データを登録すると、ここにグラフが表示されます')
                        ) :
                    h('div', { className: 'space-y-4' },
                        // グラフコンテナ（横スクロール対応）
                        h('div', { className: 'relative' },
                            // 横スクロール可能なグラフエリア
                            h('div', { 
                                className: 'overflow-x-auto pb-4',
                                style: { scrollbarWidth: 'thin' }
                            },
                                h('div', { 
                                    className: 'relative h-80 min-w-max px-4',
                                    style: { minWidth: `${monthlyExpenses.length * 76}px` }
                                },
                                    // 線グラフ（棒グラフの上に重ねて表示）
                                    h('svg', {
                                        className: 'absolute inset-0 w-full h-full pointer-events-none',
                                        viewBox: `0 0 ${monthlyExpenses.length * 76} 200`,
                                        preserveAspectRatio: 'none'
                                    },
                                        // 線グラフのパス
                                        h('path', {
                                            d: monthlyExpenses.map((item, index) => {
                                                const x = (index * 76) + 24; // 棒の中心位置（8px左マージン + 16px棒の中心 = 24px）
                                                const y = 200 - ((item.amount / maxAmount) * 200); // 棒の上端位置
                                                return `${index === 0 ? 'M' : 'L'} ${x} ${y}`;
                                            }).join(' '),
                                            fill: 'none',
                                            stroke: '#ef4444',
                                            strokeWidth: '3',
                                            strokeLinecap: 'round',
                                            strokeLinejoin: 'round'
                                        }),
                                        // 線グラフの点
                                        ...monthlyExpenses.map((item, index) => {
                                            const x = (index * 76) + 24; // 棒の中心位置
                                            const y = 200 - ((item.amount / maxAmount) * 200); // 棒の上端位置
                                            return h('circle', {
                                                cx: x,
                                                cy: y,
                                                r: '4',
                                                fill: '#ef4444',
                                                stroke: 'white',
                                                strokeWidth: '2'
                                            });
                                        })
                                    ),
                                    // 棒グラフ
                                    h('div', { 
                                        className: 'flex items-end justify-start h-64 border-b border-gray-200'
                                    },
                                        ...monthlyExpenses.map((item, index) => {
                                            const height = (item.amount / maxAmount) * 200;
                                            return h('div', { 
                                                key: index,
                                                className: 'flex flex-col items-center mx-2 relative group',
                                                style: { width: '60px' }
                                            },
                                                // 棒グラフ
                                                h('div', { 
                                                    className: 'w-8 bg-gradient-to-t from-blue-600 to-blue-400 rounded-t-lg transition-all duration-300 hover:from-blue-700 hover:to-blue-500 shadow-lg group-hover:shadow-xl',
                                                    style: { height: `${height}px` }
                                                }),
                                                // ホバー時の金額表示
                                                h('div', { 
                                                    className: 'absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10'
                                                }, `¥${item.amount.toLocaleString()}`),
                                                // 月名
                                                h('div', { className: 'mt-2 text-xs text-gray-600 font-medium' }, item.month),
                                                // 金額（常時表示）
                                                h('div', { className: 'text-xs font-medium text-gray-900 mt-1' }, `¥${item.amount.toLocaleString()}`)
                                            );
                                        })
                                    )
                                )
                            )
                        ),
                        // 凡例と統計情報
                        monthlyExpenses.length > 0 && h('div', { className: 'mt-6 grid grid-cols-2 gap-4' },
                            h('div', { className: 'text-center' },
                                h('p', { className: 'text-sm text-gray-600' }, '最高支出月'),
                                h('p', { className: 'text-lg font-bold text-gray-900' }, 
                                    monthlyExpenses.reduce((max, item) => item.amount > max.amount ? item : max).month
                                ),
                                h('p', { className: 'text-sm text-gray-600' }, 
                                    `¥${monthlyExpenses.reduce((max, item) => item.amount > max.amount ? item : max).amount.toLocaleString()}`
                                )
                            ),
                            h('div', { className: 'text-center' },
                                h('p', { className: 'text-sm text-gray-600' }, '平均支出'),
                                h('p', { className: 'text-lg font-bold text-gray-900' }, 
                                    `¥${Math.round(monthlyExpenses.reduce((sum, item) => sum + item.amount, 0) / monthlyExpenses.length).toLocaleString()}`
                                )
                            )
                        )
                    )
                )
            );
        };

        // 多言語対応コンポーネント
        const LanguagePage = () => {
            const [language, setLanguage] = useState('ja');

            const languages = [
                { code: 'ja', name: '日本語', flag: '🇯🇵' },
                { code: 'en', name: 'English', flag: '🇺🇸' },
            ];

            const translations = {
                ja: {
                    title: '言語設定',
                    description: 'アプリの表示言語を選択してください',
                    current: '現在の言語',
                    select: '言語を選択'
                },
                en: {
                    title: 'Language Settings',
                    description: 'Select the display language for the app',
                    current: 'Current Language',
                    select: 'Select Language'
                }
            };

            return h('div', { className: 'p-4 space-y-6 pb-24' },
                h('div', { className: 'text-center py-6' },
                    h('h1', { className: 'text-2xl font-bold text-gray-900 mb-2' }, translations[language].title),
                    h('p', { className: 'text-gray-600' }, translations[language].description)
                ),
                h('div', { className: 'space-y-4' },
                    h('div', { className: 'card' },
                        h('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, translations[language].current),
                        h('div', { className: 'flex items-center space-x-3' },
                            h('span', { className: 'text-2xl' }, languages.find(lang => lang.code === language)?.flag),
                            h('span', { className: 'text-lg font-medium' }, languages.find(lang => lang.code === language)?.name)
                        )
                    ),
                    h('div', { className: 'card' },
                        h('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, translations[language].select),
                        h('div', { className: 'space-y-2' },
                            ...languages.map((lang) =>
                                h('button', {
                                    key: lang.code,
                                    onClick: () => setLanguage(lang.code),
                                    className: `w-full flex items-center space-x-3 p-3 rounded-lg border transition-colors ${
                                        language === lang.code 
                                            ? 'bg-blue-100 text-blue-800 border-blue-300' 
                                            : 'bg-gray-50 text-gray-700 border-gray-300 hover:bg-gray-100'
                                    }`
                                },
                                    h('span', { className: 'text-2xl' }, lang.flag),
                                    h('span', { className: 'font-medium' }, lang.name)
                                )
                            )
                        )
                    )
                )
            );
        };

        // モバイルメニューコンポーネント
        const MobileMenu = ({ isOpen, onClose, onPageChange }) => {
            const menuItems = [
                { icon: Home, label: 'ホーム', page: 'home' },
                { icon: Receipt, label: 'レシート', page: 'receipt' },
                { icon: Calculator, label: '家計簿', page: 'accounting' },
                { icon: ChefHat, label: 'メニュー', page: 'menu' },
                { icon: Store, label: '店舗管理', page: 'store' },
                { icon: History, label: '商品履歴', page: 'history' },
                { icon: Compare, label: '比較分析', page: 'compare' },
                { icon: Globe, label: '言語設定', page: 'language' },
                { icon: Settings, label: '設定', page: 'settings' },
            ];

            if (!isOpen) return null;

            return h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 z-50' },
                h('div', { className: 'fixed left-0 top-0 bottom-0 w-80 bg-white shadow-xl' },
                    h('div', { className: 'p-6' },
                        h('div', { className: 'flex items-center justify-between mb-8' },
                            h('h2', { className: 'text-xl font-semibold text-gray-900' }, 'メニュー'),
                            h('button', {
                                onClick: onClose,
                                className: 'p-2 rounded-lg hover:bg-gray-100 transition-colors'
                            }, '×')
                        ),
                        h('nav', { className: 'space-y-2' },
                            ...menuItems.map(({ icon: Icon, label, page }) =>
                                h('button', {
                                    key: page,
                                    onClick: () => {
                                        onPageChange(page);
                                        onClose();
                                    },
                                    className: 'flex items-center w-full px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors'
                                },
                                    h(Icon, { className: 'w-5 h-5 text-gray-600 mr-3' }),
                                    h('span', { className: 'text-gray-900' }, label)
                                )
                            )
                        )
                    )
                )
            );
        };

        // メインアプリコンポーネント
        const App = () => {
            const [currentPage, setCurrentPage] = useState('login');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [user, setUser] = useState(null);
            const [location, setLocation] = useState(null);
            const [locationSetupComplete, setLocationSetupComplete] = useState(false);
            const [showTutorial, setShowTutorial] = useState(false);
            const [tutorialStep, setTutorialStep] = useState(0);
            const [monthlyBudget, setMonthlyBudget] = useState(null);
            const [showBudgetSetup, setShowBudgetSetup] = useState(false);

            // ログイン状態の初期化
            useEffect(() => {
                const savedUser = localStorage.getItem('user');
                const savedLocation = localStorage.getItem('location');
                const locationSetupComplete = localStorage.getItem('locationSetupComplete');
                
                if (savedUser) {
                    setUser(JSON.parse(savedUser));
                    setIsLoggedIn(true);
                    
                    // 位置情報設定が完了しているかチェック
                    if (locationSetupComplete === 'true' && savedLocation) {
                        setLocation(JSON.parse(savedLocation));
                        setLocationSetupComplete(true);
                        setCurrentPage('home');
                    } else {
                        setCurrentPage('location-setup');
                    }
                }
            }, []);

            // 位置情報の取得
            const getCurrentLocation = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const newLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                address: '現在地を取得中...'
                            };
                            setLocation(newLocation);
                            localStorage.setItem('location', JSON.stringify(newLocation));
                        },
                        (error) => {
                            console.error('位置情報の取得に失敗:', error);
                            alert('位置情報の取得に失敗しました。手動で設定してください。');
                        }
                    );
                } else {
                    alert('このブラウザでは位置情報がサポートされていません。');
                }
            };

            // ログイン処理
            const handleLogin = (username, password) => {
                if (username && password) {
                    const userData = { 
                        username, 
                        loginTime: new Date().toISOString(),
                        isGuest: false
                    };
                    setUser(userData);
                    setIsLoggedIn(true);
                    localStorage.setItem('user', JSON.stringify(userData));
                    
                    // 位置情報の設定状況をチェック
                    const savedLocation = localStorage.getItem('location');
                    const locationSetupComplete = localStorage.getItem('locationSetupComplete');
                    
                    if (savedLocation && locationSetupComplete === 'true') {
                        // 位置情報が設定済みの場合はホーム画面へ
                        setLocation(JSON.parse(savedLocation));
                        setLocationSetupComplete(true);
                        setCurrentPage('home');
                    } else {
                        // 位置情報が未設定の場合は位置情報設定画面へ
                    setCurrentPage('location-setup');
                    }
                }
            };

            // ゲストログイン処理
            const handleGuestLogin = () => {
                const guestData = { 
                    username: 'ゲスト', 
                    loginTime: new Date().toISOString(),
                    isGuest: true
                };
                setUser(guestData);
                setIsLoggedIn(true);
                localStorage.setItem('user', JSON.stringify(guestData));
                
                // 位置情報の設定状況をチェック
                const savedLocation = localStorage.getItem('location');
                const locationSetupComplete = localStorage.getItem('locationSetupComplete');
                
                if (savedLocation && locationSetupComplete === 'true') {
                    // 位置情報が設定済みの場合はホーム画面へ
                    setLocation(JSON.parse(savedLocation));
                    setLocationSetupComplete(true);
                    setCurrentPage('home');
                } else {
                    // 位置情報が未設定の場合は位置情報設定画面へ
                setCurrentPage('location-setup');
                }
            };

            // ログアウト処理
            const handleLogout = () => {
                setUser(null);
                setIsLoggedIn(false);
                setLocationSetupComplete(false);
                setCurrentPage('login');
                localStorage.removeItem('user');
                localStorage.removeItem('locationSetupComplete');
            };

            // 位置情報の手動設定
            const setManualLocation = (address) => {
                const newLocation = {
                    lat: null,
                    lng: null,
                    address: address
                };
                setLocation(newLocation);
                localStorage.setItem('location', JSON.stringify(newLocation));
            };

            // チュートリアル完了処理
            const handleTutorialComplete = () => {
                setShowTutorial(false);
                setTutorialStep(0);
                // チュートリアル完了後はホーム画面へ
                setCurrentPage('home');
            };

            // 位置情報設定完了処理
            const handleLocationSetupComplete = (locationData) => {
                setLocation(locationData);
                setLocationSetupComplete(true);
                localStorage.setItem('location', JSON.stringify(locationData));
                localStorage.setItem('locationSetupComplete', 'true');
                
                // 食費予算の設定状況をチェック
                const savedBudget = localStorage.getItem('monthlyBudget');
                
                if (savedBudget) {
                    // 予算設定済みの場合はチュートリアルまたはホーム画面へ
                    setMonthlyBudget(JSON.parse(savedBudget));
                    const tutorialCompleted = localStorage.getItem('tutorialCompleted');
                    
                    if (tutorialCompleted === 'true') {
                setCurrentPage('home');
                    } else {
                        setShowTutorial(true);
                    }
                } else {
                    // 予算未設定の場合は予算設定画面へ
                    setShowBudgetSetup(true);
                }
            };

            // 食費予算設定完了処理
            const handleBudgetSetupComplete = () => {
                setShowBudgetSetup(false);
                
                // チュートリアルの完了状況をチェック
                const tutorialCompleted = localStorage.getItem('tutorialCompleted');
                
                if (tutorialCompleted === 'true') {
                    // チュートリアル完了済みの場合はホーム画面へ
                    setCurrentPage('home');
                } else {
                    // 初回利用者の場合はチュートリアルを表示
                    setShowTutorial(true);
                }
            };

            // ログイン画面コンポーネント
            const LoginPage = ({ onLogin, onGuestLogin }) => {
                const [username, setUsername] = useState('');
                const [password, setPassword] = useState('');
                const [isRegistering, setIsRegistering] = useState(false);
                const [registerData, setRegisterData] = useState({
                    username: '',
                    password: '',
                    confirmPassword: '',
                    email: ''
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (isRegistering) {
                        if (registerData.password === registerData.confirmPassword) {
                            // 簡単な登録処理（実際のアプリではバリデーションが必要）
                            alert('登録が完了しました！');
                            onLogin(registerData.username, registerData.password);
                        } else {
                            alert('パスワードが一致しません。');
                        }
                    } else {
                        onLogin(username, password);
                    }
                };

                return h('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4' },
                    h('div', { className: 'bg-white rounded-2xl shadow-xl p-8 w-full max-w-md' },
                        h('div', { className: 'text-center mb-8' },
                            h('h1', { className: 'text-3xl font-bold text-gray-900 mb-2' }, 'SmartKago'),
                            h('p', { className: 'text-gray-600' }, '家計簿とレシート管理アプリ')
                        ),
                        
                        isRegistering ? h('form', { onSubmit: handleSubmit, className: 'space-y-6' },
                            h('div', { className: 'space-y-4' },
                                h('input', {
                                    type: 'text',
                                    placeholder: 'ユーザー名',
                                    value: registerData.username,
                                    onChange: (e) => setRegisterData({...registerData, username: e.target.value}),
                                    className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent',
                                    required: true
                                }),
                                h('input', {
                                    type: 'email',
                                    placeholder: 'メールアドレス',
                                    value: registerData.email,
                                    onChange: (e) => setRegisterData({...registerData, email: e.target.value}),
                                    className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent',
                                    required: true
                                }),
                                h('input', {
                                    type: 'password',
                                    placeholder: 'パスワード',
                                    value: registerData.password,
                                    onChange: (e) => setRegisterData({...registerData, password: e.target.value}),
                                    className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent',
                                    required: true
                                }),
                                h('input', {
                                    type: 'password',
                                    placeholder: 'パスワード確認',
                                    value: registerData.confirmPassword,
                                    onChange: (e) => setRegisterData({...registerData, confirmPassword: e.target.value}),
                                    className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent',
                                    required: true
                                })
                            ),
                            h('button', {
                                type: 'submit',
                                className: 'w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium'
                            }, 'アカウント作成'),
                            h('button', {
                                type: 'button',
                                onClick: () => setIsRegistering(false),
                                className: 'w-full text-blue-600 py-2 px-4 rounded-lg hover:bg-blue-50 transition-colors'
                            }, 'ログインに戻る')
                        ) : h('form', { onSubmit: handleSubmit, className: 'space-y-6' },
                            h('div', { className: 'space-y-4' },
                                h('input', {
                                    type: 'text',
                                    placeholder: 'ユーザー名',
                                    value: username,
                                    onChange: (e) => setUsername(e.target.value),
                                    className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent',
                                    required: true
                                }),
                                h('input', {
                                    type: 'password',
                                    placeholder: 'パスワード',
                                    value: password,
                                    onChange: (e) => setPassword(e.target.value),
                                    className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent',
                                    required: true
                                })
                            ),
                            h('button', {
                                type: 'submit',
                                className: 'w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium'
                            }, 'ログイン'),
                            h('button', {
                                type: 'button',
                                onClick: () => setIsRegistering(true),
                                className: 'w-full text-blue-600 py-2 px-4 rounded-lg hover:bg-blue-50 transition-colors'
                            }, 'アカウント作成'),
                            h('div', { className: 'relative' },
                                h('div', { className: 'absolute inset-0 flex items-center' },
                                    h('div', { className: 'w-full border-t border-gray-300' })
                                ),
                                h('div', { className: 'relative flex justify-center text-sm' },
                                    h('span', { className: 'px-2 bg-white text-gray-500' }, 'または')
                                )
                            ),
                            h('button', {
                                type: 'button',
                                onClick: onGuestLogin,
                                className: 'w-full bg-gray-100 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors font-medium'
                            }, 'ゲストとして利用')
                        ),
                        
                    )
                );
            };

            // 食費予算設定画面コンポーネント
            const BudgetSetupPage = ({ onComplete, user }) => {
                const [budget, setBudget] = useState('');
                const [budgetType, setBudgetType] = useState('monthly'); // 'monthly' or 'weekly'
                const [isLoading, setIsLoading] = useState(false);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!budget || isNaN(budget) || budget <= 0) {
                        alert('有効な予算を入力してください。');
                        return;
                    }

                    setIsLoading(true);
                    
                    try {
                        const budgetData = {
                            amount: parseInt(budget),
                            type: budgetType,
                            setDate: new Date().toISOString(),
                            userId: user?.username || 'guest'
                        };
                        
                        // 予算データを保存
                        localStorage.setItem('monthlyBudget', JSON.stringify(budgetData));
                        setMonthlyBudget(budgetData);
                        
                        // 少し待ってから完了
                        setTimeout(() => {
                            setIsLoading(false);
                            onComplete();
                        }, 1000);
                        
                    } catch (error) {
                        setIsLoading(false);
                        alert('予算の保存に失敗しました。');
                    }
                };

                const budgetSuggestions = [
                    { amount: 30000, label: '3万円（節約志向）' },
                    { amount: 50000, label: '5万円（標準的）' },
                    { amount: 70000, label: '7万円（ゆとりあり）' },
                    { amount: 100000, label: '10万円（豊か）' }
                ];

                return h('div', { className: 'min-h-screen bg-gradient-to-br from-green-50 to-blue-100 p-4' },
                    h('div', { className: 'max-w-md mx-auto' },
                        // ヘッダー
                        h('div', { className: 'text-center mb-8' },
                            h('h1', { className: 'text-3xl font-bold text-gray-900 mb-2' }, '食費予算の設定'),
                            h('p', { className: 'text-gray-600' }, `${user?.username}さん、月々の食費予算を設定してください`)
                        ),

                        // メインカード
                        h('div', { className: 'bg-white rounded-2xl shadow-xl p-6' },
                            h('form', { onSubmit: handleSubmit },
                                // 予算タイプ選択
                                h('div', { className: 'mb-6' },
                                    h('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, '予算の期間'),
                                    h('div', { className: 'grid grid-cols-2 gap-3' },
                                h('button', {
                                    type: 'button',
                                            onClick: () => setBudgetType('monthly'),
                                            className: `p-3 rounded-lg border-2 transition-colors ${
                                                budgetType === 'monthly' 
                                                    ? 'border-blue-500 bg-blue-50 text-blue-700' 
                                                    : 'border-gray-200 hover:border-gray-300'
                                            }`
                                        },
                                            h('div', { className: 'text-center' },
                                                h('div', { className: 'text-2xl mb-1' }, '📅'),
                                                h('h4', { className: 'font-medium' }, '月間予算'),
                                                h('p', { className: 'text-sm text-gray-600' }, '1ヶ月単位')
                                            )
                                        ),
                                        h('button', {
                                            type: 'button',
                                            onClick: () => setBudgetType('weekly'),
                                            className: `p-3 rounded-lg border-2 transition-colors ${
                                                budgetType === 'weekly' 
                                                    ? 'border-blue-500 bg-blue-50 text-blue-700' 
                                                    : 'border-gray-200 hover:border-gray-300'
                                            }`
                                        },
                                            h('div', { className: 'text-center' },
                                                h('div', { className: 'text-2xl mb-1' }, '📊'),
                                                h('h4', { className: 'font-medium' }, '週間予算'),
                                                h('p', { className: 'text-sm text-gray-600' }, '1週間単位')
                                            )
                                        )
                                    )
                                ),

                                // 予算入力
                                h('div', { className: 'mb-6' },
                                    h('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 
                                        budgetType === 'monthly' ? '月間食費予算' : '週間食費予算'
                                    ),
                                    h('div', { className: 'relative' },
                                    h('input', {
                                            type: 'number',
                                            value: budget,
                                            onChange: (e) => setBudget(e.target.value),
                                            placeholder: budgetType === 'monthly' ? '例: 50000' : '例: 12500',
                                            className: 'w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center',
                                            min: '1000',
                                            max: '1000000',
                                            step: '1000'
                                        }),
                                        h('span', { 
                                            className: 'absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500'
                                        }, '円')
                                    )
                                ),

                                // 予算提案
                                h('div', { className: 'mb-6' },
                                    h('h3', { className: 'text-lg font-semibold text-gray-900 mb-3' }, 'おすすめの予算'),
                                    h('div', { className: 'grid grid-cols-2 gap-2' },
                                        ...budgetSuggestions.map((suggestion, index) => {
                                            const suggestedAmount = budgetType === 'monthly' 
                                                ? suggestion.amount 
                                                : Math.round(suggestion.amount / 4);
                                            
                                            return h('button', {
                                                key: index,
                                        type: 'button',
                                                onClick: () => setBudget(suggestedAmount.toString()),
                                                className: 'p-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-left'
                                            },
                                                h('div', { className: 'font-medium text-gray-900' }, `${suggestedAmount.toLocaleString()}円`),
                                                h('div', { className: 'text-xs text-gray-600' }, suggestion.label)
                                            );
                                        })
                                    )
                                ),

                                // 説明
                                h('div', { className: 'mb-6 p-4 bg-blue-50 rounded-lg' },
                                    h('div', { className: 'flex items-start space-x-2' },
                                        h('div', { className: 'text-blue-600 text-lg' }, '💡'),
                                        h('div', { className: 'text-sm text-blue-800' },
                                            h('p', { className: 'font-medium mb-1' }, '予算設定のポイント'),
                                            h('ul', { className: 'text-xs space-y-1' },
                                                h('li', {}, '• 過去の食費を参考に設定してください'),
                                                h('li', {}, '• 無理のない範囲で設定しましょう'),
                                                h('li', {}, '• 後から変更することも可能です')
                                            )
                                        )
                                    )
                                ),

                                // 送信ボタン
                                h('button', {
                                    type: 'submit',
                                    disabled: !budget || isNaN(budget) || budget <= 0 || isLoading,
                                    className: `w-full py-3 px-4 rounded-lg font-medium transition-colors ${
                                        !budget || isNaN(budget) || budget <= 0 || isLoading
                                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            : 'bg-green-600 text-white hover:bg-green-700'
                                    }`
                                }, isLoading ? '設定中...' : '予算を設定する')
                            )
                        )
                    )
                );
            };

            // インタラクティブチュートリアルコンポーネント
            const TutorialPage = ({ onComplete }) => {
                const tutorialSteps = [
                    {
                        title: 'カゴセーバーへようこそ！',
                        content: 'このアプリは、近くのスーパーマーケットの価格を比較して、お得な買い物をサポートします。',
                        highlightElement: null
                    },
                    {
                        title: 'ホーム画面',
                        content: 'ここがメインのホーム画面です。近くのスーパー情報やお得な情報が表示されます。',
                        highlightElement: 'home',
                        targetPage: 'home'
                    },
                    {
                        title: 'レシート管理',
                        content: '買い物のレシートを写真で撮影し、支出を記録・管理できます。',
                        highlightElement: 'receipt',
                        targetPage: 'receipt'
                    },
                    {
                        title: '家計簿機能',
                        content: '月別の支出をグラフで確認し、家計の管理ができます。',
                        highlightElement: 'accounting',
                        targetPage: 'accounting'
                    },
                    {
                        title: 'メニュー',
                        content: 'アプリの各種設定や機能にアクセスできます。',
                        highlightElement: 'menu',
                        targetPage: 'menu'
                    },
                    {
                        title: '準備完了！',
                        content: 'それでは、カゴセーバーを始めましょう！',
                        highlightElement: null
                    }
                ];

                const currentStep = tutorialSteps[tutorialStep];
                const isLastStep = tutorialStep === tutorialSteps.length - 1;

                const handleNext = () => {
                    if (isLastStep) {
                        localStorage.setItem('tutorialCompleted', 'true');
                        onComplete();
                    } else {
                        setTutorialStep(tutorialStep + 1);
                    }
                };

                const handleSkip = () => {
                    localStorage.setItem('tutorialCompleted', 'true');
                    onComplete();
                };

                // ハイライト対象のページを表示
                const getHighlightPage = () => {
                    if (currentStep.targetPage) {
                        switch (currentStep.targetPage) {
                            case 'home': return h(HomePage, { onPageChange: () => {}, user, location });
                            case 'receipt': return h(ReceiptPage);
                            case 'accounting': return h(AccountingPage);
                            case 'menu': return h(MenuPage);
                            default: return h(HomePage, { onPageChange: () => {}, user, location });
                        }
                    }
                    return h(HomePage, { onPageChange: () => {}, user, location });
                };

                return h('div', { className: 'min-h-screen bg-gray-900 relative' },
                    // オーバーレイ
                    h('div', { className: 'absolute inset-0 bg-black bg-opacity-50 z-10' }),
                    
                    // チュートリアル説明カード
                    h('div', { className: 'absolute top-4 left-4 right-4 z-20' },
                        h('div', { className: 'bg-white rounded-2xl shadow-2xl p-6' },
                            // プログレスバー
                            h('div', { className: 'mb-6' },
                                h('div', { className: 'flex justify-between text-sm text-gray-500 mb-2' },
                                    h('span', {}, `ステップ ${tutorialStep + 1} / ${tutorialSteps.length}`),
                                    h('button', {
                                        onClick: handleSkip,
                                        className: 'text-blue-600 hover:text-blue-800 underline'
                                    }, 'スキップ')
                                ),
                                h('div', { className: 'w-full bg-gray-200 rounded-full h-2' },
                                    h('div', {
                                        className: 'bg-blue-600 h-2 rounded-full transition-all duration-300',
                                        style: { width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }
                                    })
                                )
                            ),

                            // タイトル
                            h('h1', { className: 'text-xl font-bold text-gray-900 mb-3' }, currentStep.title),

                            // 説明文
                            h('p', { className: 'text-gray-600 mb-6 leading-relaxed' }, currentStep.content),

                            // ボタン
                            h('div', { className: 'flex space-x-3' },
                                tutorialStep > 0 && h('button', {
                                    onClick: () => setTutorialStep(tutorialStep - 1),
                                    className: 'flex-1 py-2 px-4 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium'
                                }, '戻る'),
                                h('button', {
                                    onClick: handleNext,
                                    className: `flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${
                                        isLastStep 
                                            ? 'bg-green-600 text-white hover:bg-green-700' 
                                            : 'bg-blue-600 text-white hover:bg-blue-700'
                                    }`
                                }, isLastStep ? '始める' : '次へ')
                            )
                        )
                    ),

                    // ハイライト対象のアプリ画面
                    h('div', { className: 'relative z-0' },
                        getHighlightPage(),
                        h(BottomNavigation, { 
                            currentPage: currentStep.targetPage || 'home', 
                            onPageChange: () => {},
                            highlightElement: currentStep.highlightElement
                        })
                    ),

                    // ハイライト効果（ナビゲーションボタン用）
                    currentStep.highlightElement && h('div', {
                        className: 'absolute bottom-20 left-0 right-0 z-15 pointer-events-none',
                        style: {
                            background: 'radial-gradient(circle, transparent 0%, transparent 40%, rgba(0,0,0,0.3) 100%)'
                        }
                    })
                );
            };

            // 位置情報設定画面コンポーネント
            const LocationSetupPage = ({ onComplete, user }) => {
                const [locationType, setLocationType] = useState('auto'); // 'auto' or 'manual'
                const [currentLocation, setCurrentLocation] = useState(null);
                const [manualAddress, setManualAddress] = useState('');
                const [mapCenter, setMapCenter] = useState({ lat: 35.6762, lng: 139.6503 }); // 東京
                const [selectedLocation, setSelectedLocation] = useState(null);
                const [searchRadius, setSearchRadius] = useState(1000); // メートル（1km）
                const [isMapLoaded, setIsMapLoaded] = useState(false);
                const [isSearching, setIsSearching] = useState(false);
                const [mapInstance, setMapInstance] = useState(null);
                const [markerInstance, setMarkerInstance] = useState(null);
                const [radiusCircle, setRadiusCircle] = useState(null);
                const [postalCode, setPostalCode] = useState('');
                const [prefecture, setPrefecture] = useState('');
                const [city, setCity] = useState('');
                const [building, setBuilding] = useState('');
                const [isLoadingAddress, setIsLoadingAddress] = useState(false);
                const [nearbySupermarkets, setNearbySupermarkets] = useState([]);
                const [selectedSupermarkets, setSelectedSupermarkets] = useState([]);
                const [isSearchingSupermarkets, setIsSearchingSupermarkets] = useState(false);
                const searchExecutedRef = useRef(false);

                // 距離計算関数（ハヴァサイン公式）
                const calculateDistance = (lat1, lng1, lat2, lng2) => {
                    const R = 6371000; // 地球の半径（メートル）
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLng = (lng2 - lng1) * Math.PI / 180;
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                            Math.sin(dLng/2) * Math.sin(dLng/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    return Math.floor(R * c);
                };
                
                // 実際の店舗検索機能（追加検索対応）
                const searchNearbyStores = async (isAdditionalSearch = false) => {
                    
                    // selectedLocationのnullチェック
                    if (!selectedLocation || !selectedLocation.lat || !selectedLocation.lng) {
                        return;
                    }
                    
                    // 検索開始フラグを設定
                    setIsSearchingSupermarkets(true);
                    
                    if (!isAdditionalSearch) {
                        // 初回検索の場合は既存の店舗をクリア
                        setNearbySupermarkets([]);
                    }
                    
                    try {
                    // OpenStreetMap検索から開始
                    await searchWithOpenStreetMap();
                    } finally {
                        // 検索完了フラグを設定
                        setIsSearchingSupermarkets(false);
                    }
                };
                        
                // OpenStreetMap Nominatim API検索（高速化版）
                const searchWithOpenStreetMap = async () => {
                    try {
                        
                        // selectedLocationのnullチェック
                        if (!selectedLocation || !selectedLocation.lat || !selectedLocation.lng) {
                            searchWithFoursquare();
                            return;
                        }
                        
                        // 軽量化された検索（検索範囲を調整）
                        const searchRadiusDegrees = Math.max(0.005, searchRadius / 111000);
                        const url = `https://nominatim.openstreetmap.org/search?q=supermarket&format=json&addressdetails=1&limit=10&bounded=1&viewbox=${selectedLocation.lng-searchRadiusDegrees},${selectedLocation.lat-searchRadiusDegrees},${selectedLocation.lng+searchRadiusDegrees},${selectedLocation.lat+searchRadiusDegrees}`;
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒でタイムアウト
                        
                        try {
                            const response = await fetch(url, { signal: controller.signal });
                            clearTimeout(timeoutId);
                        const results = await response.json();
                        
                        const allResults = [];
                        
                        for (const place of results) {
                            if (place.lat && place.lon) {
                                const placeLat = parseFloat(place.lat);
                                const placeLng = parseFloat(place.lon);
                                const distance = calculateDistance(selectedLocation.lat, selectedLocation.lng, placeLat, placeLng);
                                
                                if (distance <= searchRadius) {
                                    allResults.push({
                                        id: `osm_${place.place_id || place.osm_id}`,
                                        name: place.display_name.split(',')[0] || place.name || '店舗名不明',
                                        chain: place.display_name.split(',')[0] || place.name || 'チェーン不明',
                                        address: place.display_name || '住所不明',
                                        distance: distance,
                                        lat: placeLat,
                                        lng: placeLng,
                                        category: 'スーパーマーケット',
                                        rating: '4.0',
                                        isOpen: true,
                                        isReal: true,
                                        source: 'OpenStreetMap'
                                    });
                                }
                            }
                        }
                        
                        if (allResults.length > 0) {
                            processSearchResults(allResults, 'OpenStreetMap');
                        } else {
                            // 英語検索で結果がない場合は日本語でも検索
                            await searchWithJapaneseTerms();
                        }
                        } catch (error) {
                            clearTimeout(timeoutId);
                            if (error.name !== 'AbortError') {
                                // エラー時はFoursquareにフォールバック
                            searchWithFoursquare();
                            }
                        }
                    } catch (error) {
                        searchWithFoursquare();
                    }
                };
                
                // 日本語での店舗検索
                const searchWithJapaneseTerms = async () => {
                    try {
                        
                        const searchRadiusDegrees = Math.max(0.005, searchRadius / 111000);
                        const japaneseTerms = ['スーパー', 'コンビニ'];
                        const allResults = [];
                        
                        for (const term of japaneseTerms) {
                            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(term)}&format=json&addressdetails=1&limit=5&bounded=1&viewbox=${selectedLocation.lng-searchRadiusDegrees},${selectedLocation.lat-searchRadiusDegrees},${selectedLocation.lng+searchRadiusDegrees},${selectedLocation.lat+searchRadiusDegrees}`;
                            
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒でタイムアウト
                            
                            try {
                                const response = await fetch(url, { signal: controller.signal });
                                clearTimeout(timeoutId);
                                const results = await response.json();
                            
                                
                                for (const place of results) {
                                if (place.lat && place.lon) {
                                    const placeLat = parseFloat(place.lat);
                                    const placeLng = parseFloat(place.lon);
                                    const distance = calculateDistance(selectedLocation.lat, selectedLocation.lng, placeLat, placeLng);
                                    
                                    if (distance <= searchRadius) {
                                        allResults.push({
                                            id: `osm_jp_${place.place_id || place.osm_id}`,
                                            name: place.display_name.split(',')[0] || place.name || '店舗名不明',
                                            chain: place.display_name.split(',')[0] || place.name || 'チェーン不明',
                                            address: place.display_name || '住所不明',
                                            distance: distance,
                                            lat: placeLat,
                                            lng: placeLng,
                                            category: 'スーパーマーケット',
                                            rating: '4.0',
                                            isOpen: true,
                                            isReal: true,
                                            source: 'OpenStreetMap-JP'
                                        });
                                    }
                                }
                            }
                            } catch (error) {
                                clearTimeout(timeoutId);
                                // エラー時は次の検索に進む
                            }
                        }
                        
                        if (allResults.length > 0) {
                            processSearchResults(allResults, 'OpenStreetMap-JP');
                        } else {
                            searchWithFoursquare();
                        }
                    } catch (error) {
                        console.error('日本語検索エラー:', error);
                        searchWithFoursquare();
                    }
                };
                
                // Foursquare API検索（高速化版）
                const searchWithFoursquare = async () => {
                    try {
                        
                        // selectedLocationのnullチェック
                        if (!selectedLocation || !selectedLocation.lat || !selectedLocation.lng) {
                            return;
                        }
                        
                        // 高速化されたデモ店舗データ
                        const demoStores = [
                            { name: 'イオン', rating: '4.2' },
                            { name: 'イトーヨーカドー', rating: '4.0' },
                            { name: '西友', rating: '3.8' },
                            { name: 'ライフ', rating: '4.1' }
                        ].map((template, i) => {
                            const angle = (i / 4) * 2 * Math.PI;
                            const distance = Math.random() * searchRadius * 0.8;
                            
                            const latOffset = (distance * Math.cos(angle)) / 111000;
                            const lngOffset = (distance * Math.sin(angle)) / (111000 * Math.cos(selectedLocation.lat * Math.PI / 180));
                            
                            // デモ用の店舗名を生成（実際の住所から推測）
                            const locationNames = ['中央店', '駅前店', '本店', '支店'];
                            const storeName = `${template.name} ${locationNames[i] || '店'}`;
                            
                            return {
                                id: `foursquare_${i + 1}`,
                                name: storeName,
                                chain: template.name,
                                address: `${selectedLocation.address || '住所不明'} ${i + 1}番地`,
                                distance: distance,
                                lat: selectedLocation.lat + latOffset,
                                lng: selectedLocation.lng + lngOffset,
                                category: 'スーパーマーケット',
                                rating: template.rating,
                                isOpen: true,
                                isReal: true,
                                source: 'Foursquare'
                            };
                        });
                        
                        processSearchResults(demoStores, 'Foursquare');
                    } catch (error) {
                        console.error('Foursquare検索エラー:', error);
                        setNearbySupermarkets([]);
                        setIsSearchingSupermarkets(false);
                    }
                };
                
                // 検索結果を処理する共通関数（追加機能付き）
                const processSearchResults = (results, source) => {
                    // selectedLocationのnullチェック
                    if (!selectedLocation || !selectedLocation.lat || !selectedLocation.lng) {
                        return;
                    }
                    
                    // 新しい店舗データを処理
                    const newStores = results
                        .map((place, index) => ({
                            id: place.id || `${source}_${index}`,
                            name: place.name || '店舗名不明',
                            chain: place.chain || place.name || 'チェーン不明',
                            address: place.address || '住所不明',
                            distance: place.distance || calculateDistance(selectedLocation.lat, selectedLocation.lng, place.lat, place.lng),
                            lat: place.lat,
                            lng: place.lng,
                            category: 'スーパーマーケット',
                            rating: place.rating || '4.0',
                            isOpen: place.isOpen !== undefined ? place.isOpen : true,
                            isReal: true,
                            source: source
                        }))
                        .filter(store => store.distance <= searchRadius);
        
                    // 既存の店舗データを取得
                    setNearbySupermarkets(prevStores => {
                        // 既存の店舗と新しい店舗をマージ（重複を避ける）
                        const existingIds = new Set(prevStores.map(store => store.id));
                        const uniqueNewStores = newStores.filter(store => !existingIds.has(store.id));
                        
                        // 既存の店舗と新しい店舗を結合
                        const allStores = [...prevStores, ...uniqueNewStores];
                        
                        // 距離順にソート（近い順）
                        const sortedStores = allStores.sort((a, b) => a.distance - b.distance);
                        
                        console.log(`店舗追加: 既存 ${prevStores.length}件 + 新規 ${uniqueNewStores.length}件 = 合計 ${sortedStores.length}件`);
                        
                        return sortedStores;
                    });
                    
                    // 検索完了フラグを設定
                    setIsSearchingSupermarkets(false);
                };

                // スーパー選択の切り替え
                const toggleSupermarketSelection = (supermarket) => {
                    setSelectedSupermarkets(prev => {
                        const isSelected = prev.some(s => s.id === supermarket.id);
                        if (isSelected) {
                            return prev.filter(s => s.id !== supermarket.id);
                        } else {
                            return [...prev, supermarket];
                        }
                    });
                };

                // よく行くスーパーを保存
                const saveFavoriteSupermarkets = () => {
                    if (selectedSupermarkets.length === 0) {
                        alert('よく行くスーパーを選択してください。');
                        return;
                    }
                    
                    try {
                        // 既存の店舗データを取得
                        const existingStores = JSON.parse(localStorage.getItem('stores') || '[]');
                        
                        // 選択されたスーパーを店舗管理に追加
                        const newStores = selectedSupermarkets.map(supermarket => ({
                            id: supermarket.id,
                            name: supermarket.name,
                            address: supermarket.address,
                            phone: '電話番号未設定',
                            category: supermarket.category,
                            notes: 'よく行くスーパー',
                            visitCount: 0,
                            lastVisit: null,
                            lat: supermarket.lat,
                            lng: supermarket.lng,
                            rating: supermarket.rating,
                            isFavorite: true
                        }));
                        
                        // 重複を避けて追加
                        const updatedStores = [...newStores, ...existingStores.filter(store => 
                            !newStores.some(newStore => newStore.name === store.name)
                        )];
                        
                        localStorage.setItem('stores', JSON.stringify(updatedStores));
                        alert(`${selectedSupermarkets.length}件のスーパーをよく行く店舗に登録しました！`);
                        
                        // 位置情報設定を完了
                        onComplete(selectedLocation);
                        
                    } catch (error) {
                        console.error('スーパー保存エラー:', error);
                        alert('スーパーの保存に失敗しました。');
                    }
                };

                // 住所検索機能（簡易版）
                const searchAddress = useCallback(async (address) => {
                    if (!address.trim()) return;
                    
                    setIsSearching(true);
                    
                    try {
                        // 簡易的な住所→座標変換（実際のAPIではより正確）
                        const addressToCoords = {
                            '東京': { lat: 35.6762, lng: 139.6503 },
                            '大阪': { lat: 34.6937, lng: 135.5023 },
                            '名古屋': { lat: 35.1815, lng: 136.9066 },
                            '福岡': { lat: 33.5904, lng: 130.4017 },
                            '札幌': { lat: 43.0642, lng: 141.3469 },
                            '仙台': { lat: 38.2682, lng: 140.8694 },
                            '広島': { lat: 34.3853, lng: 132.4553 },
                            '神戸': { lat: 34.6901, lng: 135.1956 },
                            '横浜': { lat: 35.4437, lng: 139.6380 },
                            '京都': { lat: 35.0116, lng: 135.7681 }
                        };
                        
                        // 部分一致で検索
                        let foundCoords = null;
                        for (const [key, coords] of Object.entries(addressToCoords)) {
                            if (address.includes(key)) {
                                foundCoords = coords;
                                break;
                            }
                        }
                        
                        if (foundCoords) {
                            const newLocation = {
                                lat: foundCoords.lat,
                                lng: foundCoords.lng,
                                address: address
                            };
                            setSelectedLocation(newLocation);
                            setMapCenter(newLocation);
                            setManualAddress(address);
                        } else {
                            // デフォルトの東京の座標を使用
                            const defaultLocation = {
                                lat: 35.6762,
                                lng: 139.6503,
                                address: address
                            };
                            setSelectedLocation(defaultLocation);
                            setMapCenter(defaultLocation);
                            setManualAddress(address);
                        }
                    } catch (error) {
                        console.error('住所検索エラー:', error);
                        alert('住所の検索に失敗しました。デフォルトの位置を設定します。');
                        const defaultLocation = {
                            lat: 35.6762,
                            lng: 139.6503,
                            address: address
                        };
                        setSelectedLocation(defaultLocation);
                        setMapCenter(defaultLocation);
                    } finally {
                        setIsSearching(false);
                    }
                }, []);

                // 住所から座標を取得（簡易版）
                const getCoordsFromAddress = useCallback((address) => {
                    const addressToCoords = {
                        '北海道': { lat: 43.0642, lng: 141.3469 },
                        '青森県': { lat: 40.8244, lng: 140.7405 },
                        '岩手県': { lat: 39.7036, lng: 141.1525 },
                        '宮城県': { lat: 38.2682, lng: 140.8694 },
                        '秋田県': { lat: 39.7186, lng: 140.1024 },
                        '山形県': { lat: 38.2404, lng: 140.3636 },
                        '福島県': { lat: 37.7503, lng: 140.4675 },
                        '茨城県': { lat: 36.3418, lng: 140.4468 },
                        '栃木県': { lat: 36.5657, lng: 139.8836 },
                        '群馬県': { lat: 36.3912, lng: 139.0608 },
                        '埼玉県': { lat: 35.8574, lng: 139.6489 },
                        '千葉県': { lat: 35.6074, lng: 140.1065 },
                        '東京都': { lat: 35.6762, lng: 139.6503 },
                        '神奈川県': { lat: 35.4478, lng: 139.6425 },
                        '新潟県': { lat: 37.9024, lng: 139.0232 },
                        '富山県': { lat: 36.6953, lng: 137.2113 },
                        '石川県': { lat: 36.5947, lng: 136.6256 },
                        '福井県': { lat: 36.0652, lng: 136.2216 },
                        '山梨県': { lat: 35.6642, lng: 138.5684 },
                        '長野県': { lat: 36.6513, lng: 138.1812 },
                        '岐阜県': { lat: 35.3912, lng: 136.7223 },
                        '静岡県': { lat: 34.9769, lng: 138.3831 },
                        '愛知県': { lat: 35.1815, lng: 136.9066 },
                        '三重県': { lat: 34.7303, lng: 136.5086 },
                        '滋賀県': { lat: 35.0045, lng: 135.8686 },
                        '京都府': { lat: 35.0116, lng: 135.7681 },
                        '大阪府': { lat: 34.6937, lng: 135.5023 },
                        '兵庫県': { lat: 34.6913, lng: 135.1830 },
                        '奈良県': { lat: 34.6851, lng: 135.8329 },
                        '和歌山県': { lat: 34.2260, lng: 135.1675 },
                        '鳥取県': { lat: 35.5036, lng: 134.2383 },
                        '島根県': { lat: 35.4723, lng: 133.0505 },
                        '岡山県': { lat: 34.6618, lng: 133.9347 },
                        '広島県': { lat: 34.3853, lng: 132.4553 },
                        '山口県': { lat: 34.1861, lng: 131.4705 },
                        '徳島県': { lat: 34.0658, lng: 134.5593 },
                        '香川県': { lat: 34.3403, lng: 134.0433 },
                        '愛媛県': { lat: 33.8416, lng: 132.7654 },
                        '高知県': { lat: 33.5597, lng: 133.5311 },
                        '福岡県': { lat: 33.5904, lng: 130.4017 },
                        '佐賀県': { lat: 33.2494, lng: 130.2988 },
                        '長崎県': { lat: 32.7448, lng: 129.8737 },
                        '熊本県': { lat: 32.7898, lng: 130.7417 },
                        '大分県': { lat: 33.2382, lng: 131.6126 },
                        '宮崎県': { lat: 31.9077, lng: 131.4202 },
                        '鹿児島県': { lat: 31.5601, lng: 130.5581 },
                        '沖縄県': { lat: 26.2124, lng: 127.6792 }
                    };
                    
                    for (const [pref, coords] of Object.entries(addressToCoords)) {
                        if (address.includes(pref)) {
                            return coords;
                        }
                    }
                    
                    // デフォルトは東京
                    return { lat: 35.6762, lng: 139.6503 };
                }, []);

                // 郵便番号から住所を取得
                const getAddressFromPostalCode = useCallback(async (postalCode) => {
                    console.log('getAddressFromPostalCode関数が呼ばれました', { postalCode, length: postalCode?.length });
                    
                    if (!postalCode || postalCode.length !== 7) {
                        console.log('郵便番号が7桁ではありません', { postalCode, length: postalCode?.length });
                        alert('郵便番号は7桁で入力してください。');
                        return;
                    }
                    
                    setIsLoadingAddress(true);
                    
                    try {
                        // 郵便番号API（zipcloud）を使用
                        const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.status === 200 && data.results && data.results.length > 0) {
                            const result = data.results[0];
                            
                            setPrefecture(result.address1 || '');
                            setCity(result.address2 || '');
                            
                            // 住所から座標を取得（簡易版）
                            const fullAddress = `${result.address1}${result.address2}`;
                            const coords = getCoordsFromAddress(fullAddress);
                            
                            if (coords) {
                                const newLocation = {
                                    lat: coords.lat,
                                    lng: coords.lng,
                                    address: fullAddress
                                };
                                setSelectedLocation(newLocation);
                                setMapCenter(newLocation);
                                setManualAddress(fullAddress);
                                console.log('位置設定完了:', newLocation);
                            }
                        } else {
                            console.error('郵便番号が見つかりません:', data);
                            alert(`郵便番号が見つかりませんでした。\nエラー: ${data.message || '不明なエラー'}`);
                        }
                    } catch (error) {
                        console.error('郵便番号検索エラー:', error);
                        alert(`住所の取得に失敗しました。\nエラー: ${error.message}`);
                    } finally {
                        setIsLoadingAddress(false);
                    }
                }, [getCoordsFromAddress]);

                // 地図のクリック処理
                const handleMapClick = useCallback((lat, lng) => {
                    const newLocation = { lat, lng, address: `緯度: ${lat.toFixed(4)}, 経度: ${lng.toFixed(4)}` };
                    setSelectedLocation(newLocation);
                    
                    // 既存のマーカーを削除
                    if (markerInstance && mapInstance) {
                        mapInstance.removeLayer(markerInstance);
                    }
                    
                    // 新しいマーカーを追加
                    if (mapInstance) {
                        const marker = L.marker([lat, lng]).addTo(mapInstance);
                        marker.bindPopup(newLocation.address).openPopup();
                        setMarkerInstance(marker);
                        
                        // 地図の中心を新しい位置に移動
                        mapInstance.setView([lat, lng], mapInstance.getZoom());
                    }
                }, [markerInstance, mapInstance]);

                // 地図の初期化
                const initializeMap = useCallback(() => {
                    if (mapInstance) {
                        // 現在の地図の状態を保存
                        const currentCenter = mapInstance.getCenter();
                        const currentZoom = mapInstance.getZoom();
                        mapInstance.remove();
                        
                        // 保存された状態で地図を初期化
                        const map = L.map('map', {
                            zoomControl: true,
                            scrollWheelZoom: true,
                            doubleClickZoom: true,
                            boxZoom: true,
                            keyboard: true,
                            dragging: true
                        }).setView([currentCenter.lat, currentCenter.lng], currentZoom);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors'
                        }).addTo(map);
                        
                        // 地図クリックイベントを追加
                        map.on('click', (e) => {
                            const lat = e.latlng.lat;
                            const lng = e.latlng.lng;
                            handleMapClick(lat, lng);
                        });
                        
                        setMapInstance(map);
                        setIsMapLoaded(true);
                        return map;
                    } else {
                        // 初回はデフォルト位置で初期化
                        const map = L.map('map', {
                            zoomControl: true,
                            scrollWheelZoom: true,
                            doubleClickZoom: true,
                            boxZoom: true,
                            keyboard: true,
                            dragging: true
                        }).setView([mapCenter.lat, mapCenter.lng], 13);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors'
                        }).addTo(map);
                        
                        // 地図クリックイベントを追加
                        map.on('click', (e) => {
                            const lat = e.latlng.lat;
                            const lng = e.latlng.lng;
                            handleMapClick(lat, lng);
                        });
                        
                        setMapInstance(map);
                        setIsMapLoaded(true);
                        return map;
                    }
                }, [mapCenter, handleMapClick]);

                // マーカーの更新
                const updateMarker = useCallback((lat, lng, address) => {
                    if (mapInstance) {
                        // 既存のマーカーをクリア
                        if (markerInstance) {
                            mapInstance.removeLayer(markerInstance);
                        }
                        
                        // 新しいマーカーを追加
                        const marker = L.marker([lat, lng]).addTo(mapInstance);
                        marker.bindPopup(address || `緯度: ${lat.toFixed(4)}, 経度: ${lng.toFixed(4)}`).openPopup();
                        
                        setMarkerInstance(marker);
                        
                        // 地図の中心を移動
                        mapInstance.setView([lat, lng], 13);
                    }
                }, [mapInstance, markerInstance]);

                // 検索範囲の円を更新
                const updateRadiusCircle = useCallback((lat, lng, radius) => {
                    if (mapInstance) {
                        // 既存の円を確実に削除
                        if (radiusCircle) {
                            try {
                                mapInstance.removeLayer(radiusCircle);
                            } catch (error) {
                                // エラー時は無視
                            }
                        }
                        
                        // 地図上のすべての円レイヤーを削除（念のため）
                        mapInstance.eachLayer((layer) => {
                            if (layer instanceof L.Circle) {
                                mapInstance.removeLayer(layer);
                            }
                        });
                        
                        // 新しい円を追加
                        const circle = L.circle([lat, lng], {
                            radius: radius,
                            color: '#3B82F6',
                            fillColor: 'transparent',
                            fillOpacity: 0,
                            weight: 2
                        }).addTo(mapInstance);
                        
                        setRadiusCircle(circle);
                    }
                }, [mapInstance]);

                // 位置情報の取得
                useEffect(() => {
                    if (locationType === 'auto') {
                        // 自動位置取得
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(
                                (position) => {
                                    const lat = position.coords.latitude;
                                    const lng = position.coords.longitude;
                                    const newLocation = {
                                        lat: lat,
                                        lng: lng,
                                        address: `緯度: ${lat.toFixed(4)}, 経度: ${lng.toFixed(4)}`
                                    };
                                    setCurrentLocation(newLocation);
                                    setSelectedLocation(newLocation);
                                    setMapCenter(newLocation);
                                },
                                (error) => {
                                    console.error('位置情報の取得に失敗しました:', error);
                                    alert('位置情報の取得に失敗しました。手動で設定してください。');
                                    setLocationType('manual');
                                }
                            );
                        } else {
                            alert('このブラウザでは位置情報がサポートされていません。');
                            setLocationType('manual');
                        }
                    }
                    // 手動設定の場合はユーザーが明示的に位置を設定するまで待つ
                }, [locationType]);

                // 地図の初期化（コンポーネントマウント時）
                useEffect(() => {
                    const timer = setTimeout(() => {
                        initializeMap();
                    }, 100);
                    
                    return () => {
                        clearTimeout(timer);
                        if (mapInstance) {
                            mapInstance.remove();
                        }
                    };
                }, []); // 空の依存配列でマウント時のみ実行

                // 選択された位置が変更された時のマーカー更新
                useEffect(() => {
                    if (selectedLocation && selectedLocation.lat && selectedLocation.lng && mapInstance) {
                        // 既存のマーカーをクリア
                        if (markerInstance) {
                            mapInstance.removeLayer(markerInstance);
                        }
                        
                        // 新しいマーカーを追加
                        const marker = L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(mapInstance);
                        marker.bindPopup(selectedLocation.address || `緯度: ${selectedLocation.lat.toFixed(4)}, 経度: ${selectedLocation.lng.toFixed(4)}`).openPopup();
                        
                        setMarkerInstance(marker);
                        
                        // 地図の中心を移動
                        mapInstance.setView([selectedLocation.lat, selectedLocation.lng], 13);
                    }
                }, [selectedLocation, mapInstance, markerInstance]);

                // 位置情報が変更された時に検索フラグをリセット
                useEffect(() => {
                    searchExecutedRef.current = false;
                }, [selectedLocation]);

                // 検索範囲が変更された時に再検索
                useEffect(() => {
                    if (selectedLocation && selectedLocation.lat && selectedLocation.lng && !isSearchingSupermarkets) {
                        searchExecutedRef.current = false;
                        // 地図が利用可能な場合は検索範囲の円を表示
                        if (mapInstance) {
                        updateRadiusCircle(selectedLocation.lat, selectedLocation.lng, searchRadius);
                        }
                        // スーパー検索を実行
                        searchNearbyStores(false);
                    }
                }, [searchRadius]);

                // 位置情報が設定された時にスーパー検索と円表示を実行
                useEffect(() => {
                    if (selectedLocation && selectedLocation.lat && selectedLocation.lng && !isSearchingSupermarkets && !searchExecutedRef.current) {
                        searchExecutedRef.current = true;
                        // 地図が利用可能な場合は検索範囲の円を表示
                        if (mapInstance) {
                            updateRadiusCircle(selectedLocation.lat, selectedLocation.lng, searchRadius);
                        }
                        // スーパー検索を実行（地図がなくても実行）
                        searchNearbyStores(false);
                    }
                }, [selectedLocation, searchRadius, mapInstance]);

                // 設定完了
                const handleComplete = () => {
                    if (selectedLocation) {
                        onComplete(selectedLocation);
                    } else if (currentLocation) {
                        // 現在地が取得されている場合はそれを使用
                        onComplete(currentLocation);
                    } else if (manualAddress) {
                        // 手動で住所が入力されている場合はそれを使用
                        const manualLocation = {
                            lat: null,
                            lng: null,
                            address: manualAddress
                        };
                        onComplete(manualLocation);
                    } else {
                        // デフォルトの位置を設定
                        const defaultLocation = {
                            lat: 35.6762,
                            lng: 139.6503,
                            address: 'デフォルト位置'
                        };
                        onComplete(defaultLocation);
                    }
                };

                return h('div', { className: 'min-h-screen bg-gradient-to-br from-green-50 to-blue-100 p-4' },
                    h('div', { className: 'max-w-4xl mx-auto' },
                        // ヘッダー
                        h('div', { className: 'text-center mb-8' },
                            h('h1', { className: 'text-3xl font-bold text-gray-900 mb-2' }, '位置情報設定'),
                            h('p', { className: 'text-gray-600' }, `${user?.username}さん、お住まいの地域を設定してください`)
                        ),

                        // 設定方法選択
                        h('div', { className: 'bg-white rounded-2xl shadow-xl p-6 mb-6' },
                            h('h2', { className: 'text-xl font-semibold text-gray-900 mb-4' }, '設定方法を選択'),
                            h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                                h('button', {
                                    onClick: () => setLocationType('auto'),
                                    className: `p-4 rounded-lg border-2 transition-colors ${
                                        locationType === 'auto' 
                                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                                            : 'border-gray-200 hover:border-gray-300'
                                    }`
                                },
                                    h('div', { className: 'text-center' },
                                        h('div', { className: 'text-2xl mb-2' }, '📍'),
                                        h('h3', { className: 'font-semibold mb-1' }, '自動取得'),
                                        h('p', { className: 'text-sm text-gray-600' }, 'GPSで現在地を自動取得')
                                    )
                                ),
                                h('button', {
                                    onClick: () => setLocationType('manual'),
                                    className: `p-4 rounded-lg border-2 transition-colors ${
                                        locationType === 'manual' 
                                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                                            : 'border-gray-200 hover:border-gray-300'
                                    }`
                                },
                                    h('div', { className: 'text-center' },
                                        h('div', { className: 'text-2xl mb-2' }, '✏️'),
                                        h('h3', { className: 'font-semibold mb-1' }, '手動設定'),
                                        h('p', { className: 'text-sm text-gray-600' }, '住所を入力して設定')
                                    )
                                )
                            )
                        ),

                        // 位置情報表示・設定
                        h('div', { className: 'bg-white rounded-2xl shadow-xl p-6 mb-6' },
                            h('h2', { className: 'text-xl font-semibold text-gray-900 mb-4' }, '位置情報'),
                            
                            locationType === 'auto' ? h('div', { className: 'space-y-4' },
                                currentLocation ? h('div', { className: 'p-4 bg-green-50 rounded-lg' },
                                    h('div', { className: 'flex items-center space-x-2 mb-2' },
                                        h('div', { className: 'w-3 h-3 bg-green-500 rounded-full animate-pulse' }),
                                        h('span', { className: 'font-medium text-green-800' }, '現在地を取得しました')
                                    ),
                                    h('p', { className: 'text-sm text-green-700' }, currentLocation.address)
                                ) : h('div', { className: 'text-center py-8' },
                                    h('div', { className: 'animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4' }),
                                    h('p', { className: 'text-gray-600' }, '位置情報を取得中...')
                                )
                            ) : h('div', { className: 'space-y-4' },
                                // 郵便番号入力
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '郵便番号'),
                                    h('div', { className: 'flex space-x-2' },
                                        h('input', {
                                            type: 'text',
                                            placeholder: '1234567',
                                            value: postalCode,
                                            onChange: (e) => {
                                                const value = e.target.value.replace(/[^0-9]/g, '');
                                                if (value.length <= 7) {
                                                    setPostalCode(value);
                                                    if (value.length === 7) {
                                                        getAddressFromPostalCode(value);
                                                    }
                                                }
                                            },
                                            className: 'flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                        }),
                                        h('button', {
                                            onClick: () => {
                                                getAddressFromPostalCode(postalCode);
                                            },
                                            disabled: postalCode.length !== 7 || isLoadingAddress,
                                            className: `px-4 py-3 rounded-lg transition-colors ${
                                                postalCode.length !== 7 || isLoadingAddress
                                                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                    : 'bg-blue-600 text-white hover:bg-blue-700'
                                            }`
                                        }, isLoadingAddress ? '検索中...' : `住所検索 (${postalCode.length}/7)`)
                                    ),
                                    h('p', { className: 'text-xs text-gray-500 mt-1' }, 'ハイフンなしで7桁入力してください')
                                ),
                                
                                // 都道府県
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '都道府県'),
                                    h('select', {
                                        value: prefecture,
                                        onChange: (e) => setPrefecture(e.target.value),
                                        className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                    },
                                        h('option', { value: '' }, '都道府県を選択してください'),
                                        h('option', { value: '北海道' }, '北海道'),
                                        h('option', { value: '青森県' }, '青森県'),
                                        h('option', { value: '岩手県' }, '岩手県'),
                                        h('option', { value: '宮城県' }, '宮城県'),
                                        h('option', { value: '秋田県' }, '秋田県'),
                                        h('option', { value: '山形県' }, '山形県'),
                                        h('option', { value: '福島県' }, '福島県'),
                                        h('option', { value: '茨城県' }, '茨城県'),
                                        h('option', { value: '栃木県' }, '栃木県'),
                                        h('option', { value: '群馬県' }, '群馬県'),
                                        h('option', { value: '埼玉県' }, '埼玉県'),
                                        h('option', { value: '千葉県' }, '千葉県'),
                                        h('option', { value: '東京都' }, '東京都'),
                                        h('option', { value: '神奈川県' }, '神奈川県'),
                                        h('option', { value: '新潟県' }, '新潟県'),
                                        h('option', { value: '富山県' }, '富山県'),
                                        h('option', { value: '石川県' }, '石川県'),
                                        h('option', { value: '福井県' }, '福井県'),
                                        h('option', { value: '山梨県' }, '山梨県'),
                                        h('option', { value: '長野県' }, '長野県'),
                                        h('option', { value: '岐阜県' }, '岐阜県'),
                                        h('option', { value: '静岡県' }, '静岡県'),
                                        h('option', { value: '愛知県' }, '愛知県'),
                                        h('option', { value: '三重県' }, '三重県'),
                                        h('option', { value: '滋賀県' }, '滋賀県'),
                                        h('option', { value: '京都府' }, '京都府'),
                                        h('option', { value: '大阪府' }, '大阪府'),
                                        h('option', { value: '兵庫県' }, '兵庫県'),
                                        h('option', { value: '奈良県' }, '奈良県'),
                                        h('option', { value: '和歌山県' }, '和歌山県'),
                                        h('option', { value: '鳥取県' }, '鳥取県'),
                                        h('option', { value: '島根県' }, '島根県'),
                                        h('option', { value: '岡山県' }, '岡山県'),
                                        h('option', { value: '広島県' }, '広島県'),
                                        h('option', { value: '山口県' }, '山口県'),
                                        h('option', { value: '徳島県' }, '徳島県'),
                                        h('option', { value: '香川県' }, '香川県'),
                                        h('option', { value: '愛媛県' }, '愛媛県'),
                                        h('option', { value: '高知県' }, '高知県'),
                                        h('option', { value: '福岡県' }, '福岡県'),
                                        h('option', { value: '佐賀県' }, '佐賀県'),
                                        h('option', { value: '長崎県' }, '長崎県'),
                                        h('option', { value: '熊本県' }, '熊本県'),
                                        h('option', { value: '大分県' }, '大分県'),
                                        h('option', { value: '宮崎県' }, '宮崎県'),
                                        h('option', { value: '鹿児島県' }, '鹿児島県'),
                                        h('option', { value: '沖縄県' }, '沖縄県')
                                    )
                                ),
                                
                                // 市区町村
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '市区町村'),
                                    h('input', {
                                        type: 'text',
                                        placeholder: '市区町村',
                                        value: city,
                                        onChange: (e) => setCity(e.target.value),
                                        className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                    })
                                ),
                                
                                // マンション名（任意）
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'マンション名（任意）'),
                                    h('input', {
                                        type: 'text',
                                        placeholder: 'マンション名・部屋番号など',
                                        value: building,
                                        onChange: (e) => setBuilding(e.target.value),
                                        className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                    })
                                ),
                                
                                // 位置設定ボタン
                                h('button', {
                                    onClick: () => {
                                        const fullAddress = `${prefecture}${city}${building}`.trim();
                                        if (fullAddress) {
                                            const coords = getCoordsFromAddress(fullAddress);
                                            const newLocation = {
                                                lat: coords.lat,
                                                lng: coords.lng,
                                                address: fullAddress
                                            };
                                            setSelectedLocation(newLocation);
                                            setMapCenter(newLocation);
                                            setManualAddress(fullAddress);
                                        }
                                    },
                                    disabled: !prefecture.trim() || !city.trim(),
                                    className: `w-full py-3 px-4 rounded-lg transition-colors ${
                                        !prefecture.trim() || !city.trim()
                                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            : 'bg-blue-600 text-white hover:bg-blue-700'
                                    }`
                                }, '位置を設定'),
                                
                                // 設定完了表示
                                selectedLocation && h('div', { className: 'p-4 bg-green-50 rounded-lg' },
                                    h('div', { className: 'flex items-center space-x-2 mb-2' },
                                        h('div', { className: 'w-3 h-3 bg-green-500 rounded-full' }),
                                        h('span', { className: 'font-medium text-green-800' }, '位置を設定しました')
                                    ),
                                    h('p', { className: 'text-sm text-green-700' }, selectedLocation.address)
                                )
                            )
                        ),

                        // 地図表示
                        h('div', { className: 'bg-white rounded-2xl shadow-xl p-6 mb-6' },
                            h('h2', { className: 'text-xl font-semibold text-gray-900 mb-4' }, '地図'),
                            h('div', { className: 'relative' },
                                h('div', { 
                                    id: 'map',
                                    className: 'w-full h-64 rounded-lg relative overflow-hidden',
                                    style: { minHeight: '256px' }
                                }),
                                // 地図の説明
                                h('div', { className: 'mt-2 text-center text-gray-600 text-sm' },
                                    h('p', null, '地図をクリックして位置を選択'),
                                    selectedLocation && h('p', { className: 'text-xs text-blue-600 mt-1' }, 
                                        `選択: ${selectedLocation.lat?.toFixed(4) || 'N/A'}, ${selectedLocation.lng?.toFixed(4) || 'N/A'}`
                                    )
                                )
                            )
                        ),

                        // 検索範囲設定
                        h('div', { className: 'bg-white rounded-2xl shadow-xl p-6 mb-6' },
                            h('h2', { className: 'text-xl font-semibold text-gray-900 mb-4' }, '検索範囲'),
                            h('div', { className: 'space-y-4' },
                                h('div', { className: 'flex items-center space-x-4' },
                                    h('label', { className: 'text-sm font-medium text-gray-700' }, '検索範囲:'),
                                    h('input', {
                                        id: 'searchRadius',
                                        type: 'range',
                                        min: '1000',
                                        max: '10000',
                                        step: '1000',
                                        value: searchRadius,
                                        onChange: (e) => {
                                            const newRadius = Number(e.target.value);
                                            setSearchRadius(newRadius);
                                            // 検索範囲が広がった場合は追加検索を実行
                                            if (newRadius > searchRadius) {
                                                // 非同期で検索を実行
                                                setTimeout(() => {
                                                    searchNearbyStores(true);
                                                }, 100);
                                            }
                                        },
                                        className: 'flex-1'
                                    }),
                                    h('span', { className: 'text-sm font-medium text-gray-700 w-20' }, `${searchRadius / 1000}km`)
                                ),
                                h('div', { className: 'grid grid-cols-5 gap-2 text-sm' },
                                    h('div', { className: 'text-center p-2 bg-gray-50 rounded' }, '1km'),
                                    h('div', { className: 'text-center p-2 bg-gray-50 rounded' }, '3km'),
                                    h('div', { className: 'text-center p-2 bg-gray-50 rounded' }, '5km'),
                                    h('div', { className: 'text-center p-2 bg-gray-50 rounded' }, '7km'),
                                    h('div', { className: 'text-center p-2 bg-gray-50 rounded' }, '10km')
                                )
                            )
                        ),

                        // 完了ボタン
                        // スーパー検索結果
                        selectedLocation && h('div', { className: 'bg-white rounded-2xl shadow-xl p-6 mb-6' },
                            h('div', { className: 'flex items-center justify-between mb-4' },
                                h('h2', { className: 'text-xl font-semibold text-gray-900' }, '近くのスーパー'),
                                h('div', { className: 'text-sm text-gray-600' },
                                    `${nearbySupermarkets.length}件見つかりました`
                                )
                            ),
                            
                            // 検索中表示
                            isSearchingSupermarkets && h('div', { className: 'text-center py-8' },
                                h('div', { className: 'inline-flex items-center space-x-2' },
                                    h('div', { className: 'animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600' }),
                                    h('span', { className: 'text-gray-600' }, 'スーパーを検索中...')
                                )
                            ),
                            
                            // スーパー一覧
                            !isSearchingSupermarkets && nearbySupermarkets.length > 0 && h('div', { className: 'space-y-3' },
                                h('p', { className: 'text-sm text-gray-600 mb-4' }, 
                                    'よく行くスーパーを選択してください（複数選択可能）'
                                ),
                                nearbySupermarkets.map(supermarket => {
                                    const isSelected = selectedSupermarkets.some(s => s.id === supermarket.id);
                                    return h('div', {
                                        key: supermarket.id,
                                        onClick: () => toggleSupermarketSelection(supermarket),
                                        className: `p-4 rounded-lg border-2 cursor-pointer transition-colors ${
                                            isSelected 
                                                ? 'border-blue-500 bg-blue-50' 
                                                : 'border-gray-200 hover:border-gray-300'
                                        }`
                                    },
                                        h('div', { className: 'flex items-start justify-between' },
                                            h('div', { className: 'flex-1' },
                                                h('div', { className: 'flex items-center space-x-2 mb-1' },
                                                    h('h3', { className: 'font-medium text-gray-900' }, supermarket.name),
                                                    supermarket.isReal && h('span', { 
                                                        className: 'px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium' 
                                                    }, '実際の店舗'),
                                                    supermarket.isOpen && h('span', { 
                                                        className: 'px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full' 
                                                    }, '営業中'),
                                                    h('span', { 
                                                        className: 'px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full' 
                                                    }, `★${supermarket.rating}`)
                                                ),
                                                h('p', { className: 'text-sm text-gray-600 mb-1' }, supermarket.address),
                                                h('div', { className: 'flex items-center space-x-4 text-xs text-gray-500' },
                                                    h('span', null, `📍 ${supermarket.distance < 1000 ? `${supermarket.distance}m` : `${(supermarket.distance / 1000).toFixed(1)}km`}`)
                                                )
                                            ),
                                            h('div', { className: 'ml-4' },
                                                h('div', { 
                                                    className: `w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                                                        isSelected 
                                                            ? 'border-blue-500 bg-blue-500' 
                                                            : 'border-gray-300'
                                                    }`
                                                },
                                                    isSelected && h('div', { 
                                                        className: 'w-2 h-2 bg-white rounded-full' 
                                                    })
                                                )
                                            )
                                        )
                                    );
                                })
                            ),
                            
                            // スーパーが見つからない場合
                            !isSearchingSupermarkets && nearbySupermarkets.length === 0 && selectedLocation && h('div', { className: 'text-center py-8' },
                                h('div', { className: 'bg-yellow-50 border border-yellow-200 rounded-lg p-6' },
                                    h('div', { className: 'text-yellow-600 mb-4' },
                                        h('svg', { className: 'w-12 h-12 mx-auto mb-3', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 19.5c-.77.833.192 2.5 1.732 2.5z' })
                                        )
                                    ),
                                    h('h3', { className: 'text-lg font-semibold text-gray-800 mb-2' }, '指定した範囲内にスーパーが見つかりませんでした'),
                                    h('div', { className: 'text-gray-600 text-sm space-y-2' },
                                        h('p', null, '以下の方法をお試しください：'),
                                        h('ul', { className: 'text-left space-y-1 mt-3' },
                                            h('li', { className: 'flex items-center' },
                                                h('span', { className: 'text-yellow-500 mr-2' }, '•'),
                                                '検索範囲を広げる（スライダーを右に動かす）'
                                            ),
                                            h('li', { className: 'flex items-center' },
                                                h('span', { className: 'text-yellow-500 mr-2' }, '•'),
                                                '別の場所を選択する'
                                            ),
                                            h('li', { className: 'flex items-center' },
                                                h('span', { className: 'text-yellow-500 mr-2' }, '•'),
                                                '現在地の取得を許可する'
                                            )
                                        )
                                    ),
                                    h('div', { className: 'mt-4' },
                                        h('button', { 
                                            className: 'bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition-colors',
                                            onClick: () => {
                                                // 検索範囲を1000mに設定
                                                const rangeSlider = document.getElementById('searchRadius');
                                                if (rangeSlider) {
                                                    rangeSlider.value = 1000;
                                                    setSearchRadius(1000);
                                                    // 非同期で追加検索を実行
                                                    setTimeout(() => {
                                                        searchNearbyStores(true);
                                                    }, 100);
                                                }
                                            }
                                        }, '検索範囲を1000mに拡大')
                                    )
                                )
                            ),
                            
                            // 選択されたスーパーを保存
                            selectedSupermarkets.length > 0 && h('div', { className: 'mt-6 pt-4 border-t border-gray-200' },
                                h('div', { className: 'flex items-center justify-between mb-4' },
                                    h('div', null,
                                        h('p', { className: 'font-medium text-gray-900' }, '選択されたスーパー'),
                                        h('p', { className: 'text-sm text-gray-600' }, 
                                            `${selectedSupermarkets.length}件選択中`
                                        )
                                    ),
                                    h('button', {
                                        onClick: saveFavoriteSupermarkets,
                                        className: 'bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors'
                                    }, 'よく行く店舗に登録')
                                ),
                                h('div', { className: 'space-y-2' },
                                    selectedSupermarkets.map(supermarket => 
                                        h('div', { 
                                            key: supermarket.id,
                                            className: 'flex items-center justify-between p-2 bg-green-50 rounded-lg'
                                        },
                                            h('span', { className: 'text-sm font-medium text-green-800' }, supermarket.name),
                                            h('button', {
                                                onClick: () => toggleSupermarketSelection(supermarket),
                                                className: 'text-green-600 hover:text-green-800'
                                            }, '×')
                                        )
                                    )
                                )
                            )
                        ),

                        h('div', { className: 'text-center' },
                            h('button', {
                                onClick: handleComplete,
                                className: 'px-8 py-4 rounded-lg font-medium text-lg transition-colors bg-green-600 text-white hover:bg-green-700'
                            }, '設定完了')
                        )
                    )
                );
            };

            const renderPage = () => {
                if (currentPage === 'login') {
                    return h(LoginPage, {
                        onLogin: handleLogin,
                        onGuestLogin: handleGuestLogin
                    });
                }
                
                
                switch (currentPage) {
                    case 'home': return h(HomePage, { onPageChange: setCurrentPage, user, location });
                    case 'receipt': return h(ReceiptPage);
                    case 'receipt-scan': return h(ReceiptScanPage, { onComplete: () => setCurrentPage('home') });
                    case 'accounting': return h(AccountingPage);
                    case 'menu': return h(MenuPage);
                    case 'store': return h(StorePage);
                    case 'history': return h(HistoryPage);
                    case 'compare': return h(ComparePage);
                    case 'language': return h(LanguagePage);
                    case 'settings': return h(SettingsPage, { onPageChange: setCurrentPage });
                    case 'location-setup': return h(LocationSetupPage, { onComplete: handleLocationSetupComplete, user });
                    default: return h(HomePage, { onPageChange: setCurrentPage, user, location });
                }
            };

            return h('div', { className: 'min-h-screen bg-gray-50 pb-20' },
                // 食費予算設定画面表示
                showBudgetSetup && h(BudgetSetupPage, { onComplete: handleBudgetSetupComplete, user }),
                
                // チュートリアル表示
                showTutorial && h(TutorialPage, { onComplete: handleTutorialComplete }),
                
                // メインアプリ（予算設定・チュートリアル非表示時のみ）
                !showBudgetSetup && !showTutorial && h('div', {},
                isLoggedIn && h(Header, { 
                    onMenuClick: () => setIsMobileMenuOpen(true),
                    user,
                    onLogout: handleLogout
                }),
                h('main', { className: 'pb-20 pt-16' }, renderPage()),
                h(MobileMenu, { 
                    isOpen: isMobileMenuOpen, 
                    onClose: () => setIsMobileMenuOpen(false),
                    onPageChange: setCurrentPage
                })
                ),
                
                // ナビゲーションバー（常に表示）
                h(BottomNavigation, { 
                    currentPage, 
                    onPageChange: setCurrentPage,
                    onReceiptScan: () => setCurrentPage('receipt-scan')
                })
            );
        };


        // アプリをレンダリング
        window.appRoot = null;
        
        function initializeApp() {
            try {
                console.log('アプリの初期化を開始...');
                
                // React 18のcreateRootを使用（一度だけ作成）
                if (!window.appRoot) {
                    console.log('createRootを作成中...');
                    window.appRoot = createRoot(document.getElementById('root'));
                }
                
                console.log('Appコンポーネントをレンダリング中...');
                window.appRoot.render(h(App));
                console.log('アプリの初期化が完了しました');
            } catch (error) {
                console.error('React rendering error:', error);
                console.error('Error stack:', error.stack);
                const errorMessage = error && error.message ? error.message : '不明なエラーが発生しました';
                document.getElementById('root').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: red;">
                        <h2>アプリの初期化に失敗しました</h2>
                        <p>エラー: ${errorMessage}</p>
                        <p>詳細: ${error.stack || 'スタックトレースが利用できません'}</p>
                        <p>ページを再読み込みしてください。</p>
                    </div>
                `;
            }
        }
        
        // DOMが読み込まれた後にアプリを初期化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>